---
title: "R Notebook - Immune cells intra- vs extra-tumour"
output: html_notebook
---


```{r Load libraries, echo=F, message=F, warning=F}
library(ggpubr)
library(dplyr)
library(pals)
#library(tidyverse)
library(RColorBrewer)
library(qwraps2)
library(imcRtools)
library(table1)
library(SingleCellExperiment)
#library(uwot)
library(tidyr)
library(scater)
library(ggridges)
library(ggsci)
library(viridis)
library(viridisLite)
library(ggplot2)
library(data.table)
library(CATALYST)
library(gridExtra)
library(Rphenograph)
library(ComplexHeatmap)
library(CATALYST)
library(scales)
library(survival)
library(broom)
library(pheatmap)
library(FlowSOM)
library(Seurat)
library(Rphenoannoy)
library(dplyr)
library(data.table)
library(ggthemes)
library(diffcyt)
library(edgeR)
library(rstatix)
library(dendextend)

library(ggdendro)
library(dendextend)
library(FactoMineR)
library(factoextra)
library(survminer)
library(corrplot)
library(rstatix)
library(graphics)
library(cowplot)
library(cluster)
library(glmnet)
library(fastDummies)

library(igraph)
library(SingleCellExperiment)
library(S4Vectors)
library(stringr)
library(DT)
library(dplyr)
library(tidyr)
library(mclust)
library(ggplot2)
library(RColorBrewer)
library(scater)
library(Rphenoannoy)
library(factoextra)
library(cluster)
library(dendextend)
library(ggthemes)
set.seed(101100)
library(spicyR)
```

```{r}
#set working directory 
wd <-dirname(getwd())

#clinical.data
#data_folder <-(file.path(wd,"sce_objects","final objects with categories","FINAL"))
#all.sce <- readRDS("/mnt/lena_processed2/NSCLC_NEW/sce_objects/final objects with categories/FINAL/FINAL_All_Clustered_FILTERED_inc_tumour_vessel_immune_CAF_minusOther.rds")
#all.sce$DX.name[is.na(all.sce$DX.name)]<-"NA"

#all.sce$tcell_subtype <-all.sce$cell_subtype
#all.sce$tcell_subtype[all.sce$cell_category=="Fibroblast"] <- all.sce[, all.sce$cell_category=="Fibroblast"]$cell_type
#unique(all.sce$tcell_subtype)
"FINAL_All_Clustered_FILTERED_inc_tumour_vessel_immune_CAF_minusOther.rds"

#all clustered minus 5-10% of lowest images
data_folder <-file.path(wd,"sce_objects","merge_plus_tumour")

all.sce_pat.roi <-readRDS(file=file.path(data_folder, paste("ALL_minus-Tumour_sce_pat_roi_rem.rds",sep="")))
all.sce_pat <-readRDS(file=file.path(data_folder, paste("ALL_plus-Tumour_sce_pat_rem.rds",sep="")))

all.sce_pat.roi$DX.name[is.na(all.sce_pat.roi$DX.name)]<-"NA"
all.sce_pat$DX.name[is.na(all.sce_pat$DX.name)]<-"NA"

#merged by category pat_roi_rem
all.pat.roi<-readRDS(file=file.path(wd, "sce_objects", "merge_by_category", "all_merge_Tumour_Immune_Tcell_CAF_Vessel_pat-roi-rem.rds"))

all.pat.roi$DX.name[is.na(all.pat.roi$DX.name)]<-"NA"


#DISTANCES
data_folder <- file.path(wd, "sce_objects","Distances")
plot_folder <- file.path(wd, "plots")
all.sce_pat.roi <-readRDS(file=file.path(data_folder,"all_minus_other_distances.rds"))

```


```{r}
#clinical.data <-as.data.frame(colData(immune.sce))

clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]
clinical.data$X <-NULL
clinical.data$X.1 <-NULL
head(clinical.data)
```

```{r, fig.width=18, fig.height=18}
#SMA
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
df <-left_join(df, df_strat, by="Patient_ID")
df$mCAF_G[is.na(df$mCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-150)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-150 to -120"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-120 to -90"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-90 to -60"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-60 to -30"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-30 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 30"
df$Compartment[df$Distance > 30] <-">30"

df$Compartment <- factor(df$Compartment, levels = c("(-150)","-150 to -120","-120 to -90","-90 to -60", "-60 to -30", "-30 to -0","0 to 30", ">30"))

df <- df%>%subset(is.na(SMA_CAF_G)!=T& Celltype!="SMA_CAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~SMA_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
        ggplot(aes(x= SMA_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_smaCAFden.pdf"), width=12, height=12)
  
#iCAF
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
df <-left_join(df, df_strat, by="Patient_ID")
df$mCAF_G[is.na(df$mCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$iCAF_CAF_G[is.na(df$iCAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-150)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-150 to -120"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-120 to -90"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-90 to -60"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-60 to -30"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-30 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 30"
df$Compartment[df$Distance > 30] <-">30"

df$Compartment <- factor(df$Compartment, levels = c("(-150)","-150 to -120","-120 to -90","-90 to -60", "-60 to -30", "-30 to -0","0 to 30", ">30"))

df <- df%>%subset(is.na(iCAF_G)!=T& Celltype!="iCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(iCAF_G=="iCAF high"|iCAF_G=="iCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~iCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(iCAF_G=="iCAF high"|iCAF_G=="iCAF low")%>%
        ggplot(aes(x= iCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_iCAFden.pdf"), width=12, height=12)

#vCAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(vCAF_G=="vCAF high"|vCAF_G=="vCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~vCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(vCAF_G=="vCAF high"|vCAF_G=="vCAF low")%>%
        ggplot(aes(x= vCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_vCAFden.pdf"), width=12, height=12)

#mCAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~mCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
        ggplot(aes(x= mCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_mCAFden.pdf"), width=12, height=12)

#dCAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(dCAF_G=="dCAF high"|dCAF_G=="dCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~dCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(dCAF_G=="dCAF high"|dCAF_G=="dCAF low")%>%
        ggplot(aes(x= dCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_dCAFden.pdf"), width=12, height=12)

#tpCAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(tpCAF_G=="tpCAF high"|tpCAF_G=="tpCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~tpCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(tpCAF_G=="tpCAF high"|tpCAF_G=="tpCAF low")%>%
        ggplot(aes(x= tpCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_tpCAFden.pdf"), width=12, height=12)

#IDO CAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(IDO_CAF_G=="IDO_CAF high"|IDO_CAF_G=="IDO_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~IDO_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(IDO_CAF_G=="IDO_CAF high"|IDO_CAF_G=="IDO_CAF low")%>%
        ggplot(aes(x= IDO_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_IDO_CAFden.pdf"), width=12, height=12)

#hypoxic_tpCAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(hypoxic_tpCAF_G=="hypoxic_tpCAF high"|hypoxic_tpCAF_G=="hypoxic_tpCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~hypoxic_tpCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(hypoxic_tpCAF_G=="hypoxic_tpCAF high"|hypoxic_tpCAF_G=="hypoxic_tpCAF low")%>%
        ggplot(aes(x= hypoxic_tpCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_hypoxic_tpCAFden.pdf"), width=12, height=12)

#hypoxic_CAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(hypoxic_CAF_G=="hypoxic_CAF high"|hypoxic_CAF_G=="hypoxic_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~hypoxic_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(hypoxic_CAF_G=="hypoxic_CAF high"|hypoxic_CAF_G=="hypoxic_CAF low")%>%
        ggplot(aes(x= hypoxic_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_hypoxic_CAFden.pdf"), width=12, height=12)

#PDPN_CAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(PDPN_CAF_G=="PDPN_CAF high"|PDPN_CAF_G=="PDPN_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~PDPN_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(PDPN_CAF_G=="PDPN_CAF high"|PDPN_CAF_G=="PDPN_CAF low")%>%
        ggplot(aes(x= PDPN_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_PDPN_CAFden.pdf"), width=12, height=12)

#Collagen_CAF
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(Collagen_CAF_G=="Collagen_CAF high"|Collagen_CAF_G=="Collagen_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~Collagen_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(Collagen_CAF_G=="Collagen_CAF high"|Collagen_CAF_G=="Collagen_CAF low")%>%
        ggplot(aes(x= Collagen_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_Collagen_CAFden.pdf"), width=12, height=12)

```

```{r, fig.width=18, fig.height=18}
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
df <-left_join(df, df_strat, by="Patient_ID")
df$mCAF_G[is.na(df$mCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-150)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-150 to -120"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-120 to -90"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-90 to -60"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-60 to -30"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-30 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 30"
df$Compartment[df$Distance > 30] <-">30"

df$Compartment <- factor(df$Compartment, levels = c("(-150)","-150 to -120","-120 to -90","-90 to -60", "-60 to -30", "-30 to -0","0 to 30", ">30"))

df <- df%>%subset(is.na(SMA_CAF_G)!=T& Celltype!="SMA_CAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
test <- test %>% subset(Celltype=="CD4"|Celltype=="CD8"|Celltype=="Bcell"|Celltype=="Neutrophil"|Celltype=="Myeloid")  
pvalues <- test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~SMA_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
    p <-  test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
        ggplot(aes(x= SMA_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
    plot(p)        
ggsave(plot=p, file= file.path(plot_folder, "Boxplot_DistanceBins_CD4_CD8_Neutrophil_Myeloid_Bcell_smaCAFden.pdf"), width=12, height=12)
      

#Immune types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$mCAF_G[is.na(df$mCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(mCAF_G)!=T& Celltype!="mCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~mCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
        ggplot(aes(x= mCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
            
  #tpCAF
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(tpCAF_G)!=T& Celltype!="tpCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(tpCAF_G=="tpCAF high"|tpCAF_G=="tpCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~tpCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(tpCAF_G=="tpCAF high"|tpCAF_G=="tpCAF low")%>%
        ggplot(aes(x= tpCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
            

      

#Immune types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(tpCAF_G)!=T& Celltype!="tpCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(tpCAF_G=="tpCAF high"|tpCAF_G=="tpCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~tpCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(tpCAF_G=="tpCAF high"|tpCAF_G=="tpCAF low")%>%
        ggplot(aes(x= tpCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
            
   #iCAF
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$iCAF_G[is.na(df$iCAF_G)==T] <-"NA"
df$iCAF_G[is.na(df$iCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(iCAF_G)!=T& Celltype!="iCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(iCAF_G=="iCAF high"|iCAF_G=="iCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~iCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(iCAF_G=="iCAF high"|iCAF_G=="iCAF low")%>%
        ggplot(aes(x= iCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
            

      

#Immune types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$iCAF_G[is.na(df$iCAF_G)==T] <-"NA"
df$iCAF_G[is.na(df$iCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(iCAF_G)!=T& Celltype!="iCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(iCAF_G=="iCAF high"|iCAF_G=="iCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~iCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(iCAF_G=="iCAF high"|iCAF_G=="iCAF low")%>%
        ggplot(aes(x= iCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
  
      
       #SMA_CAF
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(SMA_CAF_G)!=T& Celltype!="SMA_CAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")

pvalues <- test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~SMA_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
        ggplot(aes(x= SMA_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
            

      

#Immune types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(SMA_CAF_G)!=T& Celltype!="SMA_CAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~SMA_CAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(SMA_CAF_G=="SMA_CAF high"|SMA_CAF_G=="SMA_CAF low")%>%
        ggplot(aes(x= SMA_CAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
  
      
```


patients with immune cells intratumoural
```{r fig.width=20, fig.height=20}
#all.sce_pat.roi <- all.cells
df <- data.frame(all.sce_pat.roi$CellID,
                 all.sce_pat.roi$Compartment,
                 all.sce_pat.roi$cell_category,
                 all.sce_pat.roi$DX.name,
                 all.sce_pat.roi$RoiID)

all.sce_pat.roi$immune_category <- all.sce_pat.roi$cell_category
all.sce_pat.roi$immune_category[all.sce_pat.roi$immune_category=="T cell"] <-"Immune"
all.sce_pat.roi$immune_category <- factor(all.sce_pat.roi$immune_category, levels = c("Fibroblast", "Immune", "Other","Tumour","vessel"))


#Cell categories tumuor, immune, fibro, vessel, other
df <- data.frame(all.sce_pat.roi$CellID,
                 all.sce_pat.roi$Compartment,
                 all.sce_pat.roi$immune_category,
                 all.sce_pat.roi$DX.name,
                 all.sce_pat.roi$RoiID)

colnames(df) <- c("CellID","Distance","Celltype","Type","ROI")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df %>% subset(Celltype=="Tumour") %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))

roi_rem <-df[df$Distance >300,]$ROI %>%unique()

df <-df[!df$ROI %in% roi_rem,]
#+  scale_x_continuous(trans = "log10")


p <-df%>%#subset(Celltype!="Other") %>%
  ggplot(aes(x=Distance, color=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  scale_colour_tableau()+
 geom_vline(xintercept = 0,color = 'black', linetype="dashed")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "Distance_cell_categories.pdf"), width=8, height=4)


#Fibro figure
#Cell categories tumuor, immune, fibro, vessel, other
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$RoiID)

colnames(df) <- c("CellID","Distance","Celltype","Type","ROI")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df %>% subset(Celltype=="Tumour") %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))

roi_rem <-df[df$Distance >300,]$ROI %>%unique()

df <-df[!df$ROI %in% roi_rem,]
#+  scale_x_continuous(trans = "log10")

category20 <- c("#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7FFF","#BCBD22","#17BECF","#AEC7E8")
p <-df%>%#subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="tpCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF")%>%
  ggplot(aes(x=Distance, color=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  scale_colour_tableau()+
  scale_colour_manual(values=as.vector(category20)[1:11])+
 geom_vline(xintercept = 0,color = 'black', linetype="dashed")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "Distance_CAF_tumourstromaborder.pdf"), width=8, height=4)
  #facet_wrap(~Type)
  #scale_x_log10()
unique(df$all.sce_pat.roi.DX.name)
summary(df$Distance)


#Fibroblast Types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$cell_type,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$Grade,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$Patient_ID )

colnames(df) <- c("CellID","Distance","Celltype","Type","Grade","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

df <-left_join(df, df_strat, by="Patient_ID")

df%>%
  subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="mCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  #facet_grid(mCAF_G~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()


df$Compartment <- df$Distance
df$Compartment[df$Distance < (-200)] <-"-200"
df$Compartment[df$Distance > (-200) & df$Distance < (-100)] <-"-200 to -100"
df$Compartment[df$Distance > (-100) & df$Distance < (-50)] <-"-100 to -50"
df$Compartment[df$Distance > (-50) & df$Distance < (-40)] <-"-50 to -40"
df$Compartment[df$Distance > (-40) & df$Distance < (-30)] <-"-40 to -30"
df$Compartment[df$Distance > (-30) & df$Distance < (-20)] <-"-30 to -20"
df$Compartment[df$Distance > (-20) & df$Distance < (-10)] <-"-20 to -10"
df$Compartment[df$Distance > (-10) & df$Distance < (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance < (10)] <-"0 to 10"
df$Compartment[df$Distance > 10 & df$Distance < (20)] <-"10 to 20"
df$Compartment[df$Distance > 20 & df$Distance < (30)] <-"20 to 30"
df$Compartment[df$Distance > 20] <-">20"

df$Compartment <- factor(df$Compartment, levels = c("-200","-200 to -100","-100 to -50","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20", "20 to 30", ">20"))

df %>%
  count(Celltype, Type,Grade, Compartment) %>%
  group_by(Celltype,Type,Grade) %>%
  mutate(freq = n / sum(n))%>%
  ggplot(aes(fill=Compartment, x=freq, y=Celltype)) + 
    geom_bar(position="fill", stat="identity")+
  scale_fill_igv()+
  scale_fill_manual(values=palette(glasbey(32)))+
  facet_grid(Grade~Type)


df_t <-prop.table(table(df$Celltype,df$Compartment),1) %>% data.frame

colnames(df_t) <- c("Celltype","Distance","Freq")
df_t$Distance <- factor(df_t$Distance, levels = c("-200",
                                                        "-200 to -100",
                                                        "-100 to -50",
                                                        "-50 to -40",
                                                        "-40 to -30",
                                                        "-30 to -20",
                                                        "-20 to -10",
                                                        "-10 to -0",
                                                        "0 to 10",
                                                        "10 to 20",
                                                        "20 to 30",
                                                        ">20"))
p <- ggplot(df_t, aes(fill=Distance, x=Freq, y=Celltype)) + 
    geom_bar(position="fill", stat="identity")+
  scale_fill_igv()+
  scale_fill_manual(values=palette(glasbey(32)))
plot(p)
  
df%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  facet_grid(Grade~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()


df %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))


#+  scale_x_continuous(trans = "log10")

df%>%
  subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF"|Celltype=="vCAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  #facet_grid(Type~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()

df%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  facet_grid(Grade~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()

unique(df$Celltype)

#Tcell types
#Fibroblast Types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[, all.sce_pat.roi$cell_category=="T cell"|all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df_strat <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))

df <-left_join(df, df_strat, by="Patient_ID")
df$mCAF_G[is.na(df$mCAF_G)==T] <-"NA"
df$tpCAF_G[is.na(df$tpCAF_G)==T] <-"NA"
df$SMA_CAF_G[is.na(df$SMA_CAF_G)==T] <-"NA"
df%>%subset(mCAF_G!="NA")%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=mCAF_G, fill=mCAF_G)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  facet_wrap(~Celltype)+
  #facet_grid(mCAF_G~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()

df%>% subset(mCAF_G =="mCAF high"|mCAF_G=="mCAF low")%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(y=Distance, x=Celltype, color=mCAF_G, fill=mCAF_G)) +
  geom_boxplot()+
  ylim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  facet_grid(mCAF_G~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()

#here
df <-df %>% subset(Distance >-(600))
pvalues <- df %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
      group_by(Celltype) %>% 
      summarise(p=wilcox.test(Distance~mCAF_G, paired=F)$p.value)
      df <- left_join(df, pvalues, by.x = c("Celltype"), by.y =c("Celltype"), all.x = TRUE)
      df$p.wt <- paste0('p=',round(df$p, digits=3))

      #Plot list, all js together over i
      df %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
        ggplot(aes(x= mCAF_G, y = Distance, colour=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(~Celltype+p.wt)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
      
      
df %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))




#test

df$Compartment <- df$Distance
df$Compartment[df$Distance <= (-150)] <-"(-210)"
df$Compartment[df$Distance > (-150) & df$Distance <= (-120)] <-"-50 to -40"
df$Compartment[df$Distance > (-120) & df$Distance <= (-90)] <-"-40 to -30"
df$Compartment[df$Distance > (-90) & df$Distance <= (-60)] <-"-30 to -20"
df$Compartment[df$Distance > (-60) & df$Distance <= (-30)] <-"-20 to -10"
df$Compartment[df$Distance > (-30) & df$Distance <= (0)] <-"-10 to -0"

df$Compartment[df$Distance > 0 & df$Distance <= (30)] <-"0 to 10"
df$Compartment[df$Distance > 30] <-"10 to 20"

df$Compartment <- factor(df$Compartment, levels = c("(-210)","-50 to -40","-40 to -30","-30 to -20", "-20 to -10", "-10 to -0","0 to 10", "10 to 20"))

df <- df%>%subset(is.na(mCAF_G)!=T& Celltype!="mCAF")
test <-df %>%
  dplyr::group_by(Patient_ID, Celltype,Compartment)%>%
  dplyr::summarise(n=n()) %>%
  dplyr::group_by(Patient_ID, Celltype)%>%
  dplyr::mutate(freq=n/sum(n))%>%
  dplyr::ungroup()

test <-left_join(test, df_strat, by = "Patient_ID")
  
pvalues <- test %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
      group_by(Celltype,Compartment) %>% 
      summarise(p=wilcox.test(jitter(freq)~mCAF_G, paired=F)$p.value)
      test <- left_join(test, pvalues, by.x = c("Celltype","Compartment"), by.y =c("Celltype","Compartment"), all.x = TRUE)
      test$p.wt <- paste0('p=',round(test$p, digits=3))
 
      test %>% subset(mCAF_G=="mCAF high"|mCAF_G=="mCAF low")%>%
        ggplot(aes(x= mCAF_G, y = freq, color=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Celltype~Compartment)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        #ylim(c(-400,400))+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
            
      
      
      
      
#+  scale_x_continuous(trans = "log10")

df%>%
  subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  #facet_grid(Type~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()

df%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  facet_grid(Type~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()

unique(df$Celltype)


#Immune types
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$DX.name)

colnames(df) <- c("CellID","Distance","Celltype","Type")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))


#+  scale_x_continuous(trans = "log10")

df%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
 # facet_grid(Type~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()


df%>%
  #subset(Celltype=="tpCAF"|Celltype=="IDO_CAF")%>%
  ggplot(aes(x=Distance, color=Celltype, fill=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  #facet_wrap(~Type+Celltype)+
  facet_grid(Type~Celltype)+
  scale_fill_igv()+
  scale_color_igv()
  #scale_x_log10()f



# install.packages("car")
library(car)
df_s <- df%>% subset(mCAF_G!="NA"&Distance>(-200)&Distance<200)
df_s$mCAF_G <- as.factor(df_s$mCAF_G)
densityPlot(df_s$Distance ~ df_s$mCAF_G,
            legend = list(title = "Species"),
            xlab = "Flipper length",
            xlim = c(-200, 200))

# install.packages("sm")
library(sm)

sm.density.compare(x = df_s$Distance,
                   group = df_s$mCAF_G,
                   model = "equal")
```

```{r}
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$cell_type,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$RoiID)

colnames(df) <- c("CellID","Distance","Celltype","Type","ROI")
head(df)
roi_rem <-df[df$Distance >300,]$ROI %>%unique()

df <-df[!df$ROI %in% roi_rem,]

df %>% ggplot(aes(x=Celltype, y=Distance, fill=Celltype))+geom_boxplot()+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

kruskal.test(Distance ~Celltype, data=df)

library(FSA)
library(dunn.test)
dunnTest(Distance ~Celltype, data=df,
              method="bonferroni")

dunn.test(df$Distance, g=df$Celltype,
              method="bonferroni")

library(ggpubr)
ggqqplot(df$Distance)

one.way <- aov(Distance~Celltype, data = df)

summary(one.way)
TukeyHSD(one.way)
```

```{r}
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Immune"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
#df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)


df$Patient_ID <-factor(df$Patient_ID)
df_2 <- df %>% 
  group_by(Patient_ID) %>% 
  mutate(Invasion = if_else(any(Distance >0), "Invasion","No Invasion"))
df_immune_inv <-df_2[!duplicated(df_2$Patient_ID),] %>% select(Patient_ID, Invasion)

table(df_immune_inv$Invasion)

#T cells
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="T cell"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","Patient_ID")
#df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)


df$Patient_ID <-factor(df$Patient_ID)
df_2 <- df %>% 
  group_by(Patient_ID) %>% 
  mutate(Invasion = if_else(any(Distance >30), "Invasion","No Invasion"))
df_tcell_inv <-df_2[!duplicated(df_2$Patient_ID),] %>% select(Patient_ID, Invasion)

table(df_tcell_inv$Invasion)

```

#Spatial analysis using imcRtools
```{r, fig.width=12, fig.height=12}
library(imcRtools)
test <- all.filtered.sub
tma87A <- all.sce_pat.roi[, all.sce_pat.roi$TMA =="87A"]
tma87A <- buildSpatialGraph(tma87A,
                            img_id = "RoiID",
                            type = "knn",
                            k = 10, k_max_dist = 20,
                            name="knn_k10_dist20",
                            coords = c("Center_X", "Center_Y"))
#save different ks and max_ks under different names

colPairNames(tma87A)

library(ggplot2)
library(ggraph)

plotSpatial(tma87A[, tma87A$acID ==2],
            img_id = "RoiID",
            node_color_by = "cell_category",
            node_shape_by = "RoiID",
            node_size_by = "Area",
            draw_edges = TRUE,
           # colPairName = "knn_interaction_graph",
           colPairName="knn_k15_dist20",
            directed = FALSE,
            coords=c("Center_X", "Center_Y"))

plotSpatial(tma87A[, tma87A$acID ==2],
            img_id = "RoiID",
            node_color_by = "cell_category",
            node_shape_by = "RoiID",
            node_size_by = "Area",
            draw_edges = TRUE,
           # colPairName = "knn_interaction_graph",
           colPairName="knn_k10_dist20",
            directed = FALSE,
            coords=c("Center_X", "Center_Y"))

unique(tma87A$cell_category)


tma87A <- aggregateNeighbors(tma87A,
                                  colPairName = "knn_k15_dist20",
                                  aggregate_by = "metadata",
                                  count_by = "cell_category")
head(tma87A$aggregatedNeighbors)


cur_cluster <- kmeans(tma87A$aggregatedNeighbors, centers = 3)
tma87A$clustered_neighbors <- factor(cur_cluster$cluster)

plotSpatial(tma87A[, tma87A$acID ==2],
            img_id = "RoiID",
            coords=c("Center_X", "Center_Y"),
            node_color_by = "cell_category",
            node_size_fix = 4,
            edge_width_fix = 2,
            edge_color_by = "clustered_neighbors",
            draw_edges = TRUE,
            colPairName = "knn_k15_dist20",
            directed = FALSE,
            nodes_first = FALSE) +
    scale_color_brewer(palette = "Set2") +
    scale_edge_color_brewer(palette = "Set1")


out <- countInteractions(tma87A,
                         group_by = "RoiID",
                         label = "cell_category",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out

out <- testInteractions(tma87A,
                        group_by = "RoiID",
                        label = "cell_category",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
```


#Spatial analysis using imcRtools
```{r, fig.width=50, fig.height=50}
library(imcRtools)
#test <- all.filtered.sub
#tma87A <- all.sce_pat.roi[, all.sce_pat.roi$TMA =="87A"]

all.sce_pat.roi <- buildSpatialGraph(all.sce_pat.roi,
                            img_id = "RoiID",
                            type = "knn",
                            k = 15, k_max_dist = 20,
                            name="knn_k15_dist20",
                            coords = c("Center_X", "Center_Y"))

all.sce_pat.roi <- buildSpatialGraph(all.sce_pat.roi,
                            img_id = "RoiID",
                            type = "knn",
                            k = 10, k_max_dist = 20,
                            name="knn_k10_dist20",
                            coords = c("Center_X", "Center_Y"))
#save different ks and max_ks under different names

#colPairNames(tma87A)

library(ggplot2)
library(ggraph)

plotSpatial(all.sce_pat.roi[, all.sce_pat.roi$acID ==2],
            img_id = "RoiID",
            node_color_by = "tcell_subtype",
            node_shape_by = "RoiID",
            node_size_by = "Area",
            draw_edges = TRUE,
           # colPairName = "knn_interaction_graph",
           colPairName="knn_k15_dist20",
            directed = FALSE,
            coords=c("Center_X", "Center_Y"))

plotSpatial(all.sce_pat.roi[, all.sce_pat.roi$acID ==2],
            img_id = "RoiID",
            node_color_by = "tcell_subtype",
            node_shape_by = "RoiID",
            node_size_by = "Area",
            draw_edges = TRUE,
           # colPairName = "knn_interaction_graph",
           colPairName="knn_k10_dist20",
            directed = FALSE,
            coords=c("Center_X", "Center_Y"))

unique(all.sce_pat.roi$tcell_subtype)


all.sce_pat.roi <- aggregateNeighbors(all.sce_pat.roi,
                                  colPairName = "knn_k15_dist20",
                                  aggregate_by = "metadata",
                                  count_by = "tcell_subtype")
head(all.sce_pat.roi$aggregatedNeighbors)
df <-all.sce_pat.roi$aggregatedNeighbors
rownames(df) <-colnames(all.sce_pat.roi)
df$cell_type <- all.sce_pat.roi$tcell_subtype
df <- data.frame(df)
df$CellID <- rownames(df)
df
data.frame("CellID"=all.sce_pat.roi$CellID, "Type"=all.sce_pat.roi$tcell_subtype)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 30)
all.sce_pat.roi$clustered_neighbors_30 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 29)
all.sce_pat.roi$clustered_neighbors_29 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 28)
all.sce_pat.roi$clustered_neighbors_28 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 27)
all.sce_pat.roi$clustered_neighbors_27 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 26)
all.sce_pat.roi$clustered_neighbors_26 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 25)
all.sce_pat.roi$clustered_neighbors_25 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 24)
all.sce_pat.roi$clustered_neighbors_24 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 23)
all.sce_pat.roi$clustered_neighbors_23 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 22)
all.sce_pat.roi$clustered_neighbors_22 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 21)
all.sce_pat.roi$clustered_neighbors_21 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 20)
all.sce_pat.roi$clustered_neighbors_20 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 19)
all.sce_pat.roi$clustered_neighbors_19 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 18)
all.sce_pat.roi$clustered_neighbors_18 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 17)
all.sce_pat.roi$clustered_neighbors_17 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 16)
all.sce_pat.roi$clustered_neighbors_16 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 15)
all.sce_pat.roi$clustered_neighbors_15 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 14)
all.sce_pat.roi$clustered_neighbors_14 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 13)
all.sce_pat.roi$clustered_neighbors_13 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 12)
all.sce_pat.roi$clustered_neighbors_12 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 11)
all.sce_pat.roi$clustered_neighbors_11 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 10)
all.sce_pat.roi$clustered_neighbors_10 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 9)
all.sce_pat.roi$clustered_neighbors_9 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 8)
all.sce_pat.roi$clustered_neighbors_8 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 7)
all.sce_pat.roi$clustered_neighbors_7 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(all.sce_pat.roi$aggregatedNeighbors, centers = 6)
all.sce_pat.roi$clustered_neighbors_6 <- factor(cur_cluster$cluster)


data_folder <- file.path(wd, "sce_objects","Distances")
saveRDS(all.sce_pat.roi, file=file.path(data_folder,"all_minus_other_distances.rds"))
all.sce_pat.roi <-readRDS(file=file.path(data_folder,"all_minus_other_distances.rds"))

plotSpatial(all.sce_pat.roi[, all.sce_pat.roi$acID ==2],
            img_id = "RoiID",
            coords=c("Center_X", "Center_Y"),
            node_color_by = "tcell_subtype",
            node_size_fix = 3,
            edge_width_fix = 2,
            edge_color_by = "clustered_neighbors_15",
            draw_edges = TRUE,
            colPairName = "knn_k15_dist20",
            directed = FALSE,
            nodes_first = FALSE) +
  scale_color_igv()#+
   # scale_color_brewer(palette = "Set2") +
    #scale_edge_color_brewer(palette = "Set1")


clus <- c(5:30)
clus=20
for(i in clus){
  p_clus <- paste0("clustered_neighbors_",i)
p <-plotSpatial(all.sce_pat.roi[, all.sce_pat.roi$acID ==1],
            img_id = "RoiID",
            coords=c("Center_X", "Center_Y"),
            node_color_by = "tcell_subtype",
            node_size_fix = 3,
            edge_width_fix = 2,
            edge_color_by = paste(p_clus),
            draw_edges = TRUE,
            colPairName = "knn_k15_dist20",
            directed = FALSE,
            nodes_first = FALSE) +
  scale_color_igv()#+
   # scale_color_brewer(palette = "Set2") +
    #scale_edge_color_brewer(palette = "Set1")
plot(p)
}
df <-round(prop.table(table(all.sce_pat.roi$clustered_neighbors_5, all.sce_pat.roi$tcell_subtype),1)*100, digits = 2)

pheatmap(scale(df))

data_folder <-file.path(wd,"sce_objects","merge_plus_tumour")
out <- countInteractions(all.sce_pat.roi,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_all-sce-pat-roi.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_all-sce-pat-roi.csv"))

out <- testInteractions(all.sce_pat.roi,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_all-sce-pat-roi.csv"))

length(unique(all.sce_pat.roi[, all.sce_pat.roi$TmaID==86]$tcell_subtype))

tma86 <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==86]
saveRDS(tma86, file=file.path(data_folder, "tma86_distances.rds"))
tma86<- readRDS(file=file.path(data_folder, "tma86_distances.rds"))

tma87 <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==87]
saveRDS(tma87, file=file.path(data_folder, "tma87_distances.rds"))
tma87<- readRDS(file=file.path(data_folder, "tma87_distances.rds"))

tma88 <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==88]
saveRDS(tma88, file=file.path(data_folder, "tma88_distances.rds"))


tma175 <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==175]
saveRDS(tma175, file=file.path(data_folder, "tma175_distances.rds"))

tma176 <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==176]
saveRDS(tma176, file=file.path(data_folder, "tma176_distances.rds"))

tma178 <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==178]
saveRDS(tma178, file=file.path(data_folder, "tma178_distances.rds"))

```


```{r, fig.width=8, fig.height=8}
clus <- c(10:30)
p_clus <- paste0("clustered_neighbors_",clus)

for(i in p_clus){
df <-round(prop.table(table(all.sce_pat.roi[[i]], all.sce_pat.roi$tcell_subtype),1)*100, digits = 2)

pheatmap(t(scale(df))) %>%print

}

clus <- c(15)
p_clus <- paste0("clustered_neighbors_",clus)

for(i in p_clus){
  
  df <-round(prop.table(table(all.sce_pat.roi[[i]], all.sce_pat.roi$tcell_subtype),1)*100, digits = 2)

  df <-df %>% data.frame
  colnames(df) <- c("Cluster","CellType","Freq")
  print(df %>% pivot_wider(id_cols=Cluster,values_from=Freq, names_from=CellType))
  p <- ggplot(df, aes(fill=CellType, x=Freq, y=Cluster)) + 
    geom_bar(position="fill", stat="identity")+
  scale_fill_igv()+
  scale_fill_manual(values=palette(glasbey(32)))
  plot(p)
}
```




```{r tma86}
out <- countInteractions(tma86,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma86_histocat.csv"))
##out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma86.csv"))

out <- testInteractions(tma86,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma86_histocat.csv"))
```


```{r tma87}
data_folder <- file.path(wd, "sce_objects","Distances")

tma87 <-readRDS(file=file.path(data_folder, "tma87_distances.rds"))

out <- countInteractions(tma87,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma87_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma87.csv"))

out <- testInteractions(tma87,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma87_histocat.csv"))
```


```{r tma88}
out <- countInteractions(tma88,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma88_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma88.csv"))

out <- testInteractions(tma88,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma88_histocat.csv"))

out <- countInteractions(tma175,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma175_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma175.csv"))

out <- testInteractions(tma175,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma175_histocat.csv"))

out <- countInteractions(tma176,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma176_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma176.csv"))

out <- testInteractions(tma176,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma176_histocat.csv"))

out <- countInteractions(tma178,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma178_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma178.csv"))

out <- testInteractions(tma178,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma178_histocat.csv"))
```


```{r, fig.width=8, fig.height=8}
df <-round(prop.table(table(all.sce_pat.roi$clustered_neighbors_10, all.sce_pat.roi$tcell_subtype),1)*100, digits = 2)

pheatmap(t(scale(df)))

```

```{r}
df
```

```{r}
df <-data.frame(round(prop.table(table(all.sce_pat.roi$Patient_ID,
                            all.sce_pat.roi$clustered_neighbors_10),1)*100, digits = 2))

df <- data.frame(table(all.sce_pat.roi$Patient_ID,
                            all.sce_pat.roi$clustered_neighbors_10))
colnames(df) <- c("Patient_ID","Spatial_Cluster","n")

df <-df %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
df[is.na(df)] <- 0

df_clin <- data.frame("Patient_ID"=all.sce_pat.roi$Patient_ID,"Grade"=all.sce_pat.roi$Grade)
df_clin = df_clin[!duplicated(df_clin$Patient_ID),]

df <- left_join(df, df_clin, by="Patient_ID")

clinical.data  %>% select(paste(i))
i ="Grade"

```

```{r}
#clinical.data <-as.data.frame(colData(immune.sce))

clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]
clinical.data$X <-NULL
clinical.data$X.1 <-NULL
head(clinical.data)
```

```{r  KW W Spatial cluster 5, fig.width=15, fig.height=10,message=FALSE, warning=FALSE, echo=FALSE}

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj","Smok")

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Smok")


#categories <- "Grade"
plot_list <- list()

df <- data.frame(table(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                            all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                              all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$clustered_neighbors_15))

colnames(df) <- c("Patient_ID","Spatial_Cluster","n")
neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
df <-df[!df$Patient_ID%in% neoadj_pat,]

df <-df %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
df[is.na(df)] <- 0


for (i in (categories)) {
df_clin <- clinical.data %>% select(paste(categories),"Patient_ID" )

    t <- left_join(df, df_clin, by="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)
  
  for (j in unique(t$Spatial_Cluster)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)

    tdat <-subset(tdat, Spatial_Cluster==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Spatial_Cluster) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Spatial_Cluster, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)

      tdat <-subset(tdat, Spatial_Cluster==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Spatial_Cluster) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Spatial_Cluster", by.y ="Spatial_Cluster", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Spatial_Cluster+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Spatial_Cluster"))+
      
        scale_color_viridis_d()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Spatial_Cluster")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Spatial_Cluster)))
  
  #save out in individual pdfs for each variable
#  pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_Wneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Spatial_Cluster)))
 # dev.off()
}
```





```{r  KW W Spatial cluster 10, fig.width=12, fig.height=6, message=FALSE, warning=FALSE, echo=FALSE}

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj")
#categories <- "Grade"
plot_list <- list()

   df <- data.frame(table(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                            all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                            all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$clustered_neighbors_10))
colnames(df) <- c("Patient_ID","Spatial_Cluster","n")

neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
df <-df[!df$Patient_ID%in% neoadj_pat,]

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")


df <-df %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
df[is.na(df)] <- 0

for (i in (categories)) {


df_clin <- clinical.data %>% select(paste(categories),"Patient_ID" )

    t <- left_join(df, df_clin, by="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)
  
  for (j in unique(t$Spatial_Cluster)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)

    tdat <-subset(tdat, Spatial_Cluster==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Spatial_Cluster) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Spatial_Cluster, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)

      tdat <-subset(tdat, Spatial_Cluster==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Spatial_Cluster) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Spatial_Cluster", by.y ="Spatial_Cluster", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Spatial_Cluster+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Spatial_Cluster"))+
      
        scale_color_viridis_d()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Spatial_Cluster")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Spatial_Cluster)))
  
  #save out in individual pdfs for each variable
#  pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_Wneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Spatial_Cluster)))
 # dev.off()
}
```



```{r  KW W Spatial cluster 15, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj")
#categories <- "Grade"
plot_list <- list()

df <- data.frame(table(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                            all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                              all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$clustered_neighbors_15))
   
colnames(df) <- c("Patient_ID","Spatial_Cluster","n")

neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
df <-df[!df$Patient_ID%in% neoadj_pat,]

df <-df %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
df[is.na(df)] <- 0


for (i in (categories)) {

df_clin <- clinical.data %>% select(paste(categories),"Patient_ID" )

    t <- left_join(df, df_clin, by="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)
  
  for (j in unique(t$Spatial_Cluster)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)

    tdat <-subset(tdat, Spatial_Cluster==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Spatial_Cluster) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Spatial_Cluster, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Spatial_Cluster <-droplevels(tdat$Spatial_Cluster)

      tdat <-subset(tdat, Spatial_Cluster==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Spatial_Cluster) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Spatial_Cluster", by.y ="Spatial_Cluster", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Spatial_Cluster+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Spatial_Cluster"))+
      
        scale_color_viridis_d()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Spatial_Cluster")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=7) #, ncol=round(length(unique(t$Spatial_Cluster)))
  
  #save out in individual pdfs for each variable
#  pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_Wneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Spatial_Cluster)))
 # dev.off()
}
```



```{r, fig.width=8, fig.height=8}
df <-round(prop.table(table(all.sce_pat.roi$clustered_neighbors_15, all.sce_pat.roi$tcell_subtype),1)*100, digits = 2)

pheatmap(t(scale(df)))
pheatmap(t(df))

```


#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=4, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df$X <-NULL
  
colData(all.sce_pat.roi)<-as.data.frame(colData(all.sce_pat.roi)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(all.sce_pat.roi))
#if necessary: change group_id labels

dat <-left_join(dat, df, by="Patient_ID")
#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)


caf_groups <- colnames(df[,-1])
category <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met",caf_groups)

#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"clustered_neighbors_15"

plot_list <- list()
for (i in category) {
  #for(k in unique(dat$DX.name)){
   # dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list(clustered_neighbors_15=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  #}
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_Fibro_n_over_",i,".pdf")))
  #gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()
```



#MINUS TUMOUR

```{r}
data_folder <-file.path(wd,"sce_objects","final objects with categories","FINAL")

sce <- readRDS(file=file.path(data_folder, "ALL_minus-Tumour_sce_pat_roi_rem.rds"))

data_folder <-file.path(wd,"sce_objects","merge_minus_Tumour")
sce2 <- readRDS(file=file.path(data_folder, "ALL_minus-Tumour_sce_pat_roi_rem.rds"))
sce2$cell_subtype%>% unique



data_folder <-file.path(wd,"sce_objects","merge_minus_Tumour")
unique(all.sce$cell_category)
all.sce[, all.sce$cell_category!="Other"]
saveRDS(all.sce_pat.roi,file=file.path(data_folder, paste("ALL_minus-Tumour_sce_pat_roi_rem.rds",sep="")))
saveRDS(all.sce_roi,file=file.path(data_folder, paste("ALL_minus-Tumour_sce_roi_rem.rds",sep="")))
saveRDS(all.sce_pat,file=file.path(data_folder, paste("ALL_minus-Tumour_sce_pat_rem.rds",sep="")))

sce <-readRDS(file=file.path(data_folder, paste("ALL_minus-Tumour_sce_pat_roi_rem.rds",sep="")))
#all.sce_roi <-readRDS(file=file.path(data_folder, paste("ALL_minus-Tumour_sce_roi_rem.rds",sep="")))
#all.sce_pat <-readRDS(file=file.path(data_folder, paste("ALL_minus-Tumour_sce_pat_rem.rds",sep="")))

```

#Spatial analysis using imcRtools
```{r, fig.width=50, fig.height=50}
library(imcRtools)
#test <- all.filtered.sub
#tma87A <- sce[, sce$TMA =="87A"]

sce$tcell_subtype <-sce$cell_subtype
sce$tcell_subtype[sce$cell_category=="Fibroblast"] <- sce[, sce$cell_category=="Fibroblast"]$cell_type
#unique(all.sce$tcell_subtype)
sce <- buildSpatialGraph(sce,
                            img_id = "RoiID",
                            type = "knn",
                            k = 15, k_max_dist = 20,
                            name="knn_k15_dist20",
                            coords = c("Center_X", "Center_Y"))

data_folder <- file.path(wd, "sce_objects","Distances")
saveRDS(sce, file=file.path(data_folder,"all_minus_TUMOURother_distances.rds"))

#save different ks and max_ks under different names

#colPairNames(tma87A)

library(ggplot2)
library(ggraph)

plotSpatial(sce[, sce$acID ==2],
            img_id = "RoiID",
            node_color_by = "tcell_subtype",
            node_shape_by = "RoiID",
            node_size_by = "Area",
            draw_edges = TRUE,
           # colPairName = "knn_interaction_graph",
           colPairName="knn_k15_dist20",
            directed = FALSE,
            coords=c("Center_X", "Center_Y"))

unique(sce$tcell_subtype)


sce <- aggregateNeighbors(sce,
                          colPairName = "knn_k15_dist20",
                                  aggregate_by = "metadata",
                                  count_by = "tcell_subtype")
head(sce$aggregatedNeighbors)
df <-sce$aggregatedNeighbors
rownames(df) <-colnames(sce)
df$cell_type <- sce$tcell_subtype
df <- data.frame(df)
df$CellID <- rownames(df)
df
data.frame("CellID"=sce$CellID, "Type"=sce$tcell_subtype)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 5)
sce$clustered_neighbors_5 <- factor(cur_cluster$cluster)
cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 10)
sce$clustered_neighbors_10 <- factor(cur_cluster$cluster)
cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 15)
sce$clustered_neighbors_15 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 20)
sce$clustered_neighbors_20 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 30)
sce$clustered_neighbors_30 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 29)
sce$clustered_neighbors_29 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 28)
sce$clustered_neighbors_28 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 27)
sce$clustered_neighbors_27 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 26)
sce$clustered_neighbors_26 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 25)
sce$clustered_neighbors_25 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 24)
sce$clustered_neighbors_24 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 23)
sce$clustered_neighbors_23 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 22)
sce$clustered_neighbors_22 <- factor(cur_cluster$cluster)


cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 21)
sce$clustered_neighbors_21 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 20)
sce$clustered_neighbors_20 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 19)
sce$clustered_neighbors_19 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 18)
sce$clustered_neighbors_18 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 17)
sce$clustered_neighbors_17 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 16)
sce$clustered_neighbors_16 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 15)
sce$clustered_neighbors_15 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 14)
sce$clustered_neighbors_14 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 13)
sce$clustered_neighbors_13 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 12)
sce$clustered_neighbors_12 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 11)
sce$clustered_neighbors_11 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 10)
sce$clustered_neighbors_10 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 9)
sce$clustered_neighbors_9 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 8)
sce$clustered_neighbors_8 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 7)
sce$clustered_neighbors_7 <- factor(cur_cluster$cluster)

cur_cluster <- kmeans(sce$aggregatedNeighbors, centers = 6)
sce$clustered_neighbors_6 <- factor(cur_cluster$cluster)


data_folder <- file.path(wd, "sce_objects","Distances")
saveRDS(sce, file=file.path(data_folder,"all_minus_TUMOURother_distances.rds"))
sce <-readRDS(file=file.path(data_folder,"all_minus_TUMOURother_distances.rds"))

plotSpatial(sce[, sce$acID ==2],
            img_id = "RoiID",
            coords=c("Center_X", "Center_Y"),
            node_color_by = "tcell_subtype",
            node_size_fix = 3,
            edge_width_fix = 2,
            edge_color_by = "clustered_neighbors_15",
            draw_edges = TRUE,
            colPairName = "knn_k15_dist20",
            directed = FALSE,
            nodes_first = FALSE) +
  scale_color_igv()#+
   # scale_color_brewer(palette = "Set2") +
    #scale_edge_color_brewer(palette = "Set1")

2165101+2875218
4991390
sce$tcell_subtype %>% table
```

```{r, fig.width=8, fig.height=8}
clus <- c(10:30)
p_clus <- paste0("clustered_neighbors_",clus)

for(i in p_clus){
df <-round(prop.table(table(sce[[i]], sce$tcell_subtype),1)*100, digits = 2)

pheatmap(t(scale(df))) %>%print

}

clus <- c(30)
p_clus <- paste0("clustered_neighbors_",clus)


for(i in p_clus){
  
  df <-round(prop.table(table(sce[[i]], sce$tcell_subtype),1)*100, digits = 2)
  df <-df %>% data.frame
  colnames(df) <- c("Cluster","CellType","Freq")
print(df %>% pivot_wider(id_cols=Cluster,values_from=Freq, names_from=CellType))
  p <- ggplot(df, aes(fill=CellType, x=Freq, y=Cluster)) + 
    geom_bar(position="fill", stat="identity")+
  scale_fill_igv()+
  scale_fill_manual(values=palette(glasbey(32)))
  plot(p)
}

```

```{r, fig.width=50, fig.height=50}
df <-round(prop.table(table(sce$clustered_neighbors_5, sce$tcell_subtype),1)*100, digits = 2)

pheatmap(scale(df))

data_folder <-file.path(wd,"sce_objects","merge_plus_tumour")
out <- countInteractions(sce,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_all-sce-pat-roi.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_all-sce-pat-roi.csv"))

out <- testInteractions(sce,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_all-sce-pat-roi.csv"))

length(unique(sce[, sce$TmaID==86]$tcell_subtype))

tma86 <-sce[, sce$TmaID==86]
saveRDS(tma86, file=file.path(data_folder, "tma86_minusTUMOUR_distances.rds"))
tma86<- readRDS(file=file.path(data_folder, "tma86_minusTUMOUR_distances.rds"))

tma87 <-sce[, sce$TmaID==87]
saveRDS(tma87, file=file.path(data_folder, "tma87_minusTUMOUR_distances.rds"))
tma87<- readRDS(file=file.path(data_folder, "tma87_minusTUMOUR_distances.rds"))

tma88 <-sce[, sce$TmaID==88]
saveRDS(tma88, file=file.path(data_folder, "tma88_minusTUMOUR_distances.rds"))


tma175 <-sce[, sce$TmaID==175]
saveRDS(tma175, file=file.path(data_folder, "tma175_minusTUMOUR_distances.rds"))

tma176 <-sce[, sce$TmaID==176]
saveRDS(tma176, file=file.path(data_folder, "tma176_minusTUMOUR_distances.rds"))

tma178 <-sce[, sce$TmaID==178]
saveRDS(tma178, file=file.path(data_folder, "tma178_minusTUMOUR_distances.rds"))

unique(tma87$cell_category)
```


#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=8, fig.height=6, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df$X <-NULL
  
colData(sce)<-as.data.frame(colData(sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(sce))
#if necessary: change group_id labels

dat <-left_join(dat, df, by="Patient_ID")
#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)


caf_groups <- colnames(df[,-1])
category <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met",caf_groups)
category <- "LN.Met"
#category <- "tpCAF_G"
#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"clustered_neighbors_30"

plot_list <- list()
for (i in category) {
  #for(k in unique(dat$DX.name)){
   # dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list(clustered_neighbors_30=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  #}
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_Fibro_n_over_",i,".pdf")))
  #gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()
```

```{r, fig.width=50, fig.height=50}
```

```{r histocat}
out <- countInteractions(tma86,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma86_minusTUMOUR_histocat.csv"))
##out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma86.csv"))

out <- testInteractions(tma86,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma86_minusTUMOUR_histocat.csv"))

data_folder <- file.path(wd, "sce_objects","Distances")

tma87 <-readRDS(file=file.path(data_folder, "tma87_distances.rds"))

out <- countInteractions(tma87,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma87_minusTUMOUR_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma87.csv"))

out <- testInteractions(tma87,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma87_minusTUMOUR_histocat.csv"))

out <- countInteractions(tma88,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma88_minusTUMOUR_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma88.csv"))

out <- testInteractions(tma88,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma88_minusTUMOUR_histocat.csv"))

out <- countInteractions(tma175,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma175_minusTUMOUR_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma175.csv"))

out <- testInteractions(tma175,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma175_minusTUMOUR_histocat.csv"))

out <- countInteractions(tma176,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma176_minusTUMOUR_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma176.csv"))

out <- testInteractions(tma176,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma176_minusTUMOUR_histocat.csv"))

out <- countInteractions(tma178,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "histocat",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma178_minusTUMOUR_histocat.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma178.csv"))

out <- testInteractions(tma178,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "histocat",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma178_minusTUMOUR_histocat.csv"))

#classic
out <- countInteractions(tma86,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma86_minusTUMOUR_classic.csv"))
##out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma86.csv"))

out <- testInteractions(tma86,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma86_minusTUMOUR_classic.csv"))

data_folder <- file.path(wd, "sce_objects","Distances")

#tma87 <-readRDS(file=file.path(data_folder, "tma87_distances.rds"))

out <- countInteractions(tma87,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma87_minusTUMOUR_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma87.csv"))

out <- testInteractions(tma87,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma87_minusTUMOUR_classic.csv"))

out <- countInteractions(tma88,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma88_minusTUMOUR_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma88.csv"))

out <- testInteractions(tma88,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma88_minusTUMOUR_classic.csv"))

out <- countInteractions(tma175,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma175_minusTUMOUR_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma175.csv"))

out <- testInteractions(tma175,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma175_minusTUMOUR_classic.csv"))

out <- countInteractions(tma176,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma176_minusTUMOUR_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma176.csv"))

out <- testInteractions(tma176,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma176_minusTUMOUR_classic.csv"))

out <- countInteractions(tma178,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma178_minusTUMOUR_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma178.csv"))

out <- testInteractions(tma178,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma178_minusTUMOUR_classic.csv"))
```

```{r merge histocat minus tumour}
out_86 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma86_minusTUMOUR_histocat.csv"))
out_87 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma87_minusTUMOUR_histocat.csv"))
out_88 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma88_minusTUMOUR_histocat.csv"))
out_175 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma175_minusTUMOUR_histocat.csv"))
out_176 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma176_minusTUMOUR_histocat.csv"))
out_178 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma178_minusTUMOUR_histocat.csv"))

out_minusT_h <- rbind(out_86,out_87,out_88,out_175,out_176,out_178)
write.csv(out_minusT_h, file=file.path(data_folder, "all_out_minusTumour_histocat.csv"))

out_86 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma86_minusTUMOUR_classic.csv"))
out_87 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma87_minusTUMOUR_classic.csv"))
out_88 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma88_minusTUMOUR_classic.csv"))
out_175 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma175_minusTUMOUR_classic.csv"))
out_176 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma176_minusTUMOUR_classic.csv"))
out_178 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma178_minusTUMOUR_classic.csv"))

out_minusT_c <- rbind(out_86,out_87,out_88,out_175,out_176,out_178)
write.csv(out_minusT_c, file=file.path(data_folder, "all_out_minusTumour_classic.csv"))
out_minusT_c <- read.csv(file=file.path(data_folder, "all_out_minusTumour_classic.csv"))

out_178$from_label %>% unique()
```

```{r merge histocat incl tumour}
out_86 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma86_histocat.csv"))
out_87 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma87_histocat.csv"))
out_88 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma88_histocat.csv"))
out_175 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma175_histocat.csv"))
out_176 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma176_histocat.csv"))
out_178 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma178_histocat.csv"))

out_h <- rbind(out_86,out_87,out_88,out_175,out_176,out_178)
write.csv(out_h, file=file.path(data_folder, "all_out_histocat.csv"))
out_h <- read.csv(file=file.path(data_folder, "all_out_histocat.csv"))

out_86 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma86.csv"))
out_87 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma87.csv"))
out_88 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma88.csv"))
out_175 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma175.csv"))
out_176 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma176.csv"))
out_178 <- read.csv(file= file.path(data_folder, "testInteractions_tcellsub_tma178.csv"))

out_c <- rbind(out_86,out_87,out_88,out_175,out_176,out_178)
write.csv(out_c, file=file.path(data_folder, "all_out_classic.csv"))

out_c <- read.csv(file=file.path(data_folder, "all_out_classic.csv"))

```

```{r}
#clinical.data <-as.data.frame(colData(immune.sce))

clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$RoiID),]
clinical.data$X <-NULL
clinical.data$X.1 <-NULL
head(clinical.data)
```



```{r all classical, fig.width=12, fig.height=10}
out_c$RoiID <- out_c$group_by
cur_test <- left_join(out_c, clinical.data, by="RoiID")

cur_test$LN.Met[is.na(cur_test$LN.Met)]<-"NA"
cur_test$Grade[is.na(cur_test$Grade)]<-"NA"
cur_test$Dist.Met[is.na(cur_test$Dist.Met)]<-"NA"
cur_test$M.new[is.na(cur_test$M.new)]<-"NA"

table(cur_test$LN.Met)

cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma")%>% subset(Grade !="NA") %>% as_tibble() %>%#)
  group_by(Grade, from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))

#not split
p <-cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma") %>% as_tibble() %>%#)
  group_by(from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + #facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_classical.pdf"), width=8, height=7)
```


```{r all histocat, fig.width=18, fig.height=12}
out_h$RoiID <- out_h$group_by
cur_test <- left_join(out_h, clinical.data, by="RoiID")

cur_test$LN.Met[is.na(cur_test$LN.Met)]<-"NA"
cur_test$Grade[is.na(cur_test$Grade)]<-"NA"
cur_test$Dist.Met[is.na(cur_test$Dist.Met)]<-"NA"
cur_test$M.new[is.na(cur_test$M.new)]<-"NA"

table(cur_test$LN.Met)

#not split
p <-cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma") %>% as_tibble() %>%#)
  group_by(from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + #facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat.pdf"), width=8, height=6)

#split
cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma")%>% subset(Grade !="NA") %>% as_tibble() %>%#)
  group_by(Grade, from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat.pdf"), width=8, height=7)


```

```{r all histocat, fig.width=18, fig.height=12}
out_minusT_h$RoiID <- out_minusT_h$group_by
cur_test <- left_join(out_c, clinical.data, by="RoiID")

cur_test$LN.Met[is.na(cur_test$LN.Met)]<-"NA"
cur_test$Grade[is.na(cur_test$Grade)]<-"NA"
cur_test$Dist.Met[is.na(cur_test$Dist.Met)]<-"NA"
cur_test$M.new[is.na(cur_test$M.new)]<-"NA"

table(cur_test$LN.Met)

cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma")%>% subset(Grade !="NA") %>% as_tibble() %>%#)
  group_by(Grade, from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))


out_minusT_h$from_label %>% unique()
```

```{r minus tumour classic, fig.width=18, fig.height=12}
out_minusT_c$RoiID <- out_minusT_c$group_by
cur_test <- left_join(out_c, clinical.data, by="RoiID")

cur_test$LN.Met[is.na(cur_test$LN.Met)]<-"NA"
cur_test$Grade[is.na(cur_test$Grade)]<-"NA"
cur_test$Dist.Met[is.na(cur_test$Dist.Met)]<-"NA"
cur_test$M.new[is.na(cur_test$M.new)]<-"NA"

table(cur_test$LN.Met)

cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma")%>% subset(Grade !="NA") %>% as_tibble() %>%#)
  group_by(Grade, from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))


out_minusT_c$from_label %>% unique()
```




####### AC SQC split
```{r}
data_folder <- file.path(wd, "sce_objects","Distances")
all.sce_pat.roi <-readRDS(file=file.path(data_folder,"all_minus_other_distances.rds"))

tma86_ac <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==86&all.sce_pat.roi$DX.name=="Adenocarcinoma"]
saveRDS(tma86_ac, file=file.path(data_folder, "tma86_ac_distances.rds"))
#tma86<- readRDS(file=file.path(data_folder, "tma86_ac_distances.rds"))

tma87_ac <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==87&all.sce_pat.roi$DX.name=="Adenocarcinoma"]
saveRDS(tma87_ac, file=file.path(data_folder, "tma87_ac_distances.rds"))
#tma87<- readRDS(file=file.path(data_folder, "tma87_ac_distances.rds"))

tma88_ac <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==88&all.sce_pat.roi$DX.name=="Adenocarcinoma"]
saveRDS(tma88_ac, file=file.path(data_folder, "tma88_ac_distances.rds"))


tma175_ac <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==175&all.sce_pat.roi$DX.name=="Adenocarcinoma"]
saveRDS(tma175_ac, file=file.path(data_folder, "tma175_ac_distances.rds"))

tma176_ac <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==176&all.sce_pat.roi$DX.name=="Adenocarcinoma"]
saveRDS(tma176_ac, file=file.path(data_folder, "tma176_ac_distances.rds"))

tma178_ac <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==178&all.sce_pat.roi$DX.name=="Adenocarcinoma"]
saveRDS(tma178_ac, file=file.path(data_folder, "tma178_ac_distances.rds"))


tma86_sqc <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==86&all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
saveRDS(tma86_sqc, file=file.path(data_folder, "tma86_sqc_distances.rds"))
#tma86<- readRDS(file=file.path(data_folder, "tma86_sqc_distances.rds"))

tma87_sqc <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==87&all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
saveRDS(tma87_sqc, file=file.path(data_folder, "tma87_sqc_distances.rds"))
#tma87<- readRDS(file=file.path(data_folder, "tma87_sqc_distances.rds"))

tma88_sqc <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==88&all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
saveRDS(tma88_sqc, file=file.path(data_folder, "tma88_sqc_distances.rds"))


tma175_sqc <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==175&all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
saveRDS(tma175_sqc, file=file.path(data_folder, "tma175_sqc_distances.rds"))

tma176_sqc <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==176&all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
saveRDS(tma176_sqc, file=file.path(data_folder, "tma176_sqc_distances.rds"))

tma178_sqc <-all.sce_pat.roi[, all.sce_pat.roi$TmaID==178&all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
saveRDS(tma178_sqc, file=file.path(data_folder, "tma178_sqc_distances.rds"))

```

```{r}
library(imcRtools)
out <- countInteractions(tma86_ac,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma86_AC_classic.csv"))
##out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma86.csv"))

out <- testInteractions(tma86_ac,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma86_AC_classic.csv"))

data_folder <- file.path(wd, "sce_objects","Distances")

#tma87 <-readRDS(file=file.path(data_folder, "tma87_distances.rds"))

out <- countInteractions(tma87_ac,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma87_AC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma87.csv"))

out <- testInteractions(tma87_ac,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma87_AC_classic.csv"))

out <- countInteractions(tma88_ac,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma88_AC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma88.csv"))

out <- testInteractions(tma88_ac,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma88_AC_classic.csv"))

out <- countInteractions(tma175_ac,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma175_AC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma175.csv"))

out <- testInteractions(tma175_ac,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma175_AC_classic.csv"))

out <- countInteractions(tma176_ac,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma176_AC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma176.csv"))

out <- testInteractions(tma176_ac,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma176_AC_classic.csv"))

out <- countInteractions(tma178_ac,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma178_AC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma178.csv"))

out <- testInteractions(tma178_ac,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma178_AC_classic.csv"))

#sqc
out <- countInteractions(tma86_sqc,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma86_SQC_classic.csv"))
##out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma86.csv"))

out <- testInteractions(tma86_sqc,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma86_SQC_classic.csv"))

data_folder <- file.path(wd, "sce_objects","Distances")

#tma87 <-readRDS(file=file.path(data_folder, "tma87_distances.rds"))

out <- countInteractions(tma87_sqc,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma87_SQC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma87.csv"))

out <- testInteractions(tma87_sqc,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma87_SQC_classic.csv"))

out <- countInteractions(tma88_sqc,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma88_SQC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma88.csv"))

out <- testInteractions(tma88_sqc,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma88_SQC_classic.csv"))

out <- countInteractions(tma175_sqc,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma175_SQC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma175.csv"))

out <- testInteractions(tma175_sqc,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma175_SQC_classic.csv"))

out <- countInteractions(tma176_sqc,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma176_SQC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma176.csv"))

out <- testInteractions(tma176_sqc,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma176_SQC_classic.csv"))

out <- countInteractions(tma178_sqc,
                         group_by = "RoiID",
                         label = "tcell_subtype",
                         method = "classic",
                         colPairName = "knn_k15_dist20")
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"countInteractions_tcellsub_tma178_SQC_classic.csv"))
#out <- read.csv(file=file.path(data_folder,"countInteractions_tcellsub_tma178.csv"))

out <- testInteractions(tma178_sqc,
                        group_by = "RoiID",
                        label = "tcell_subtype",
                        method = "classic",
                        colPairName = "knn_k15_dist20")
out
out <- data.frame(out)
write.csv(out,file=file.path(data_folder,"testInteractions_tcellsub_tma178_SQC_classic.csv"))
```

```{r}

if (!require("BiocManager"))
    install.packages("BiocManager")
BiocManager::install("spicyR")
library(spicyR)

```
```{r}

if (!require("BiocManager"))
    install.packages("BiocManager")
BiocManager::install("spicyR")
library(spicyR)

```

```{r Grade, fig.width=12, fig.height=12}

dat.counts <-as.data.frame(t((assay(all.sce_pat.roi,"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- all.sce_pat.roi$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi$Center_Y

dat.counts$AreaShape_Center_X <- all.sce_pat.roi$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi$Center_Y
dat.counts$imageID <- all.sce_pat.roi$RoiID
dat.counts$cellType <- all.sce_pat.roi$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum



clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$RoiID),]
clinical.data$imageID <- clinical.data$RoiID
phenoData <- clinical.data[clinical.data$RoiID %in% unique(all.sce_pat.roi$RoiID),]
cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender")
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

#Grade
spicyTest <- spicy(cellExp, 
                   condition = "Grade", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_Grade.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))
 ggsave(plot=p, file=file.path(wd, "plots","spicyR_Grade.pdf"))
 
 
```


```{r Grade, fig.width=12, fig.height=12}

dat.counts <-as.data.frame(t((assay(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_Y
dat.counts$imageID <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID
dat.counts$cellType <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum



clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$RoiID),]
clinical.data$imageID <- clinical.data$RoiID
phenoData <- clinical.data[clinical.data$RoiID %in% unique(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID),]
cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo")
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

#Type
spicyTest <- spicy(cellExp, 
                   condition = "DX.name", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_type.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_type.pdf"))
 
#Relapse
spicyTest <- spicy(cellExp, 
                   condition = "Relapse", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_Relapse.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_Relapse.pdf"))
 
 #NeoAdj
spicyTest <- spicy(cellExp, 
                   condition = "NeoAdj", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_NeoAdj.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_NeoAdj.pdf"))
 
 #LN.Met
spicyTest <- spicy(cellExp, 
                   condition = "LN.Met", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_LNMet.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_LNMet.pdf"))
 
 #Dist.Met
spicyTest <- spicy(cellExp, 
                   condition = "Dist.Met", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_DistMet.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_DistMet.pdf"))
 
 #Radido
spicyTest <- spicy(cellExp, 
                   condition = "Radio", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_Radio.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_Radio.pdf"))
 
#Chemo
spicyTest <- spicy(cellExp, 
                   condition = "Chemo", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_Chemo.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_Chemo.pdf"))
 
 
```

```{r Grade AC, fig.width=12, fig.height=12}
all.sce_pat.roi$Grade[is.na(all.sce_pat.roi$Grade)]<-"NA"

#sub_sce <- all.sce_pat.roi[,all.sce_pat.roi$Grade=="2"|
#                             all.sce_pat.roi$Grade=="3"]
dat.counts <-as.data.frame(t((assay(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$Center_Y
dat.counts$imageID <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$RoiID
dat.counts$cellType <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum



clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$RoiID),]
clinical.data$imageID <- clinical.data$RoiID
phenoData <- clinical.data[clinical.data$RoiID %in% unique(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]$RoiID),]
cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo")
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

#Grade
spicyTest <- spicy(cellExp, 
                   condition = "Grade", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_Grade.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))
topPairs(spicyTest)

ggsave(plot=p, file=file.path(wd, "plots","spicyR_AC_Grade.pdf"))
 
 
#Relapse
spicyTest <- spicy(cellExp, 
                   condition = "Relapse", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_Relapse.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_Relapse.pdf"))
 
 #NeoAdj
spicyTest <- spicy(cellExp, 
                   condition = "NeoAdj", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_NeoAdj.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_AC_NeoAdj.pdf"))
 
 #LN.Met
spicyTest <- spicy(cellExp, 
                   condition = "LN.Met", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_LNMet.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_AC_LNMet.pdf"))
 
#Dist.Met
spicyTest <- spicy(cellExp, 
                   condition = "Dist.Met", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_DistMet.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_AC_DistMet.pdf"))
 
#Radio
spicyTest <- spicy(cellExp, 
                   condition = "Radio", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_Radio.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_AC_Radio.pdf"))
 
#Chemo
spicyTest <- spicy(cellExp, 
                   condition = "Chemo", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_AC_Chemo.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_AC_Chemo.pdf"))
 
 
```

```{r Dist.Met AC, fig.width=12, fig.height=12}
all.sce_pat.roi$Grade[is.na(all.sce_pat.roi$Grade)]<-"NA"

#sub_sce <- all.sce_pat.roi[,all.sce_pat.roi$Grade=="2"|
#                             all.sce_pat.roi$Grade=="3"]
dat.counts <-as.data.frame(t((assay(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Center_Y
dat.counts$imageID <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID
dat.counts$cellType <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum



clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$RoiID),]
clinical.data$imageID <- clinical.data$RoiID
phenoData <- clinical.data[clinical.data$RoiID %in% unique(all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID),]
cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo")
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

#Grade
spicyTest <- spicy(cellExp, 
                   condition = "Grade", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_Grade.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))
topPairs(spicyTest)

ggsave(plot=p, file=file.path(wd, "plots","spicyR_SCQ_Grade.pdf"))
 
 
#Relapse
spicyTest <- spicy(cellExp, 
                   condition = "Relapse", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_Relapse.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_Relapse.pdf"))
 
 #NeoAdj
spicyTest <- spicy(cellExp, 
                   condition = "NeoAdj", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_NeoAdj.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_SCQ_NeoAdj.pdf"))
 
 #LN.Met
spicyTest <- spicy(cellExp, 
                   condition = "LN.Met", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_LNMet.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_SCQ_LNMet.pdf"))
 
#Dist.Met
spicyTest <- spicy(cellExp, 
                   condition = "Dist.Met", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_DistMet.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_SCQ_DistMet.pdf"))
 
#Radio
spicyTest <- spicy(cellExp, 
                   condition = "Radio", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_Radio.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_SCQ_Radio.pdf"))
 
#Chemo
spicyTest <- spicy(cellExp, 
                   condition = "Chemo", 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", "spicyR_SCQ_Chemo.rds"))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(all.sce_pat.roi$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots","spicyR_SQC_Chemo.pdf"))
 

```

```{r}
#all prop
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

sub_sce <- all.sce_pat.roi
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
  
dat.counts <-as.data.frame(t((assay(sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y
dat.counts$imageID <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID
dat.counts$cellType <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat
caf_groups <- df %>% select(-c(Patient_ID, X)) %>% colnames()

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used

phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- df %>% select(-c(Patient_ID, X)) %>% colnames()
caf_groups <- c("IDO_CAF_G","PDPN_CAF_G")
for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = paste(i), 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("spicyR_",i,"all_prop.rds")))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots",paste0("spicyR_",i,"_all_prop.pdf")))
}


#sqc prop
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Squamous cell carcinoma.csv"))
sub_sce <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
dat.counts <-as.data.frame(t((assay(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce[,sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y
dat.counts$imageID <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID
dat.counts$cellType <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


caf_groups <- df %>% select(-c(Patient_ID, X)) %>% colnames()

clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$RoiID),]
clinical.data$imageID <- clinical.data$RoiID

dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- df %>% select(-c(Patient_ID, X)) %>% colnames()

for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = i, 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("spicyR_",i,"_SQC_prop.rds")))

pdf(file=file.path(wd, "plots",paste0("spicyR_",i,"_SQC_prop.pdf")))
signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$tcell_subtype))))

dev.off()
}



#ac prop
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Adenocarcinoma.csv"))

sub_sce <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
  
dat.counts <-as.data.frame(t((assay(sub_sce[, sub_sce$DX.name=="Adenocarcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce[,sub_sce$DX.name=="Adenocarcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$Center_Y
dat.counts$imageID <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$RoiID
dat.counts$cellType <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- df %>% select(-c(Patient_ID, X)) %>% colnames()

for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = paste(i), 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("spicyR_",i,"_AC_prop.rds")))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots",paste0("spicyR_",i,"_AC_prop.pdf")))
}

#all density

#ddensity

df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
mCAF_low_PID <-df[df$mCAF_G =="mCAF low"|df$mCAF_G =="mCAF high",]$Patient_ID
#sub_sce <- all.sce_pat.roi
sub_sce <- all.sce[,all.sce$Patient_ID %in% mCAF_low_PID]
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
#cur_DF$mCAF_G[is.na(cur_DF$mCAF_G)] <- "NA"
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

#sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
sub_sce <- sub_sce[,sub_sce$Patient_ID %in% mCAF_low_PID]

dat.counts <-as.data.frame(t((assay(sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y
dat.counts$imageID <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID
dat.counts$cellType <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"| sub_sce$DX.name=="Squamous cell carcinoma"]$cell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat
caf_groups <- df %>% select(-c(Patient_ID, X,hypoxic_tpCAF_G)) %>% colnames()

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used

phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- df %>% select(-c(Patient_ID, X,hypoxic_tpCAF_G)) %>% colnames()
#here
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))

sub_sce <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"| all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
  
dat.counts <-as.data.frame(t((assay(sub_sce,"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce$Center_Y
dat.counts$imageID <- sub_sce$RoiID
dat.counts$cellType <- sub_sce$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- c("iCAF_G","vCAF_G","dCAF_G","tpCAF_G","hypoxic_CAF_G","Collagen_CAF_G","PDPN_CAF_G","SMA_CAF_G","IDO_CAF_G")
for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = paste(i), 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("NEWspicyR_",i,"all_tumour.rds")))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$cell_subtype))))
p
 ggsave(plot=p, file=file.path(wd, "plots",paste0("NEWspicyR_",i,"_all_tumour.pdf")))
}

caf_groups <-"mCAF_G"

for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = paste(i), 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("spicyR_",i,"all_mCAF_low_density.rds")))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$cell_subtype))))
p
 ggsave(plot=p, file=file.path(wd, "plots",paste0("spicyR_",i,"_all_mCAF_low_density.pdf")))
}

#sqc density
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_density_split_Squamous cell carcinoma.csv"))
sub_sce <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Squamous cell carcinoma"]
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
  
dat.counts <-as.data.frame(t((assay(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce[,sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$Center_Y
dat.counts$imageID <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID
dat.counts$cellType <- sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used

phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- df %>% select(-c(Patient_ID, X,hypoxic_tpCAF_G)) %>% colnames()

for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = paste(i), 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("spicyR_",i,"_SQC_density.rds")))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots",paste0("spicyR_",i,"_SQC_density.pdf")))
}


#ac density
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Adenocarcinoma.csv"))

sub_sce <- all.sce_pat.roi[, all.sce_pat.roi$DX.name=="Adenocarcinoma"]
cur_DF <- as_tibble(colData(sub_sce)) %>% left_join(df, by = "Patient_ID") %>% DataFrame()
all.equal(paste(cur_DF$ImageNumber, cur_DF$CellNumber), paste(sub_sce$ImageNumber, sub_sce$CellNumber))

sub_sce <- sub_sce[,sub_sce$Patient_ID %in% df$Patient_ID]
  
dat.counts <-as.data.frame(t((assay(sub_sce[, sub_sce$DX.name=="Adenocarcinoma"],"c_counts_asinh_scaled"))))
dat.counts$cellID <- rownames(dat.counts)

colnames(dat.counts)
dat.counts$MPO <- dat.counts$`Myeloperoxidase (MPO)`
dat.counts$IDO <- dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)`
dat.counts$CA9 <- dat.counts$`Carbonic Anhydrase IX`
dat.counts$CD45 <- dat.counts$`CD45RA + CD45R0`
dat.counts$CD248 <- dat.counts$`CD248 / Endosialin`
dat.counts$p75 <- dat.counts$`p75 (CD271)`
dat.counts$panCK <- dat.counts$`Pan Cytokeratin + Keratin Epithelial`
dat.counts$vWF <- dat.counts$`vWF + CD31`
dat.counts$LYVE1 <- dat.counts$`LYVE-1`
dat.counts$ki67 <- dat.counts$`Ki-67`
dat.counts$Collagen <- dat.counts$`Collagen I + Fibronectin`
dat.counts$HLADR <- dat.counts$`HLA-DR`
dat.counts$TCF17 <- dat.counts$`TCF1/TCF7`
dat.counts$Cdh6 <- dat.counts$`Cadherin-6`
dat.counts$Cdh11 <- dat.counts$`Cadherin-11`
dat.counts$PD1 <- dat.counts$`CD279 (PD-1)`
dat.counts$PDGFRb <- dat.counts$`PDGFR-b`
dat.counts$Cav1 <- dat.counts$`Caveolin-1`
dat.counts$Iridium191 <- dat.counts$Iridium_191
dat.counts$Iridium193 <- dat.counts$Iridium_193
dat.counts$Histone <- dat.counts$`Histone H3`
dat.counts$FSP <- dat.counts$`FSP1 / S100A4`

dat.counts$`Myeloperoxidase (MPO)` <- NULL
dat.counts$`Indoleamine 2- 3-dioxygenase (IDO)` <- NULL
dat.counts$`Carbonic Anhydrase IX` <- NULL
dat.counts$`CD45RA + CD45R0` <- NULL
dat.counts$`CD248 / Endosialin` <- NULL
dat.counts$`p75 (CD271)` <- NULL
dat.counts$`Pan Cytokeratin + Keratin Epithelial` <- NULL
dat.counts$`vWF + CD31` <- NULL
dat.counts$`LYVE-1` <- NULL
dat.counts$`Ki-67` <- NULL
dat.counts$`Collagen I + Fibronectin` <- NULL
dat.counts$`HLA-DR` <- NULL
dat.counts$`TCF1/TCF7` <- NULL
dat.counts$`Cadherin-6` <- NULL
dat.counts$`Cadherin-11` <- NULL
dat.counts$`CD279 (PD-1)` <- NULL
dat.counts$`PDGFR-b` <- NULL
dat.counts$`Caveolin-1` <- NULL
dat.counts$Iridium_191 <- NULL
dat.counts$Iridium_193 <- NULL
dat.counts$`Histone H3` <- NULL
dat.counts$`FSP1 / S100A4` <-NULL

colnames(dat.counts) <- paste("Intensity_Mean", colnames(dat.counts), sep = "_")
dat.counts$cellID <- dat.counts$Intensity_Mean_cellID
dat.counts$Intensity_Mean_cellID <-NULL
dat.counts$AreaShape_Center_X <- sub_sce[,sub_sce$DX.name=="Adenocarcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$Center_Y

dat.counts$AreaShape_Center_X <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$Center_X
dat.counts$AreaShape_Center_Y <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$Center_Y
dat.counts$imageID <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$RoiID
dat.counts$cellType <- sub_sce[, sub_sce$DX.name=="Adenocarcinoma"]$tcell_subtype

cellExp <- SegmentedCells(dat.counts, cellProfiler = TRUE)
cellSum <- cellSummary(cellExp)
cellSummary(cellExp) <- cellSum


dat <- cur_DF %>% data.frame()
dat = dat[!duplicated(dat$RoiID),]
dat$imageID <- dat$RoiID

#phenoData <- clinical.data[clinical.data$RoiID %in% unique(sub_sce[, sub_sce$DX.name=="Squamous cell carcinoma"]$RoiID),]
phenoData <- dat

cols <- c("DX.name", "Grade", "Stage", "T.new","M.new","N","Relapse","Smok","LN.Met","Dist.Met","NeoAdj","Gender","Radio","Chemo",paste(caf_groups))
phenoData[cols] <- lapply(phenoData[cols], factor)  ## as.factor() could also be used


phenoData <- DataFrame(phenoData)
imagePheno(cellExp) <- phenoData

caf_groups <- df %>% select(-c(Patient_ID, X,hypoxic_tpCAF_G)) %>% colnames()

for(i in caf_groups){
spicyTest <- spicy(cellExp, 
                   condition = paste(i), 
                   subject = "Patient_ID")#

saveRDS(spicyTest, file = file.path(wd, "sce_objects","Distances", paste0("spicyR_",i,"_AC_density.rds")))

 p <-signifPlot(spicyTest, 
           breaks=c(-3, 3, 0.5),
           marksToPlot = c(paste(unique(sub_sce$tcell_subtype))))

 ggsave(plot=p, file=file.path(wd, "plots",paste0("spicyR_",i,"_AC_density.pdf")))
}

```




#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=6, warning=F, message=F,echo=F}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
df$X <-NULL
  
colData(all.sce_pat.roi)<-as.data.frame(colData(all.sce_pat.roi)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(all.sce_pat.roi))
#if necessary: change group_id labels

dat <-left_join(dat, df, by="Patient_ID")
#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)


caf_groups <- colnames(df[,-1])
category <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met",caf_groups)

#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_subtype"

plot_list <- list()
for (i in category) {
  #for(k in unique(dat$DX.name)){
   # dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list(cell_subtype=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  #}
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_Fibro_n_over_",i,".pdf")))
  #gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()
```