---
title: "R Notebook"
output: html_notebook
---


```{r}
wd <- dirname(getwd())
data_folder <- file.path(wd, "sce_objects", "Revisions")
plot_folder <- file.path(wd,"plots","Revisions")
```

```{r, load and set up data}

all.new <- readRDS("~/data/central_nas/projects/CAF_lung/NSCLC_NEW/sce_objects/final objects with categories/FINAL/FINAL_All_Clustered_FILTERED_inc_tumour_vessel_immune_CAF_Other_new.rds")

fibro.sce <- readRDS("~/data/central_nas/projects/CAF_lung/NSCLC_NEW/sce_objects/final objects with categories/FINAL/FIBRO_CLINICAL-DATA_FILTERED.rds")
all.new$cell_type%>% unique
all.new$hypox_normx <- ifelse(all.new$cell_subtype=="hypoxic" |all.new$cell_type=="hypoxic_CAF"|all.new$cell_type=="hypoxic_tpCAF", "hypoxic","normoxic")
table(all.new$cell_type, all.new$hypox_normx)

table(all.new$hypox_normx)
```

```{r}
#clinical.data <-as.data.frame(colData(immune.sce))

clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]
clinical.data$X <-NULL
clinical.data$X.1 <-NULL
head(clinical.data)
table(clinical.data$Chemo3)
```


```{r}
clinical.data$Relapse <- ifelse(clinical.data$Relapse ==0, "No Relapse","Relapse")
clinical.data$Chemo3 <- ifelse(clinical.data$Chemo3 ==0, "No Chemo","Chemo")

table(clinical.data$Relapse, clinical.data$Chemo3)

unique(clinical.data$Chemo3)
```

##proportions
## Patients 
```{r Calculate proportions hypoxia normoxia patients}
#all.new$Patient_ID <-droplevels(all.new$Patient_ID)
#all.new$Patient_ID <-as.factor(all.new$Patient_ID)
all.new$DX.name[is.na(all.new$DX.name)] <- "NA"

tdat_prop <-as.data.frame(table( all.new[, all.new$Patient_ID!="Control"&
                                           all.new$DX.name=="Adenocarcinoma"|
                                           all.new$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            all.new[, all.new$Patient_ID!="Control"&
                                           all.new$DX.name=="Adenocarcinoma"|
                                           all.new$DX.name=="Squamous cell carcinoma"]$hypox_normx))
colnames(tdat_prop)<-c("Patient_ID","Phenotype","n")

tdat_prop <-tdat_prop %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat_prop[is.na(tdat_prop)] <- 0
tdat_prop$Phenotype <-droplevels(tdat_prop$Phenotype)
tdat_prop$Patient_ID <-droplevels(tdat_prop$Patient_ID)

tdat_prop_wide <- pivot_wider(tdat_prop,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_prop_m <-as.matrix(tdat_prop_wide)
rownames(tdat_prop_m)<-tdat_prop_wide$Patient_ID

hc <- hclust(dist(tdat_prop_m[,-1], method="euclidian"),"ward.D2")
tdat_prop_wide$Patient_ID <- factor(tdat_prop_wide$Patient_ID, levels = hc$labels[hc$order])
tdat_prop$Patient_ID <- factor(tdat_prop$Patient_ID, levels = hc$labels[hc$order])

tdat_prop_wide[tdat_prop_wide$normoxic==0,]
colnames(tdat_prop_wide)<-c("Patient_ID","Cells_Hypoxic","Cells_Normoxic")

```



Patient based metaclusters split by metacluster
```{r Plot proportions hypoxia normoxia patients, fig.width=12, fig.height=6}
#Barplot proportions ordered by
p <-ggplot(tdat_prop,aes(x=freq, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")
#plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-Category_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k = 4) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat_prop,aes(x=n, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
##ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_cell_subtype_proportions.pdf")), width=6, height=6)
```

#CAF proportions
## Patients 
## Patients are ordered by hierarchical clustering (euclidian, wards.D2)
```{r  Calculate proportions CAFs patients}
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"

tdat_fibro_prop <-as.data.frame(table( fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                           fibro.sce$DX.name=="Adenocarcinoma"|
                                           fibro.sce$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                           fibro.sce$DX.name=="Adenocarcinoma"|
                                           fibro.sce$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat_fibro_prop)<-c("Patient_ID","Phenotype","n")

tdat_fibro_prop <-tdat_fibro_prop %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat_fibro_prop[is.na(tdat_fibro_prop)] <- 0
tdat_fibro_prop$Phenotype <-droplevels(tdat_fibro_prop$Phenotype)
tdat_fibro_prop$Patient_ID <-droplevels(tdat_fibro_prop$Patient_ID)

tdat_fibro_prop_wide <- pivot_wider(tdat_fibro_prop,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_fibro_prop_m <-as.matrix(tdat_fibro_prop_wide)
rownames(tdat_fibro_prop_m)<-tdat_fibro_prop_wide$Patient_ID

hc <- hclust(dist(tdat_fibro_prop_m[,-1], method="euclidian"),"ward.D2")
tdat_fibro_prop_wide$Patient_ID <- factor(tdat_fibro_prop_wide$Patient_ID, levels = hc$labels[hc$order])
tdat_fibro_prop$Patient_ID <- factor(tdat_fibro_prop$Patient_ID, levels = hc$labels[hc$order])

tdat_fibro_prop_wide
```

Patient based metaclusters split by metacluster
```{r  Barplot proportions CAFs patients fig.width=12, fig.height=6}
#Barplot proportions ordered by
mycol <-c("#1D76B5","#EF7D20","#2CA237","#D6272A","#8F67A9","#8D564C","#D278AF","#7F7F7F","#BCBC20","#34B9C9","#AEC6E8")
p <-ggplot(tdat_fibro_prop,aes(x=freq, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+#scale_fill_tableau("Tableau 20")+
  scale_fill_manual(values=mycol)
plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-Category_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k =4) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat_fibro_prop,aes(x=n, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+#scale_fill_tableau("Tableau 20")+
  theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  scale_fill_manual(values=mycol)
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
#ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_CAF_type_proportions_K4.pdf")), width=12, height=6)
```
```{r, message=FALSE}
tdat_fibro_prop_wide
tdat_fibro_prop_wide_cd <- left_join(tdat_fibro_prop_wide, clinical.data,by = "Patient_ID")

tumour.type<-c("Adenocarcinoma","Squamous cell carcinoma")
for(i in unique(fibro.sce$cell_type)){
  for(j in unique(tumour.type)){
p <-ggscatter(tdat_fibro_prop_wide_cd[tdat_fibro_prop_wide_cd$DX.name==j,], x = paste(i), y = "Size", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = paste(i,"proportion"), ylab = "Size", title=paste("Pearson",i,j, sep=" "))
plot(p)
p <-ggscatter(tdat_fibro_prop_wide_cd[tdat_fibro_prop_wide_cd$DX.name==j,], x = paste(i), y = "Size", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = paste(i,"proportion"), ylab = "Size", title=paste("Spearman",i,j,  sep=" "))
plot(p)
}
}
```

#correlation proportions hypoxia normoxia
```{r Correlate proportions on patient level}

#merge Hypox/Normox CAF density
tdat_prop_fibro_hnx <- left_join(tdat_fibro_prop_wide, tdat_prop_wide)
tdat_prop_fibro_hnx <- left_join(tdat_prop_fibro_hnx, clinical.data.g)
cor(tdat_prop_fibro_hnx[,-1], method="pearson")

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_prop_fibro_hnx[,-1], conf.level = .95) #is this test right?


#plot
corrplot(cor(tdat_prop_fibro_hnx[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))

tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")
method <- c("pearson", "spearman")
for(i in tumour.type){
  for(j in method){
  
  tdat <- tdat_prop_fibro_hnx[tdat_prop_fibro_hnx$DX.name==i, !names(tdat_prop_fibro_hnx) %in% colnames(clinical.data.g)]
  sig <- cor.mtest(tdat, conf.level = .95) #is this test right?

 p <-corrplot(cor(tdat, method=paste(j)),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = paste(j,i, sep=" "),
        mar=c(0,0,3,0)) 
  print(p)
  }
}
#col_fun = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red"))



tumour.type<-c("Adenocarcinoma","Squamous cell carcinoma")
for(i in unique(fibro.sce$cell_type)){
  for(j in unique(tumour.type)){
    for(k in method){
p <-ggscatter(tdat_prop_fibro_hnx[tdat_prop_fibro_hnx$DX.name==j,], x = paste(i), y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = k,
          xlab = paste(i,"proportion"), ylab = "Cells_Hypoxic", title=paste(k,i,j, sep=" "))
plot(p)

p <-ggscatter(tdat_prop_fibro_hnx[tdat_prop_fibro_hnx$DX.name==j,], x = paste(i), y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = k,
          xlab = paste(i,"proportion"), ylab = "Cells_Normoxic", title=paste(k,i,j, sep=" "))
plot(p)
}
}
}


library("ggpubr")
ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Hypoxia density")

ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Hypoxia density")

ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Normoxia density")

ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Normoxia density")
```
## Proprotions on the image level
```{r  Calculate normoxia hypoxia on the ROI level}
#all.new$Patient_ID <-droplevels(all.new$Patient_ID)
#all.new$Patient_ID <-as.factor(all.new$Patient_ID)
all.new$DX.name[is.na(all.new$DX.name)] <- "NA"

tdat_prop <-as.data.frame(table( all.new[, all.new$Patient_ID!="Control"&
                                           all.new$DX.name=="Adenocarcinoma"|
                                           all.new$DX.name=="Squamous cell carcinoma"]$RoiID,
                            all.new[, all.new$Patient_ID!="Control"&
                                           all.new$DX.name=="Adenocarcinoma"|
                                           all.new$DX.name=="Squamous cell carcinoma"]$hypox_normx))
colnames(tdat_prop)<-c("RoiID","Phenotype","n")

tdat_prop <-tdat_prop %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat_prop[is.na(tdat_prop)] <- 0
tdat_prop$Phenotype <-droplevels(tdat_prop$Phenotype)
tdat_prop$RoiID <-droplevels(tdat_prop$RoiID)

tdat_prop_wide <- pivot_wider(tdat_prop,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_prop_m <-as.matrix(tdat_prop_wide)
rownames(tdat_prop_m)<-tdat_prop_wide$RoiID

hc <- hclust(dist(tdat_prop_m[,-1], method="euclidian"),"ward.D2")
tdat_prop_wide$RoiID <- factor(tdat_prop_wide$RoiID, levels = hc$labels[hc$order])
tdat_prop$RoiID <- factor(tdat_prop$RoiID, levels = hc$labels[hc$order])

tdat_prop_wide[tdat_prop_wide$normoxic==0,]
colnames(tdat_prop_wide)<-c("RoiID","Cells_Hypoxic","Cells_Normoxic")

```



Patient based metaclusters split by metacluster
```{r  Braplot normoxia hypoxia on the ROI level fig.width=12, fig.height=6}
#Barplot proportions ordered by
p <-ggplot(tdat_prop,aes(x=freq, y=RoiID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")
#plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-Category_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k = 4) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat_prop,aes(x=n, y=RoiID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
##ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_cell_subtype_proportions.pdf")), width=6, height=6)
```

#CAF proportions
## Patients 
## Patients are ordered by hierarchical clustering (euclidian, wards.D2)
```{r  Calculate CAF proportion on the ROI level}
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"

tdat_fibro_prop <-as.data.frame(table( fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                           fibro.sce$DX.name=="Adenocarcinoma"|
                                           fibro.sce$DX.name=="Squamous cell carcinoma"]$RoiID,
                            fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                           fibro.sce$DX.name=="Adenocarcinoma"|
                                           fibro.sce$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat_fibro_prop)<-c("RoiID","Phenotype","n")

tdat_fibro_prop <-tdat_fibro_prop %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat_fibro_prop[is.na(tdat_fibro_prop)] <- 0
tdat_fibro_prop$Phenotype <-droplevels(tdat_fibro_prop$Phenotype)
tdat_fibro_prop$RoiID <-droplevels(tdat_fibro_prop$RoiID)

tdat_fibro_prop_wide <- pivot_wider(tdat_fibro_prop,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_fibro_prop_m <-as.matrix(tdat_fibro_prop_wide)
rownames(tdat_fibro_prop_m)<-tdat_fibro_prop_wide$RoiID

hc <- hclust(dist(tdat_fibro_prop_m[,-1], method="euclidian"),"ward.D2")
tdat_fibro_prop_wide$RoiID <- factor(tdat_fibro_prop_wide$RoiID, levels = hc$labels[hc$order])
tdat_fibro_prop$RoiID <- factor(tdat_fibro_prop$RoiID, levels = hc$labels[hc$order])

tdat_fibro_prop_wide
```

Patient based metaclusters split by metacluster
```{r  Barplot CAF proportions on the ROI level, fig.width=12, fig.height=6}
#Barplot proportions ordered by
mycol <-c("#1D76B5","#EF7D20","#2CA237","#D6272A","#8F67A9","#8D564C","#D278AF","#7F7F7F","#BCBC20","#34B9C9","#AEC6E8")
p <-ggplot(tdat_fibro_prop,aes(x=freq, y=RoiID, fill=Phenotype))+geom_bar(stat="identity")+#scale_fill_tableau("Tableau 20")+
  scale_fill_manual(values=mycol)
plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-Category_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k =4) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat_fibro_prop,aes(x=n, y=RoiID, fill=Phenotype))+geom_bar(stat="identity")+#scale_fill_tableau("Tableau 20")+
  theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  scale_fill_manual(values=mycol)
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
#ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_CAF_type_proportions_K4.pdf")), width=12, height=6)
```

#correlation proportions
```{r Correlate CAFs and Normoxia Hypoxia on the ROI level}
#merge Hypox/Normox CAF density
tdat_prop_fibro_hnx <- left_join(tdat_fibro_prop_wide, tdat_prop_wide)

cor(tdat_prop_fibro_hnx[,-1], method="pearson")

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_prop_fibro_hnx[,-1], conf.level = .95) #is this test right?


#plot
corrplot(cor(tdat_prop_fibro_hnx[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))

#col_fun = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red"))



library("ggpubr")
ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Hypoxia density")

ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Hypoxia density")

ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Normoxia density")

ggscatter(tdat_prop_fibro_hnx, x = "iCAF", y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Normoxia density")
```


###density
```{r  Calculate densities Normoxia hypoxia, message=FALSE, warning=FALSE, echo=FALSE}
tdat_density <-as.data.frame(table(all.new[,all.new$Patient_ID!="Control"&
                                          all.new$DX.name=="Adenocarcinoma"|
                                          all.new$DX.name=="Squamous cell carcinoma"]$RoiID,
                           all.new[,all.new$Patient_ID!="Control"&
                                          all.new$DX.name=="Adenocarcinoma"|
                                          all.new$DX.name=="Squamous cell carcinoma"]$hypox_normx))
colnames(tdat_density)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=all.new$RoiID,
                                "Area"=all.new$Area_px_Core,
                                "Patient_ID"=all.new$Patient_ID,
                                "DX.name"=all.new$DX.name))

  tdat_density <-merge(tdat_density,da,by="RoiID")
  tdat_density <-tdat_density[tdat_density$DX.name=="Adenocarcinoma" | tdat_density$DX.name=="Squamous cell carcinoma",]
  tdat_density <-tdat_density %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat_density$density)

  tdat_density <-tdat_density %>% 
  group_by(RoiID,Phenotype) %>%
  summarise(across(-c(Patient_ID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat_density$density)
  #t <-merge(t, clinical.data, by="Patient_ID")

  #remove super high density outliers (total density >10000)  
 # tdat_density <-tdat_density[ !tdat_density$Patient_ID%in%surv_excl,]

#CAF type distribution over all patients
tdat_density_wide <- pivot_wider(tdat_density,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="density",names_prefix = "")
tdat_density_m <-as.matrix(tdat_density_wide)
rownames(tdat_density_m)<-tdat_density_wide$RoiID


hc <- hclust(dist(tdat_density_m[,-1]),"ward.D2")
#order Patients after clustering results
tdat_density_wide$RoiID <- factor(tdat_density_wide$RoiID, levels = labels(hc))
tdat_density$RoiID <- factor(tdat_density$RoiID, levels = labels(hc))

#tdat_density_wide <-tdat_density_wide[ !tdat_density_wide$Patient_ID%in%surv_excl,]
colnames(tdat_density_wide)<-c("RoiID","Cells_Hypoxic","Cells_Normoxic")



```

## Barplot showing absolute density per patietn coloured by Fibro category together with hierarchical clustering tree coloured by patient metaclusters.
```{r Barolot CAF densities, fig.width=12, fig.height=6, message=FALSE, warning=FALSE, echo=FALSE}
#barolot (sqrt of density)
p <-ggplot(tdat_density,aes(y=sqrt(density),x=RoiID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")#+theme(legend.position = "none")

#barplot total density
p <-ggplot(tdat_density,aes(y=density,x=RoiID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")#+theme(legend.position = "none")


#coloured dendrogram
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k = 8) %>% as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()
pg <-plot_grid(p1,p, align="v", ncol=1)
pg
##ggsave(plot=pg, file=file.path(plot_folder, paste("Barplot_Tcell-Category-Densities_HC_ordered_dendro.pdf")), width=12, height=6)
```

#correlation Density



```{r  Calculate CAF density, message=FALSE, warning=FALSE, echo=FALSE, fig.width=6, fig.height=6}
fibro.sce$NeoAdj <- ifelse(fibro.sce$Chemo==1 |fibro.sce$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"

tdat_fibro_density <-as.data.frame(table(fibro.sce[,fibro.sce$Patient_ID!="Control"&
                                          fibro.sce$DX.name=="Adenocarcinoma"|
                                          fibro.sce$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce[,fibro.sce$Patient_ID!="Control"&
                                          fibro.sce$DX.name=="Adenocarcinoma"|
                                          fibro.sce$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat_fibro_density)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce$RoiID,
                                "Area"=fibro.sce$Area_px_Core,
                                "Patient_ID"=fibro.sce$Patient_ID,
                                "DX.name"=fibro.sce$DX.name))

  tdat_fibro_density <-merge(tdat_fibro_density,da,by="RoiID")
  tdat_fibro_density <-tdat_fibro_density[tdat_fibro_density$DX.name=="Adenocarcinoma" | tdat_fibro_density$DX.name=="Squamous cell carcinoma",]
  tdat_fibro_density <-tdat_fibro_density %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat_fibro_density$density)

tdat_fibro_density <-tdat_fibro_density %>% 
  group_by(RoiID,Phenotype) %>%
  summarise(across(-c(Patient_ID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat_fibro_density$density)
tdat_fibro_density_wide <- pivot_wider(tdat_fibro_density,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="density",names_prefix = "")
```


```{r  Correlations CAF and hypoxic normoxic density, message=FALSE, warning=FALSE, echo=FALSE, fig.width=6, fig.height=6}
#neoadj_roi <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(RoiID) 

#tdat_fibro_density_wide <-tdat_fibro_density_wide[!tdat_fibro_density_wide$RoiID%in% neoadj_roi$RoiID,]
rownames(tdat_fibro_density_wide)<-tdat_fibro_density_wide$RoiID

library(corrplot)
cor(tdat_fibro_density_wide[,-1], method="pearson")
#corrplot(cor(tdat_fibro_density_wide[,-1], method="pearson"), col=rev(brewer.pal(10,"RdBu")))

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_fibro_density_wide[,-1], conf.level = .95) #is this test right?


#plot
corrplot(cor(tdat_fibro_density_wide[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))

#col_fun = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red"))

#pdf(file=file.path(plot_folder, "CAF_density_corrplot_upper.pdf"), width=6, height=6)

corrplot(cor(tdat_fibro_density_wide[,-1], method="pearson"),
         type="upper",
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
        #col=rev(brewer.pal(8,"RdBu")),
        col=rev(COL2('RdBu', 8)),
        method="square",
         pch.col = "white",
         #type="upper",
       #  title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))
#dev.off()

#col=wes_palette("Zissou1", 100, type = "continuous"),

#merge Hypox/Normox CAF density
tdat_fibro_hnx <- left_join(tdat_fibro_density_wide, tdat_density_wide)

cor(tdat_fibro_hnx[,-1], method="pearson")

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_fibro_hnx[,-1], conf.level = .95) #is this test right?


#plot
corrplot(cor(tdat_fibro_hnx[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))

#col_fun = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red"))



library("ggpubr")
ggscatter(tdat_fibro_hnx, x = "iCAF", y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Hypoxia density")

ggscatter(tdat_fibro_hnx, x = "iCAF", y = "Cells_Hypoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Hypoxia density")

ggscatter(tdat_fibro_hnx, x = "iCAF", y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Normoxia density")

ggscatter(tdat_fibro_hnx, x = "iCAF", y = "Cells_Normoxic", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Normoxia density")
```

```{r  Correlations all cells and hypoxic normoxic patch fractions, message=FALSE, warning=FALSE, echo=FALSE, fig.width=6, fig.height=6}
#calculate density of all cells
all.hypox$NeoAdj <- ifelse(all.hypox$Chemo==1 |all.hypox$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
all.hypox$DX.name[is.na(all.hypox$DX.name)] <- "NA"

tdat_all_density <-as.data.frame(table(all.hypox[,all.hypox$Patient_ID!="Control"&
                                          all.hypox$DX.name=="Adenocarcinoma"|
                                          all.hypox$DX.name=="Squamous cell carcinoma"]$RoiID,
                           all.hypox[,all.hypox$Patient_ID!="Control"&
                                          all.hypox$DX.name=="Adenocarcinoma"|
                                          all.hypox$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat_all_density)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=all.hypox$RoiID,
                                "Area"=all.hypox$Area_px_Core,
                                "Patient_ID"=all.hypox$Patient_ID,
                                "DX.name"=all.hypox$DX.name))

  tdat_all_density <-merge(tdat_all_density,da,by="RoiID")
  tdat_all_density <-tdat_all_density[tdat_all_density$DX.name=="Adenocarcinoma" | tdat_all_density$DX.name=="Squamous cell carcinoma",]
  tdat_all_density <-tdat_all_density %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat_all_density$density)

tdat_all_density <-tdat_all_density %>% 
  group_by(RoiID,Phenotype) %>%
  summarise(across(-c(Patient_ID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat_all_density$density)
tdat_all_density_wide <- pivot_wider(tdat_all_density,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

#neoadj_roi <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(RoiID) 

#tdat_all_density_wide <-tdat_all_density_wide[!tdat_all_density_wide$RoiID%in% neoadj_roi$RoiID,]
rownames(tdat_all_density_wide)<-tdat_all_density_wide$RoiID

library(corrplot)
cor(tdat_all_density_wide[,-1], method="pearson")



#plot pearson
sig <- cor.mtest(tdat_all_density_wide[,-1], conf.level = .95,method="pearson") 
pdf(file=file.path(plot_folder, "All_cell_density_corrplot_pearson.pdf"), width=6, height=6)
corrplot(cor(tdat_all_density_wide[,-1], method="pearson"),
         type="upper",
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
        #col=rev(brewer.pal(8,"RdBu")),
        col=rev(COL2('RdBu', 8)),
        method="square",
         pch.col = "white",
         #type="upper",
         title = "Correlation of all celltype densities",
        mar=c(0,0,3,0))
dev.off()

#plot spearman
sig <- cor.mtest(tdat_all_density_wide[,-1], conf.level = .95, method="spearman")

#plot
pdf(file=file.path(plot_folder, "All_cell_density_corrplot_spearman.pdf"), width=6, height=6)

corrplot(cor(tdat_all_density_wide[,-1], method="spearman"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of all celltype densities, spearman",
        mar=c(0,0,3,0))
dev.off()


#merge Hypox/Normox CAF density
tdat_density <- table(all.hypox$hypox_normx, all.hypox$RoiID) %>% prop.table(margin=2) %>%as.data.frame()
tdat_density_wide <- pivot_wider(tdat_density, id_cols="Var2", names_from="Var1", values_from=Freq)
colnames(tdat_density_wide) <- c("RoiID","hypoxic_patch","normoxic_patch")
tdat_density_wide %>% head


tdat_all_hnx <- left_join(tdat_all_density_wide, tdat_density_wide)
tdat_all_hnx%>% head()

cor(tdat_all_hnx[,-1], method="pearson")


#plot pearson PATCH
sig <- cor.mtest(tdat_all_hnx[,-1], conf.level = .95,method="pearson") 
pdf(file=file.path(plot_folder, "All_cell_density_patches_corrplot_pearson.pdf"), width=6, height=6)
corrplot(cor(tdat_all_hnx[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities, patch fraction, pearson",
        mar=c(0,0,3,0))
dev.off()


#plot spearman PATCH
sig <- cor.mtest(tdat_all_hnx[,-1], conf.level = .95, method="spearman")
pdf(file=file.path(plot_folder, "All_cell_density_patches_corrplot_spearman.pdf"), width=6, height=6)
corrplot(cor(tdat_all_hnx[,-1], method="spearman"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities, patch fraction, spearman",
        mar=c(0,0,3,0))
dev.off()


library("ggpubr")
pdf(file=file.path(plot_folder, "iCAF_hypoxicPATCH_pearson-correlation.pdf"), width=6, height=6)
ggscatter(tdat_all_hnx, x = "iCAF", y = "hypoxic_patch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Fraction hypoxic patch")
dev.off()

pdf(file=file.path(plot_folder, "iCAF_hypoxicPATCH_spearman-correlation.pdf"), width=6, height=6)
ggscatter(tdat_all_hnx, x = "iCAF", y = "hypoxic_patch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Fraction hypoxic patch")
dev.off()

pdf(file=file.path(plot_folder, "iCAF_normoxicPATCH_pearson-correlation.pdf"), width=6, height=6)
ggscatter(tdat_all_hnx, x = "iCAF", y = "normoxic_patch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "iCAF density", ylab = "Fraction normoxic patch")
dev.off()

pdf(file=file.path(plot_folder, "iCAF_normoxicPATCH_spearman-correlation.pdf"), width=6, height=6)
ggscatter(tdat_all_hnx, x = "iCAF", y = "normoxic_patch", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "spearman",
          xlab = "iCAF density", ylab = "Fraction normoxic patch")
dev.off()

```





```{r Hypoxic and notmoxic defined cells masks, fig.width=50, fig.height=50}
library(cytomapper)
path.to.images <- file.path("~/data/central_nas/projects/CAF_lung/NSCLC_NEW/cells_mask_87A")
all_masks <- loadImages(path.to.images, pattern = "2020121_LC_NSCLC_TMA_87_A") 
mcols(all_masks)$ImageNb <- c("1" ,"10","100","102", "104","105","106","107","108","109", "11","110","111","112","114","115","116","117","118","119","12","121","122" ,"123", "124" ,"125", "126", "127", "128" ,"129" ,"13" , "130" ,"131" ,"132" ,"133" ,"134" ,"135" ,"137", "138", "14" , "15" , "16" , "17" , "18" , "19"  ,"2"   ,"20"  ,"21"  ,"22"  ,"23" , "24" , "25" , "26" , "27" , "28"  ,"29" , "3"  , "30"  ,"31"  ,"32"  ,"33"  ,"34"  ,"36",  "37" , "38" , "39" , "4" ,  "40"  ,"41" , "42" , "43"  ,"44"  ,"45"  ,"46"  ,"47"  ,"48" , "5"  , "50" , "51" , "52" , "53",  "54"  ,"55"  ,"56" , "57"  ,"58" , "59" , "6"   ,"60" , "61" , "63" , "64"  ,"65" , "66" , "67"  ,"68" , "69" , "7" ,  "70" , "71",  "72" , "73" ,"74"  ,"75" , "76" , "77",  "78" , "79" , "8"  , "80"  ,"81"  ,"82"  ,"83" , "85",  "86" , "87"  ,"88" , "89" , "9"   ,"90"  ,"91" , "92" , "93" ,"94"  ,"95"  ,"96" , "97"  ,"98"  ,"99" )
#mcols(all_masks)$ImageNb <- c(ac_sub$ImageNb)
head(unique(as.numeric(all_masks[[1]])))
all_masks <- scaleImages(all_masks, 2^16-1)

tma87 <- all.new[, all.new$TMA=="87A"]
tma87 <- all.pat.roi[, all.pat.roi$TMA=="87A"]
tma87 <- all.sce[, all.sce$TMA=="87A"]

tma87$ImageNb <- tma87$acID


#pdf(file=file.path("/mnt/lena_processed2/NSCLC_NEW/plots_cytomapper","panCK_SMA expression_87A_allCells_Categorised.pdf"), width=20, height=20)
p1<-plotCells(all_masks, object = tma87,
            img_id = "ImageNb", cell_id = "CellNumber",
            colour_by = c("Pan Cytokeratin + Keratin Epithelial","SMA"),
            exprs_values = "c_counts_asinh_scaled", return_plot = TRUE)
#dev.off()

#pdf(file=file.path("/mnt/lena_processed2/NSCLC_NEW/plots_cytomapper","87A_allCells_Categorised.pdf"), width=20, height=20)
p2 <-plotCells(all_masks, object = tma87,
            img_id = "ImageNb", cell_id = "CellNumber",
            colour_by = "cell_category",
            colour = list(cell_category = c("Tumour"="red","Immune"="blue","T cell"="blue","vessel"="yellow", "Fibroblast"="green")), return_plot = TRUE)
#dev.off()

#pdf(file=file.path("/mnt/lena_processed2/NSCLC_NEW/plots_cytomapper","87A_tumour_stroma_Masks.pdf"), width=20, height=20)

p3 <-plotCells(all_masks, object = tma87,
            img_id = "ImageNb", cell_id = "CellNumber",
            colour_by = "Mask",
            colour = list(Mask = c("tumour"="red","stroma"="green")), return_plot = TRUE)
#dev.off()

pdf(file=file.path("~/data/central_nas/projects/CAF_lung/RAW/NSCLC_TMA/ImcSegmentationPipeline/analysis/target_tiffs/plots","87A_allCells_Categorised_hypoxic-normoxic.pdf"), width=20, height=20)

p3 <-plotCells(all_masks, object = tma87,
            img_id = "ImageNb", cell_id = "CellNumber",
            colour_by = "hypox_normx",
            colour = list(hypox_normx = c("hypoxic"="red","normoxic"="green")), return_plot = TRUE)
dev.off()
```


```{r Patch detection normo, fig.width=30, fig.height=10}
tma87 <- all.hypox[, all.hypox$TMA=="87A"]
test.sce <- tma87[, tma87$acID==71|tma87$acID==72 | tma87$acID==73]

test.sce <- buildSpatialGraph(test.sce, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))

pdf(file=file.path(plot_folder, "Hypox_normox_cells_graph_noedges.pdf"), width=30, height=10)
plotSpatial(test.sce,
            img_id = "ImageNumber",
            node_color_by = "cell_category",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = F,
            scales = "free",
            coords=c("Center_X","Center_Y"),
            ncols=3,
            edge_color_fix="grey")
dev.off()

plotSpatial(test.sce,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

pdf(file=file.path(plot_folder, "Hypox_normox_cells_graph_CAIX.pdf"), width=30, height=10)
plotSpatial(test.sce, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"),
            ncol=3)
dev.off()


test.sce <- patchDetection(test.sce, 
                              patch_cells = test.sce$cell_category == "Immune",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

pdf(file=file.path(plot_folder, "Hypox_normox_cells_graph_patchID.pdf"), width=30, height=10)
plotSpatial(test.sce, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"),
            ncol=3)+guides(color="none")
dev.off()

test.sce$patch_id[is.na(test.sce$patch_id)] <- "NA"

test.sce$immune_patch <- ifelse(test.sce$patch_id=="NA","immune_patch","non_immune_patch")


pdf(file=file.path(plot_folder, "Hypox_normox_cells_graph_patch-hyp-norm.pdf"), width=30, height=10)
plotSpatial(test.sce, 
            img_id = "ImageNumber", 
            node_color_by = "immune_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"),
            ncol=3)+guides(color="none")
dev.off()







#KNN
test.sce <- buildSpatialGraph(test.sce, img_id = "ImageNumber",
                                 type = "knn",
                                 k = 3,
                              coords=c("Center_X","Center_Y"))

plotSpatial(test.sce,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            node_shape_by = "ImageNumber",
            node_size_by = "Area",
            #draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))


plotSpatial(test.sce, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = TRUE,
            colPairName = "knn_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))



test.sce <- patchDetection(test.sce, 
                              patch_cells = test.sce$hypox_normx == "hypoxic",
                              colPairName = "knn_interaction_graph",
                              expand_by = 1, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"))

plotSpatial(test.sce.e, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")

plotSpatial(test.sce, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))
```

#tma87A
```{r, fig.width=50, fig.height=50}
tma87A <- all.new[, all.new$TMA =="87A"]
tma87A <- buildSpatialGraph(tma87A, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma87A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87A, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma87A <- patchDetection(tma87A, 
                              patch_cells = tma87A$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma87A$patch_id[is.na(tma87A$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma87A_CAIX_expression.pdf"))

plotSpatial(tma87A, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma87A_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma87A,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma87A_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma87A, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma87A$hypox_patch <- ifelse(tma87A$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma87A_A_hypoxicPATCH.pdf"))
plotSpatial(tma87A, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma87A, file=file.path(data_folder, "tma87A_hypoxia.rds"))
rm(tma87A)
```



#tma87B
```{r, fig.width=50, fig.height=50}
tma87B <- all.new[, all.new$TMA =="87B"]
tma87B <- buildSpatialGraph(tma87B, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma87B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87B, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma87B <- patchDetection(tma87B, 
                              patch_cells = tma87B$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma87B$patch_id[is.na(tma87B$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma87B_CAIX_expression.pdf"))

plotSpatial(tma87B, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma87B_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma87B,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma87B_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma87B, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma87B$hypox_patch <- ifelse(tma87B$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma87B_A_hypoxicPATCH.pdf"))
plotSpatial(tma87B, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma87B, file=file.path(data_folder, "tma87B_hypoxia.rds"))
rm(tma87B)
```


#tma87C
```{r, fig.width=50, fig.height=50}
tma87C <- all.new[, all.new$TMA =="87C"]
tma87C <- buildSpatialGraph(tma87C, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma87C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87C, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma87C <- patchDetection(tma87C, 
                              patch_cells = tma87C$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma87C$patch_id[is.na(tma87C$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma87C_CAIX_expression.pdf"))

plotSpatial(tma87C, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma87C_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma87C,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma87C_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma87C, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma87C$hypox_patch <- ifelse(tma87C$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma87C_A_hypoxicPATCH.pdf"))
plotSpatial(tma87C, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma87C, file=file.path(data_folder, "tma87C_hypoxia.rds"))
rm(tma87C)
```



#tma86
#tma86A
```{r, fig.width=50, fig.height=50}
tma86A <- all.new[, all.new$TMA =="86A"]
tma86A <- buildSpatialGraph(tma86A, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma86A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma86A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma86A, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma86A <- patchDetection(tma86A, 
                              patch_cells = tma86A$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma86A$patch_id[is.na(tma86A$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma86A_CAIX_expression.pdf"))

plotSpatial(tma86A, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma86A_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma86A,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma86A_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma86A, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma86A$hypox_patch <- ifelse(tma86A$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma86A_A_hypoxicPATCH.pdf"))
plotSpatial(tma86A, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma86A, file=file.path(data_folder, "tma86A_hypoxia.rds"))
rm(tma86A)
```



#tma86B
```{r, fig.width=50, fig.height=50}
tma86B <- all.new[, all.new$TMA =="86B"]
tma86B <- buildSpatialGraph(tma86B, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma86B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma86B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma86B, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma86B <- patchDetection(tma86B, 
                              patch_cells = tma86B$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma86B$patch_id[is.na(tma86B$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma86B_CAIX_expression.pdf"))

plotSpatial(tma86B, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma86B_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma86B,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma86B_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma86B, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma86B$hypox_patch <- ifelse(tma86B$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma86B_A_hypoxicPATCH.pdf"))
plotSpatial(tma86B, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma86B, file=file.path(data_folder, "tma86B_hypoxia.rds"))
rm(tma86B)
```


#tma86C
```{r, fig.width=50, fig.height=50}
tma86C <- all.new[, all.new$TMA =="86C"]
tma86C <- buildSpatialGraph(tma86C, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma86C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma86C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma86C, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma86C <- patchDetection(tma86C, 
                              patch_cells = tma86C$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma86C$patch_id[is.na(tma86C$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma86C_CAIX_expression.pdf"))

plotSpatial(tma86C, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma86C_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma86C,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma86C_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma86C, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma86C$hypox_patch <- ifelse(tma86C$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma86C_A_hypoxicPATCH.pdf"))
plotSpatial(tma86C, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma86C, file=file.path(data_folder, "tma86C_hypoxia.rds"))
rm(tma86C)
```

#tma88
#tma88A
```{r, fig.width=50, fig.height=50}
tma88A <- all.new[, all.new$TMA =="88A"]
tma88A <- buildSpatialGraph(tma88A, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma88A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma88A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma88A, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma88A <- patchDetection(tma88A, 
                              patch_cells = tma88A$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma88A$patch_id[is.na(tma88A$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma88A_CAIX_expression.pdf"))

plotSpatial(tma88A, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma88A_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma88A,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma88A_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma88A, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma88A$hypox_patch <- ifelse(tma88A$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma88A_A_hypoxicPATCH.pdf"))
plotSpatial(tma88A, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma88A, file=file.path(data_folder, "tma88A_hypoxia.rds"))
rm(tma88A)
```



#tma88B
```{r, fig.width=50, fig.height=50}
tma88B <- all.new[, all.new$TMA =="88B"]
tma88B <- buildSpatialGraph(tma88B, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma88B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma88B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma88B, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma88B <- patchDetection(tma88B, 
                              patch_cells = tma88B$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma88B$patch_id[is.na(tma88B$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma88B_CAIX_expression.pdf"))

plotSpatial(tma88B, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma88B_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma88B,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma88B_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma88B, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma88B$hypox_patch <- ifelse(tma88B$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma88B_A_hypoxicPATCH.pdf"))
plotSpatial(tma88B, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma88B, file=file.path(data_folder, "tma88B_hypoxia.rds"))
rm(tma88B)
```


#tma88C
```{r, fig.width=50, fig.height=50}
tma88C <- all.new[, all.new$TMA =="88C"]
tma88C <- buildSpatialGraph(tma88C, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma88C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma88C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma88C, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma88C <- patchDetection(tma88C, 
                              patch_cells = tma88C$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma88C$patch_id[is.na(tma88C$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma88C_CAIX_expression.pdf"))

plotSpatial(tma88C, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma88C_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma88C,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma88C_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma88C, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma88C$hypox_patch <- ifelse(tma88C$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma88C_A_hypoxicPATCH.pdf"))
plotSpatial(tma88C, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma88C, file=file.path(data_folder, "tma88C_hypoxia.rds"))
rm(tma88C)
```

#tma175
#tma175A
```{r, fig.width=50, fig.height=50}
tma175A <- all.new[, all.new$TMA =="175A"]
tma175A <- buildSpatialGraph(tma175A, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma175A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma175A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma175A, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma175A <- patchDetection(tma175A, 
                              patch_cells = tma175A$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma175A$patch_id[is.na(tma175A$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma175A_CAIX_expression.pdf"))

plotSpatial(tma175A, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma175A_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma175A,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma175A_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma175A, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma175A$hypox_patch <- ifelse(tma175A$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma175A_A_hypoxicPATCH.pdf"))
plotSpatial(tma175A, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma175A, file=file.path(data_folder, "tma175A_hypoxia.rds"))
rm(tma175A)
```



#tma175B
```{r, fig.width=50, fig.height=50}
tma175B <- all.new[, all.new$TMA =="175B"]
tma175B <- buildSpatialGraph(tma175B, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma175B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma175B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma175B, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma175B <- patchDetection(tma175B, 
                              patch_cells = tma175B$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma175B$patch_id[is.na(tma175B$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma175B_CAIX_expression.pdf"))

plotSpatial(tma175B, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma175B_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma175B,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma175B_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma175B, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma175B$hypox_patch <- ifelse(tma175B$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma175B_A_hypoxicPATCH.pdf"))
plotSpatial(tma175B, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma175B, file=file.path(data_folder, "tma175B_hypoxia.rds"))
rm(tma175B)
```


#tma175C
```{r, fig.width=50, fig.height=50}
tma175C <- all.new[, all.new$TMA =="175C"]
tma175C <- buildSpatialGraph(tma175C, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma175C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma175C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma175C, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma175C <- patchDetection(tma175C, 
                              patch_cells = tma175C$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma175C$patch_id[is.na(tma175C$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma175C_CAIX_expression.pdf"))

plotSpatial(tma175C, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma175C_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma175C,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma175C_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma175C, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma175C$hypox_patch <- ifelse(tma175C$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma175C_A_hypoxicPATCH.pdf"))
plotSpatial(tma175C, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma175C, file=file.path(data_folder, "tma175C_hypoxia.rds"))
rm(tma175C)
```

#tma176
#tma176A
```{r, fig.width=50, fig.height=50}
tma176A <- all.new[, all.new$TMA =="176A"]
tma176A <- buildSpatialGraph(tma176A, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma176A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma176A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma176A, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma176A <- patchDetection(tma176A, 
                              patch_cells = tma176A$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma176A$patch_id[is.na(tma176A$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma176A_CAIX_expression.pdf"))

plotSpatial(tma176A, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma176A_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma176A,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma176A_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma176A, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma176A$hypox_patch <- ifelse(tma176A$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma176A_A_hypoxicPATCH.pdf"))
plotSpatial(tma176A, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma176A, file=file.path(data_folder, "tma176A_hypoxia.rds"))
rm(tma176A)
```



#tma176B
```{r, fig.width=50, fig.height=50}
tma176B <- all.new[, all.new$TMA =="176B"]
tma176B <- buildSpatialGraph(tma176B, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma176B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma176B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma176B, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma176B <- patchDetection(tma176B, 
                              patch_cells = tma176B$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma176B$patch_id[is.na(tma176B$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma176B_CAIX_expression.pdf"))

plotSpatial(tma176B, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma176B_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma176B,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma176B_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma176B, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma176B$hypox_patch <- ifelse(tma176B$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma176B_A_hypoxicPATCH.pdf"))
plotSpatial(tma176B, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma176B, file=file.path(data_folder, "tma176B_hypoxia.rds"))
rm(tma176B)
```


#tma176C
```{r, fig.width=50, fig.height=50}
tma176C <- all.new[, all.new$TMA =="176C"]
tma176C <- buildSpatialGraph(tma176C, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma176C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma176C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma176C, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma176C <- patchDetection(tma176C, 
                              patch_cells = tma176C$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma176C$patch_id[is.na(tma176C$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma176C_CAIX_expression.pdf"))

plotSpatial(tma176C, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma176C_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma176C,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma176C_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma176C, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma176C$hypox_patch <- ifelse(tma176C$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma176C_A_hypoxicPATCH.pdf"))
plotSpatial(tma176C, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma176C, file=file.path(data_folder, "tma176C_hypoxia.rds"))
rm(tma176C)
```

#tma178
#tma178A
```{r, fig.width=50, fig.height=50}
tma178A <- all.new[, all.new$TMA =="178A"]
tma178A <- buildSpatialGraph(tma178A, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma178A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma178A,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma178A, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma178A <- patchDetection(tma178A, 
                              patch_cells = tma178A$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma178A$patch_id[is.na(tma178A$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma178A_CAIX_expression.pdf"))

plotSpatial(tma178A, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma178A_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma178A,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma178A_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma178A, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma178A$hypox_patch <- ifelse(tma178A$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma178A_A_hypoxicPATCH.pdf"))
plotSpatial(tma178A, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma178A, file=file.path(data_folder, "tma178A_hypoxia.rds"))
rm(tma178A)
```



#tma178B
```{r, fig.width=50, fig.height=50}
tma178B <- all.new[, all.new$TMA =="178B"]
tma178B <- buildSpatialGraph(tma178B, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma178B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma178B,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma178B, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma178B <- patchDetection(tma178B, 
                              patch_cells = tma178B$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma178B$patch_id[is.na(tma178B$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma178B_CAIX_expression.pdf"))

plotSpatial(tma178B, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma178B_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma178B,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma178B_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma178B, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma178B$hypox_patch <- ifelse(tma178B$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma178B_A_hypoxicPATCH.pdf"))
plotSpatial(tma178B, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma178B, file=file.path(data_folder, "tma178B_hypoxia.rds"))
rm(tma178B)
```


#tma178C
```{r, fig.width=50, fig.height=50}
tma178C <- all.new[, all.new$TMA =="178C"]
tma178C <- buildSpatialGraph(tma178C, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 15,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma178C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma178C,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma178C, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma178C <- patchDetection(tma178C, 
                              patch_cells = tma178C$hypox_normx == "hypoxic",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=10)

tma178C$patch_id[is.na(tma178C$patch_id)] <- "NA"

pdf(file=file.path(plot_folder,"tma178C_CAIX_expression.pdf"))

plotSpatial(tma178C, img_id = "ImageNumber",
            node_color_by = "Carbonic Anhydrase IX",
            assay_type = "c_counts_asinh_scaled",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            edge_color_by = "hypox_normx",
            coords=c("Center_X","Center_Y"))
dev.off()

pdf(file=file.path(plot_folder,"tma178C_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma178C,
            img_id = "ImageNumber",
            node_color_by = "hypox_normx",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

dev.off()

pdf(file=file.path(plot_folder,"tma178C_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma178C, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()

tma178C$hypox_patch <- ifelse(tma178C$patch_id=="NA","normox_patch","hypoxic_patch")

pdf(file=file.path(plot_folder,"tma178C_A_hypoxicPATCH.pdf"))
plotSpatial(tma178C, 
            img_id = "ImageNumber", 
            node_color_by = "hypox_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
dev.off()
saveRDS(tma178C, file=file.path(data_folder, "tma178C_hypoxia.rds"))
rm(tma178C)
```


```{r}
#TMA86
tma86A <- readRDS(file=file.path(data_folder, "tma86A_hypoxia.rds"))
tma86B <- readRDS(file=file.path(data_folder, "tma86B_hypoxia.rds"))
tma86C <- readRDS(file=file.path(data_folder, "tma86C_hypoxia.rds"))

tma86.hypox <- cbind(tma86A, tma86B, tma86C)
rm(tma86A, tma86B, tma86C)
saveRDS(tma86.hypox, file=file.path(data_folder, "all_tma86_hypoxia.rds"))

#TMA87
tma87A <- readRDS(file=file.path(data_folder, "tma87A_hypoxia.rds"))
tma87B <- readRDS(file=file.path(data_folder, "tma87B_hypoxia.rds"))
tma87C <- readRDS(file=file.path(data_folder, "tma87C_hypoxia.rds"))

tma87.hypox <- cbind(tma87A, tma87B, tma87C)
saveRDS(tma87.hypox, file=file.path(data_folder, "all_tma87_hypoxia.rds"))

rm(tma87A, tma87B, tma87C)

#TMA88
tma88A <- readRDS(file=file.path(data_folder, "tma88A_hypoxia.rds"))
tma88B <- readRDS(file=file.path(data_folder, "tma88B_hypoxia.rds"))
tma88C <- readRDS(file=file.path(data_folder, "tma88C_hypoxia.rds"))

tma88.hypox <- cbind(tma88A, tma88B, tma88C)
saveRDS(tma88.hypox, file=file.path(data_folder, "all_tma88_hypoxia.rds"))

rm(tma88A, tma88B, tma88C)

#all 80s TMA
tma80.hypox <- cbind(tma86.hypox,
                      tma87.hypox,
                      tma88.hypox)
saveRDS(tma80.hypox, file=file.path(data_folder, "all_tma80s_hypoxia.rds"))


#TMA175
tma175A <- readRDS(file=file.path(data_folder, "tma175A_hypoxia.rds"))
tma175B <- readRDS(file=file.path(data_folder, "tma175B_hypoxia.rds"))
tma175C <- readRDS(file=file.path(data_folder, "tma175C_hypoxia.rds"))
dim(tma175A)[2]+dim(tma175B)[2]+dim(tma175C)[2]

tma175.hypox <- cbind(tma175A, tma175B, tma175C)
dim(tma175.hypox)[2]
saveRDS(tma175.hypox, file=file.path(data_folder, "all_tma175_hypoxia.rds"))
rm(tma175A, tma175B, tma175C)

#TMA176
tma176A <- readRDS(file=file.path(data_folder, "tma176A_hypoxia.rds"))
tma176B <- readRDS(file=file.path(data_folder, "tma176B_hypoxia.rds"))
tma176C <- readRDS(file=file.path(data_folder, "tma176C_hypoxia.rds"))
dim(tma176A)[2]+dim(tma176B)[2]+dim(tma176C)[2]

tma176.hypox <- cbind(tma176A, tma176B, tma176C)
dim(tma176.hypox)[2]

saveRDS(tma176.hypox, file=file.path(data_folder, "all_tma176_hypoxia.rds"))
rm(tma176A, tma176B, tma176C)

#TMA178
tma178A <- readRDS(file=file.path(data_folder, "tma178A_hypoxia.rds"))
tma178B <- readRDS(file=file.path(data_folder, "tma178B_hypoxia.rds"))
tma178C <- readRDS(file=file.path(data_folder, "tma178C_hypoxia.rds"))
dim(tma178A)[2]+dim(tma178B)[2]+dim(tma178C)[2]

tma178.hypox <- cbind(tma178A, tma178B, tma178C)
dim(tma178.hypox)[2]

saveRDS(tma178.hypox, file=file.path(data_folder, "all_tma178_hypoxia.rds"))
rm(tma178A, tma178B, tma178C)


tma100.hypox <- cbind(tma175.hypox,
                      tma176.hypox,
                      tma178.hypox)
dim(tma175.hypox)[2]+dim(tma176.hypox)[2]+dim(tma178.hypox)[2]
dim(tma100.hypox)[2]
saveRDS(tma100.hypox, file=file.path(data_folder, "all_tma100s_hypoxia.rds"))
rm(tma175.hypox,tma176.hypox,tma178.hypox)

tma100.hypox <-readRDS(file=file.path(data_folder, "all_tma100s_hypoxia.rds"))
tma80.hypox <-readRDS(file=file.path(data_folder, "all_tma80s_hypoxia.rds"))

all.hypox <- cbind(tma80.hypox,tma100.hypox)
dim(tma80.hypox)[2]+dim(tma100.hypox)[2]
dim(all.hypox)[2]
saveRDS(all.hypox, file=file.path(data_folder, "all_tmas_hypoxia.rds"))
rm(tma80.hypox,tma100.hypox)
```

Differential abundance iCAFs, vCAFs between hypoxia and normoxia
#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=8, fig.height=12, warning=F, message=F,echo=F}
all.hypox <- readRDS(file=file.path(data_folder, "all_tmas_hypoxia.rds"))

#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
  
colData(all.hypox)<-as.data.frame(colData(all.hypox)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(all.hypox))

all.hypox$hypox_patch <- as.factor(all.hypox$hypox_patch )
#if necessary: change group_id labels

#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)

category <-c("hypox_patch")

#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over",i,k,".pdf",sep="_")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes.pdf"))
plot(p)
p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue.pdf"))
plot(p)
```

```{r}
#Cell categories tumuor, immune, fibro, vessel, other
df <- data.frame(all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$CellID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$Compartment,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$cell_subtype,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$DX.name,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$RoiID,
                 all.sce_pat.roi[,all.sce_pat.roi$cell_category=="Fibroblast"]$DX.name)

colnames(df) <- c("CellID","Distance","Celltype","Type","ROI","DX.name")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)

df %>% subset(Celltype=="Tumour") %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))

roi_rem <-df[df$Distance >300,]$ROI %>%unique()

df <-df[!df$ROI %in% roi_rem,]
#+  scale_x_continuous(trans = "log10")

category20 <- c("#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7FFF","#BCBD22","#17BECF","#AEC7E8")

df$Celltype[df$Celltype=="Collagen_CAF"] <- "Collagen CAF"
df$Celltype[df$Celltype=="hypoxic_CAF"] <- "hypoxic CAF"
df$Celltype[df$Celltype=="hypoxic_tpCAF"] <- "hypoxic tCAF"
df$Celltype[df$Celltype=="SMA_CAF"] <- "SMA CAF"
df$Celltype[df$Celltype=="IDO_CAF"] <- "ifnCAF"
df$Celltype[df$Celltype=="PDPN_CAF"] <- "PDPN CAF"
df$Celltype[df$Celltype=="tpCAF"] <- "tCAF"

p <-df%>%#subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="tpCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF")%>%
  ggplot(aes(x=Distance, color=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  scale_colour_tableau()+
  scale_colour_manual(values=as.vector(category20)[1:11])+
 geom_vline(xintercept = 0,color = 'black', linetype="dashed")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~DX.name)
    
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "Distance_CAF_tumourstromaborder_split_by_tumourtype.pdf"), width=12, height=4)

#facet grid growth pattern and CAF type
p <-df%>%#subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="tpCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF")%>%
  ggplot(aes(x=Distance, color=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  scale_colour_tableau()+
  scale_colour_manual(values=as.vector(category20)[1:11])+
 geom_vline(xintercept = 0,color = 'black', linetype="dashed")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_grid(GrowthPattern~DX.name)
    
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "Distance_CAF_tumourstromaborder_split_by_tumourtype.pdf"), width=12, height=4)

```

Differential abundance CAF types and vessel invasion by tumour
#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=6, warning=F, message=F,echo=F,}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)

fibro.sce$age_group <- ifelse(fibro.sce$Age >60,"Over 60","Younger than 60")  
colData(fibro.sce)<-as.data.frame(colData(fibro.sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce))

fibro.sce$Vessel <- as.factor(fibro.sce$Vessel )
#if necessary: change group_id labels

#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)

category <-c("Vessel","Pleura","Age","Dist.Met","LN.Met", "Relapse")

#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_",i,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_vessel.pdf"))
plot(p)
p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue_vessel.pdf"))
plot(p)
```


```{r}
# clinical.data$Package_year_bin[clinical.data$Nikotin < 20]<- "0-20"
# clinical.data$Package_year_bin[clinical.data$Nikotin > 20 & clinical.data$Nikotin < 40] <- "20-40"
# clinical.data$Package_year_bin[clinical.data$Nikotin > 40 & clinical.data$Nikotin < 60] <- "40-60"
# clinical.data$Package_year_bin[clinical.data$Nikotin > 60 & clinical.data$Nikotin < 80] <- "60-80"
# clinical.data$Package_year_bin[clinical.data$Nikotin > 80 & clinical.data$Nikotin < 100] <- "80-100"
# clinical.data$Package_year_bin[clinical.data$Nikotin > 100 & clinical.data$Nikotin < 200] <- "100-150"
# clinical.data$Package_year_bin[is.na(clinical.data$Nikotin)] <- "NA"
# table(clinical.data$Package_year_bin)

#py
clinical.data$Package_year_bin[clinical.data$Nikotin < 30]<- "0-30"
clinical.data$Package_year_bin[clinical.data$Nikotin > 30 & clinical.data$Nikotin < 60] <- "20-60"
clinical.data$Package_year_bin[clinical.data$Nikotin > 60 & clinical.data$Nikotin < 90] <- "60-90"
clinical.data$Package_year_bin[clinical.data$Nikotin > 90 & clinical.data$Nikotin < 200] <- "90-150"
clinical.data$Package_year_bin[is.na(clinical.data$Nikotin)] <- "NA"
table(clinical.data$Package_year_bin)

#age
clinical.data$age_group[clinical.data$Age < 60]<- "younger than 69"
clinical.data$age_group[clinical.data$Age > 60]<- "older than 69"
table(clinical.data$age_group)


```



## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
#fibro.sce <- readRDS(file=file.path(data_folder, "FINAL_All_Clustered_FILTERED_inc_tumour_vessel_immune_CAF_minusOther.rds"))
#fibro.sce$DX.name <- as.factor(fibro.sce$DX.name)
#fibro.sce$DX.name %>% replace_na("NA")
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"
fibro.sce$DX.name[is.na(fibro.sce$Vessel)] <- "NA"

df <- as.data.frame(colData(fibro.sce[,fibro.sce$Patient_ID!="Control"&
                                          fibro.sce$DX.name=="Adenocarcinoma"|
                                          fibro.sce$DX.name=="Squamous cell carcinoma"]))

#remove neoadj patients
#df <-df[df$NeoAdj =="NoNeoAdjuvantTherapy",]


categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","NeoAdj","Gender","Stage","Relapse")
categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse")
categories <- "NeoCohort"
tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")
#categories <- c("DX.name", "Grade") 
i <- c("metacluster") 

#categories <- "Pleura"
plot_list <- list()

for (i in (categories)) {
  for (k in tumour.type) {
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$Patient_ID!="Control"&
                                          fibro.sce$DX.name==k]))

#remove neoadj patients
#df <-df[df$NeoAdj =="NoNeoAdjuvantTherapy",]

    
    
    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
# pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_",i,"_", k,".pdf")), width=15, height=15)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
    gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))

# dev.off()
 }
}
```


```{r}

clinical.data$NeoAdj[is.na(clinical.data$NeoAdj)] <- "NA"
neo_patients <-clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Patient_ID
clinical.data$Stage[clinical.data$Stage == 1] <-"IA"
clinical.data$Stage[clinical.data$Stage == 2] <-"IB"
clinical.data$Stage[clinical.data$Stage == 3] <-"IIA"
clinical.data$Stage[clinical.data$Stage == 4] <-"IIB"
clinical.data$Stage[clinical.data$Stage == 5] <-"IIIA"
clinical.data$Stage[clinical.data$Stage == 6] <-"IIIB"
clinical.data$Stage[clinical.data$Stage == 7] <-"IV"

neo.df <-data.frame("Patient_ID"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Patient_ID,
           "Chemo"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Chemo,
           "Radio"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Radio,
           "TumourType"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$DX.name,
           "Stage"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Stage,
           "Gender"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Gender,
           "Grade"=clinical.data[clinical.data$NeoAdj=="NeoAdjuvantTherapy",]$Grade
           )

write.csv(neo.df, file=file.path(data_folder, "Patient_ID_neoadjuvant.csv"))

print("Neoadjuvant Stage Distribution")
table(neo.df$Stage) %>% prop.table()*100
table(neo.df$Stage, neo.df$TumourType) #%>% prop.table(margin=2)*100


print("Overall Cohort Stage Distribution")
table(clinical.data$Stage, clinical.data$DX.name) #%>%prop.table(margin=2)*100
```


```{r}

clinical.data[clinical.data$DX.name=="Squamous cell carcinoma"&
                clinical.data$Stage=="IA"&
                clinical.data$Gender==1&
                clinical.data$Grade==2,]$Patient_ID

table(fibro.sce[, fibro.sce$Patient_ID %in% clinical.data[clinical.data$DX.name=="Squamous cell carcinoma"&
                clinical.data$Stage=="IIIB"&
                clinical.data$Gender==1&
                clinical.data$Grade==2,]$Patient_ID]$cell_category,
      fibro.sce[, fibro.sce$Patient_ID %in% clinical.data[clinical.data$DX.name=="Squamous cell carcinoma"&
                clinical.data$Stage=="IIIB"&
                clinical.data$Gender==1&
                clinical.data$Grade==2,]$Patient_ID]$Patient_ID) %>% data.frame() %>% arrange(Freq)

```
```{r}
cohort_check_neo <- read.csv(file=file.path(data_folder,"Patient_ID_neoadjuvant_cohort-check.csv"))
cohort_check_neo <- cohort_check_neo[!cohort_check_neo$Patient_ID=="178_426",] 
cohort_check_neo <- cohort_check_neo[!cohort_check_neo$X==80,]
cohort_check_neo <- cohort_check_neo[!cohort_check_neo$Radio==1,]
fibro.sce$NeoCohort <- "NA"

clinical.data$NeoCohort <- "NA"

clinical.data$NeoCohort[clinical.data$Patient_ID %in% cohort_check_neo$Patient_ID] <-"Neoadjuvant Therapy"
clinical.data$NeoCohort[clinical.data$Patient_ID %in% cohort_check_neo$Selected.reference] <-"Treatment naive"

fibro.sce$NeoCohort[fibro.sce$Patient_ID %in% cohort_check_neo$Patient_ID] <-"Neoadjuvant Therapy"
fibro.sce$NeoCohort[fibro.sce$Patient_ID %in% cohort_check_neo$Selected.reference] <-"Treatment naive"


table(fibro.sce$NeoCohort) 

```

## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce[,fibro.sce$NeoCohort!="NA"]))

categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","NeoAdj","Gender","Stage","Relapse")
categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse")

categories <- "NeoCohort"
tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")


plot_list <- list()

for (i in (categories)) {
  for (k in tumour.type) {
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$NeoCohort!="NA"&
                                          fibro.sce$DX.name==k]))

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=tdat[[i]]))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      scale_colour_manual(values=c("#009FE3","#E6007E"))+
        #scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion ,", k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_minusRadio",i,"_", k,".pdf")), width=12, height=8)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
    gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))

 dev.off()
 }
}
```

#Differential abundance analysis loop   neoCohort
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=4, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
  
colData(fibro.sce)<-as.data.frame(colData(fibro.sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce))

fibro.sce$NeoCohort <- as.factor(fibro.sce$NeoCohort )
#if necessary: change group_id labels

dat <-dat[dat$NeoCohort!="NA",]

category <-c("NeoCohort")
category <-c("NeoAdj")


j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_MINUS RADIO_",i,"_",k,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

#p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes.pdf"))
#plot(p)
#p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue.pdf"))
#plot(p)
```

```{r}
clinical.data$Relapse <- ifelse(clinical.data$Relapse ==0, "No Relapse","Relapse")
clinical.data$Chemo3 <- ifelse(clinical.data$Chemo3 ==0, "No Chemo","Chemo")
clinical.data$Chemo3[is.na(clinical.data$Chemo3)] <- "NA"
clinical.data$Radio4[is.na(clinical.data$Radio4)] <- "NA"
clinical.data$Relapse[is.na(clinical.data$Relapse)] <- "NA"
table(clinical.data$Relapse, clinical.data$Chemo3)


fibro.sce$Relapse <- ifelse(fibro.sce$Relapse ==0, "No Relapse","Relapse")
fibro.sce$Chemo3 <- ifelse(fibro.sce$Chemo3 ==0, "No Chemo","Chemo")
fibro.sce$Radio4 <- ifelse(fibro.sce$Radio4 ==0, "No Radio","Radio")

fibro.sce$Chemo3[is.na(fibro.sce$Chemo3)] <- "NA"
fibro.sce$Radio4[is.na(fibro.sce$Radio4)] <- "NA"
fibro.sce$NeoAdj[is.na(fibro.sce$NeoAdj)] <- "NA"

fibro.sce$Relapse[is.na(fibro.sce$Relapse)] <- "NA"
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"
fibro.sce$NeoAdj[is.na(fibro.sce$NeoAdj)] <- "NA"

```

#Differential abundance analysis loop Chemo relapse  
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=6, warning=F, message=F,echo=F}
library(tidyr)

colData(fibro.sce)<-as.data.frame(colData(fibro.sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce))


dat <-dat[dat$DX.name=="Adenocarcinoma"|
          dat$DX.name=="Squamous cell carcinoma",]
dat <- dat[dat$Relapse!="NA",]
dat <- dat[dat$Chemo3!="Chemo",]
dat <- dat[dat$NeoAdj=="NoNeoAdjuvantTherapy",]

category <-c("NeoCohort")
category <-c("NeoAdj")
category <- c("Relapse")

j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
 }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_inChemo_",i,"_",k,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

#p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes.pdf"))
#plot(p)
#p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue.pdf"))
#plot(p)
```
```{r}
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"

tdat_prop <-as.data.frame(table( fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                             fibro.sce$Chemo3=="Chemo"&
                                           fibro.sce$DX.name=="Adenocarcinoma"|
                                           fibro.sce$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                        fibro.sce$Chemo3=="Chemo"&
                                           fibro.sce$DX.name=="Adenocarcinoma"|
                                           fibro.sce$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat_prop)<-c("Patient_ID","Phenotype","n")

tdat_prop <-tdat_prop %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat_prop[is.na(tdat_prop)] <- 0
tdat_prop$Phenotype <-droplevels(tdat_prop$Phenotype)
tdat_prop$Patient_ID <-droplevels(tdat_prop$Patient_ID)

tdat_prop_wide <- pivot_wider(tdat_prop,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_wide_ct <- left_join(tdat_prop_wide, clinical.data, by="Patient_ID")

neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat,]

#high low by median
surv_dat$Collagen_CAF_G <- ifelse(surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
surv_dat$hypoxic_CAF_G <- ifelse(surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")
surv_dat$mCAF_G <- ifelse(surv_dat$mCAF >summary(surv_dat$mCAF)[3],"mCAF high","mCAF low")
surv_dat$SMA_CAF_G <- ifelse(surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
surv_dat$tpCAF_G <- ifelse(surv_dat$tpCAF >summary(surv_dat$tpCAF)[3],"tpCAF high","tpCAF low")
surv_dat$iCAF_G <- ifelse(surv_dat$iCAF >summary(surv_dat$iCAF)[3],"iCAF high","iCAF low")
surv_dat$vCAF_G <- ifelse(surv_dat$vCAF >summary(surv_dat$vCAF)[3],"vCAF high","vCAF low")
surv_dat$dCAF_G <- ifelse(surv_dat$dCAF >summary(surv_dat$dCAF)[3],"dCAF high","dCAF low")
surv_dat$hypoxic_tpCAF_G <- ifelse(surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
surv_dat$IDO_CAF_G <- ifelse(surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
surv_dat$PDPN_CAF_G <- ifelse(surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")

surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G")

```

```{r  survival Fibro category proportions not split high low, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=5}
#out.width="50%",
for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
  #dat <-surv_dat
  #k="AC & SCC together"
 
#OS
# pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ dat[[i]],data = dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#     abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               #conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               palette = "jco",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_OS over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
# pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ i,data = surv_dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#    abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce[,fibro.sce$NeoCohort!="NA"]))

categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","NeoAdj","Gender","Stage","Relapse")
categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse")
categories <- "Relapse"

tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")


plot_list <- list()

for (i in (categories)) {
  for (k in tumour.type) {
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$Chemo3=="Chemo"&
                                            fibro.sce$Relapse !="NA"&
                                            fibro.sce$NeoAdj=="NoNeoAdjuvantTherapy"&
                                          fibro.sce$DX.name==k]))

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion ,", k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_",i,"_", k,".pdf")), width=15, height=15)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
    gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))

 dev.off()
 }
}
```

```{r}
growth.p <- read.csv(file.path(data_folder, "GrowthPatterns_cleaned up.csv"), header = T)
growth.p %>% head
growth.p$Patient_ID <- paste(growth.p$ZTMA,"_",growth.p$Nr., sep="")
growth.p$GrowthPattern %>% unique

gp_s <- growth.p %>% select(Patient_ID, GrowthPattern)
clinical.data.g <- left_join(clinical.data, gp_s, by="Patient_ID")
clinical.data.g$GrowthPattern[is.na(clinical.data.g$GrowthPattern)] <- "NA"


clinical.data.g[clinical.data.g$NeoAdj =="NeoAdjuvantTherapy"&clinical.data.g$GrowthPattern=="treatment (solid)",]$Patient_ID

gp_s$Patient_ID %>% unique %>% length()
clinical.data.g$Patient_ID %>% unique %>% length()
clinical.data.g$Patient_ID %in% gp_s$Patient_ID %>% table

table(clinical.data.g$GrowthPattern, clinical.data.g$Grade)
table(clinical.data.g$GrowthPattern)

clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="?/aszinär"] <- "aszinär"
clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="cribriform (aszinär)"] <- "aszinär"

clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="aszinär/solid"] <- "solid"
clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="papillär/ solid"] <- "solid"
clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="solid "] <- "solid"
clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="papillär (muszinös)"] <- "papillär"
clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="aszinär cribriform / solid"] <- "solid"

clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="solid/aszinär"&clinical.data.g$Grade==3] <- "solid"
clinical.data.g$GrowthPattern[clinical.data.g$GrowthPattern=="papillär/solid"] <- "solid"
table(clinical.data.g$GrowthPattern, clinical.data.g$Grade)



test <- left_join(clinical.data.g, metacluster)

table(test[test$DX.name=="Adenocarcinoma",]$metacluster, test[test$DX.name=="Adenocarcinoma",]$GrowthPattern)
```


## Kruskal-Wallis / Wilcoxon Fibro category Proportion ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=6, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce[,fibro.sce$NeoCohort!="NA"]))

categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","NeoAdj","Gender","Stage","Relapse")
categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse","GrowthPattern")
#categories <- "GrowthPattern"
categories <- c("Pleura","Vessel", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse","GrowthPattern")


tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")
tumour.type <- c("Adenocarcinoma")
tumour.type <- c("Squamous cell carcinoma")

categories <- c("Pleura","Vessel", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse")
categories <- "GrowthPattern"
#tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")


clinical.data.g.s <- clinical.data.g[  clinical.data.g$GrowthPattern=="aszinär"|
               clinical.data.g$GrowthPattern=="papillär"|
                 clinical.data.g$GrowthPattern=="lepidisch"|
                 clinical.data.g$GrowthPattern=="mikropapillär"|
                 clinical.data.g$GrowthPattern=="solid",]
clinical.data.g.s <- clinical.data
plot_list <- list()

for (i in (categories)) {
  for (k in tumour.type) {
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$NeoAdj=="NoNeoAdjuvantTherapy"&
                                          fibro.sce$DX.name==k]))

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data.g.s, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data.g.s)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion ,", k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
pdf(file=file.path(plot_folder, paste0("KW_W_CAF_",i,"_", k,".pdf")), width=12, height=6)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
    gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))

 dev.off()
 }
}
```

```{r}
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"

tdat_prop <-as.data.frame(table( fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                           fibro.sce$DX.name=="Adenocarcinoma"&
                                           fibro.sce$NeoAdj=="NoNeoAdjuvantTherapy"]$Patient_ID,
                            fibro.sce[, fibro.sce$Patient_ID!="Control"&
                                           fibro.sce$DX.name=="Adenocarcinoma"& 
                                           fibro.sce$NeoAdj=="NoNeoAdjuvantTherapy"]$cell_type))
colnames(tdat_prop)<-c("Patient_ID","Phenotype","n")

tdat_prop <-tdat_prop %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat_prop[is.na(tdat_prop)] <- 0
tdat_prop$Phenotype <-droplevels(tdat_prop$Phenotype)
tdat_prop$Patient_ID <-droplevels(tdat_prop$Patient_ID)

tdat_prop_wide <- pivot_wider(tdat_prop,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_prop_wide_c <- left_join(tdat_prop_wide, clinical.data.g, by="Patient_ID")
tdat_prop_wide_c <- tdat_prop_wide_c[tdat_prop_wide_c$GrowthPattern=="aszinär",]
tdat_prop_wide_c$mCAF_G <- ifelse(tdat_prop_wide_c$mCAF >summary(tdat_prop_wide_c$mCAF)[3],"mCAF high","mCAF low")

m.caf.g.p <- tdat_prop_wide_c%>% select(Patient_ID, mCAF_G)
```

```{r, fig.width=12, fig.height=6}
tumour.type <- c("Adenocarcinoma")

clinical.data.g.s <- clinical.data.g[  clinical.data.g$GrowthPattern=="aszinär",]
clinical.data.g.s <- left_join(clinical.data.g.s, m.caf.g, by="Patient_ID")

categories <- "mCAF_G"

plot_list <- list()

for (i in (categories)) {
  for (k in tumour.type) {
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$NeoAdj=="NoNeoAdjuvantTherapy"&
                                          fibro.sce$DX.name==k]))

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data.g.s, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data.g.s)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion ,", k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
#pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_",i,"_", k,".pdf")), width=15, height=15)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
    gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))

# dev.off()
 }
}
```
#density growth patterns
## Kruskal Wallis / Wilcoxon comparison between groups of clincial variables without neoadjuvant treated patients.
```{r  KW W Fibro category density WO neo,warning=FALSE, message=FALSE, echo=FALSE, fig.width=16, fig.height=12}
#define variables to be tested here
categories <- c("GrowthPattern")
#all.new$Gender[is.na(all.new$Gender)] <- "NA"
clinical.data
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[2:12])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:13])), names_to = "Phenotype",values_to = "density")


#remove
tdat <-tdat[!tdat$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_c <-left_join(tdat,clinical.data.g, by="Patient_ID")
tdat_c$GrowthPattern[is.na(tdat_c$GrowthPattern)] <- "NA"

tdat_c <- tdat_c[  tdat_c$GrowthPattern=="aszinär"|
                     tdat_c$GrowthPattern=="mikropapillär"|
                     tdat_c$GrowthPattern=="papillär"|
                     tdat_c$GrowthPattern=="lepidisch"|
                     tdat_c$GrowthPattern=="solid",]


# tdat_c <- tdat_c[tdat_c$Phenotype != "hypoxic_CAF"|
#                  tdat_c$Phenotype != "hypoxic_tpCAF"|
#                    tdat_c$Phenotype != "dCAF"|
#                    tdat_c$Phenotype != "Collagen_CAF",]


categories <- c( "GrowthPattern")
tumour.type <- c("Adenocarcinoma")

#j="dCAF"
plot_list <- list()
for (i in (categories)) {
  tdat<-tdat_c
  for (k in tumour.type) {
    tdat<-tdat_c[tdat_c$DX.name==k,]
  for (j in unique(tdat_c$Phenotype)){
  tdat<-tdat_c[tdat_c$DX.name==k,]
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
    tdat <-subset(tdat, Phenotype==j)

     #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <- sqrt(stat.test$y.position)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y=paste("Mean patient density ,",k))+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
         }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Densities_WOneo",i,".pdf")), width=12, height=8)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 # dev.off()
  }
}
```
## Kruskal Wallis / Wilcoxon comparison between groups of clincial variables without neoadjuvant treated patients.
```{r  KW W Fibro category density WO neo,warning=FALSE, message=FALSE, echo=FALSE, fig.width=12, fig.height=8}
#define variables to be tested here
categories <- c("GrowthPattern")
#all.new$Gender[is.na(all.new$Gender)] <- "NA"
clinical.data
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[2:12])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:13])), names_to = "Phenotype",values_to = "density")


#remove
tdat <-tdat[!tdat$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_c <-left_join(tdat,clinical.data.g, by="Patient_ID")
tdat_c$GrowthPattern[is.na(tdat_c$GrowthPattern)] <- "NA"

tdat_c <- tdat_c[  tdat_c$GrowthPattern=="aszinär",]


# tdat_c <- tdat_c[tdat_c$Phenotype != "hypoxic_CAF"|
#                  tdat_c$Phenotype != "hypoxic_tpCAF"|
#                    tdat_c$Phenotype != "dCAF"|
#                    tdat_c$Phenotype != "Collagen_CAF",]

#mCAF
#mCAF
tdat_wide_c <- left_join(tdat_wide, clinical.data.g, by="Patient_ID")
tdat_wide_c_a <- tdat_wide_c[tdat_wide_c$GrowthPattern=="aszinär",]
tdat_wide_c_a$mCAF_G <- ifelse(tdat_wide_c_a$mCAF >summary(tdat_wide_c_a$mCAF)[3],"mCAF high","mCAF low")

m.caf.g <- tdat_wide_c_a %>% select(Patient_ID, "mCAF_G")

tdat_c <- left_join(tdat_c, m.caf.g, by="Patient_ID")
categories <- c( "GrowthPattern")
categories <- c( "mCAF_G")
#tumour.type <- c("Adenocarcinoma", "Squamous cell carcinoma")
tumour.type <- c("Adenocarcinoma")

#j="dCAF"
plot_list <- list()
for (i in (categories)) {
  tdat<-tdat_c
  for (k in tumour.type) {
    tdat<-tdat_c[tdat_c$DX.name==k,]
  for (j in unique(tdat_c$Phenotype)){
  tdat<-tdat_c[tdat_c$DX.name==k,]
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
    tdat <-subset(tdat, Phenotype==j)

     #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <- sqrt(stat.test$y.position)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y=paste("Mean patient density ,",k))+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
         }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Densities_WOneo",i,".pdf")), width=12, height=8)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 # dev.off()
  }
}
```

```{r}
tdat_wide_c <- left_join(tdat_wide, clinical.data.g, by="Patient_ID")
tdat_wide_c_a <- tdat_wide_c[tdat_wide_c$GrowthPattern=="aszinär",]
tdat_wide_c_a$mCAF_G <- ifelse(tdat_wide_c_a$mCAF >summary(tdat_wide_c_a$mCAF)[3],"mCAF high","mCAF low")

m.caf.g <- tdat_wide_c_a %>% select(Patient_ID, "mCAF_G")
tumour.type <- c("Adenocarcinoma")

clinical.data.g.s <- clinical.data.g[  clinical.data.g$GrowthPattern=="aszinär",]
clinical.data.g.s <- left_join(clinical.data.g.s, m.caf.g, by="Patient_ID")

categories <- "mCAF_G"

```

```{r, fig.width=25, fig.height=15}
#Cell categories tumuor, immune, fibro, vessel, other
df <- data.frame(fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$CellID,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$Compartment,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$cell_type,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$DX.name,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$RoiID,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","ROI","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)
df <- left_join(df, clinical.data.g, by="Patient_ID")
head(df)

df %>% subset(Celltype=="Tumour") %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))

roi_rem <-df[df$Distance >300,]$ROI.x %>%unique()

df <-df[!df$ROI.x %in% roi_rem,]
#+  scale_x_continuous(trans = "log10")
df <- df[df$GrowthPattern=="aszinär"|
          df$GrowthPattern=="lepidisch"|
           df$GrowthPattern=="papillär"|
           df$GrowthPattern=="mikropapillär"|
           df$GrowthPattern=="solid",]
category20 <- c("#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7FFF","#BCBD22","#17BECF","#AEC7E8")

df$Celltype[df$Celltype=="Collagen_CAF"] <- "Collagen CAF"
df$Celltype[df$Celltype=="hypoxic_CAF"] <- "hypoxic CAF"
df$Celltype[df$Celltype=="hypoxic_tpCAF"] <- "hypoxic tCAF"
df$Celltype[df$Celltype=="SMA_CAF"] <- "SMA CAF"
df$Celltype[df$Celltype=="IDO_CAF"] <- "ifnCAF"
df$Celltype[df$Celltype=="PDPN_CAF"] <- "PDPN CAF"
df$Celltype[df$Celltype=="tpCAF"] <- "tCAF"

p <-df%>%#subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="tpCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF")%>%
  ggplot(aes(x=Distance, color=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  scale_colour_tableau()+
  scale_colour_manual(values=as.vector(category20)[1:11])+
 geom_vline(xintercept = 0,color = 'black', linetype="dashed")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~GrowthPattern, ncol=5)
 # facet_grid(Celltype~GrowthPattern)  
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "Distance_CAF_tumourstromaborder_split_by_GrowthPattern_CAFtype_new2.pdf"), width=16, height=4)
```


```{r, fig.width=25, fig.height=15}
df <- data.frame(fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$CellID,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$Compartment,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$cell_type,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$DX.name,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$RoiID,
                 fibro.sce_pat.roi[,fibro.sce_pat.roi$cell_category=="Fibroblast"]$Patient_ID)

colnames(df) <- c("CellID","Distance","Celltype","Type","ROI","Patient_ID")
df <- df %>% subset(Type=="Adenocarcinoma"|Type=="Squamous cell carcinoma")
head(df)
df <- left_join(df, clinical.data.g, by="Patient_ID")
head(df)

df %>% subset(Celltype=="Tumour") %>% ggplot(aes(x=Distance))+geom_density()+geom_vline(xintercept=0)+xlim(c(-100,150))

roi_rem <-df[df$Distance >300,]$ROI.x %>%unique()

df <-df[!df$ROI.x %in% roi_rem,]
#+  scale_x_continuous(trans = "log10")

p <-df%>%#subset(Celltype=="tpCAF"|Celltype=="mCAF"|Celltype=="tpCAF"|Celltype=="SMA_CAF"|Celltype=="iCAF")%>%
  ggplot(aes(x=Distance, color=Celltype)) +
  geom_density(alpha=0.3,size=1)+
  xlim(c(-100,150))+
  scale_colour_tableau()+
  scale_colour_manual(values=as.vector(category20)[1:11])+
 geom_vline(xintercept = 0,color = 'black', linetype="dashed")+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~Type,ncol=5)
  facet_grid(Celltype~Type)  
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "Distance_CAF_tumourstromaborder_split_by_TumourType_CAFtype_GRID_new.pdf"), width=8, height=18)
```



#Neighbourhood analysis
```{r}
out_h <- read.csv(file=file.path(data_folder, "all_out_histocat.csv"))
```

```{r all histocat, fig.width=28, fig.height=12}
out_h$RoiID <- out_h$group_by
cur_test <- left_join(out_h, clinical.data.g, by="RoiID")
cur_test <- left_join(out_h, m.test, by="RoiID")
cur_test$LN.Met[is.na(cur_test$LN.Met)]<-"NA"
cur_test$Grade[is.na(cur_test$Grade)]<-"NA"
cur_test$Dist.Met[is.na(cur_test$Dist.Met)]<-"NA"
cur_test$M.new[is.na(cur_test$M.new)]<-"NA"

table(cur_test$LN.Met)

#not split
p <-cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma") %>% as_tibble() %>%#)
  group_by(from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + #facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
p
#ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat.pdf"), width=8, height=6)

#split
cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma")%>% subset(Grade !="NA") %>% as_tibble() %>%#)
  group_by(Grade, from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( DX.name~ Grade) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
#ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat.pdf"), width=8, height=7)

#split by tumour type
p <-cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma") %>% as_tibble() %>%#)
  group_by(from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( ~ DX.name) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
p
###ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat_split by tumour type.pdf"), width=12, height=7)

#Growth Pattern
p <-cur_test %>% subset(DX.name=="Adenocarcinoma"&
                          GrowthPattern=="aszinär"|
                          GrowthPattern=="papillär"|
                          GrowthPattern=="mikropapillär"|
                          GrowthPattern=="solid"|
                          GrowthPattern=="lepidisch") %>% as_tibble() %>%#)
  group_by(from_label, to_label, GrowthPattern) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( ~ GrowthPattern) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
p
ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat_split by adeno growth pattern.pdf"), width=28, height=12)

cur_test %>% head
cur_test$from_label[cur_test$from_label =="Bcell"] <- "B cell"
cur_test$to_label[cur_test$to_label =="Bcell"] <- "B cell"

cur_test$from_label[cur_test$from_label =="tpCAF"] <- "tCAF"
cur_test$to_label[cur_test$to_label =="tpCAF"] <- "tCAF"

cur_test$from_label[cur_test$from_label =="IDO_CAF"] <- "ifnCAF"
cur_test$to_label[cur_test$to_label =="IDO_CAF"] <- "ifnCAF"

cur_test$from_label[cur_test$from_label =="Collagen_CAF"] <- "Collagen CAF"
cur_test$to_label[cur_test$to_label =="Collagen_CAF"] <- "Collagen CAF"

cur_test$from_label[cur_test$from_label =="SMA_CAF"] <- "SMA CAF"
cur_test$to_label[cur_test$to_label =="SMA_CAF"] <- "SMA CAF"

cur_test$from_label[cur_test$from_label =="PDPN_CAF"] <- "PDPN CAF"
cur_test$to_label[cur_test$to_label =="PDPN_CAF"] <- "PDPN CAF"

cur_test$from_label[cur_test$from_label =="normal"] <- "Epithelial"
cur_test$to_label[cur_test$to_label =="normal"] <- "Epithelial"

cur_test$from_label[cur_test$from_label =="hypoxic"] <- "hypoxic Epithelial"
cur_test$to_label[cur_test$to_label =="hypoxic"] <- "hypoxic Epithelial"

cur_test$from_label[cur_test$from_label =="hypoxic_tpCAF"] <- "hypoxic tCAF"
cur_test$to_label[cur_test$to_label =="hypoxic_tpCAF"] <- "hypoxic tCAF"

cur_test$from_label[cur_test$from_label =="hypoxic_CAF"] <- "hypoxic CAF"
cur_test$to_label[cur_test$to_label =="hypoxic_CAF"] <- "hypoxic CAF"

cur_test$from_label[cur_test$from_label =="CD4_Treg"] <- "CD4 T reg"
cur_test$to_label[cur_test$to_label =="CD4_Treg"] <- "CD4 T reg"

cur_test$from_label[cur_test$from_label =="PD1_CD4"] <- "PD-1 CD4"
cur_test$to_label[cur_test$to_label =="PD1_CD4"] <- "PD-1 CD4"

cur_test$from_label[cur_test$from_label =="IDO_CD4"] <- "CD4 IDO"
cur_test$to_label[cur_test$to_label =="IDO_CD4"] <- "CD4 IDO"

cur_test$from_label[cur_test$from_label =="IDO_CD8"] <- "CD8 IDO"
cur_test$to_label[cur_test$to_label =="IDO_CD8"] <- "CD8 IDO"

cur_test$from_label[cur_test$from_label =="ki67_CD4"] <- "CD4 Ki-67"
cur_test$to_label[cur_test$to_label =="ki67_CD4"] <- "CD4 Ki-67"

cur_test$from_label[cur_test$from_label =="ki67_CD8"] <- "CD8 Ki-67"
cur_test$to_label[cur_test$to_label =="ki67_CD8"] <- "CD8 Ki-67"

cur_test$from_label[cur_test$from_label =="TCF1/7_CD4"] <- "TCF1/7 CD4"
cur_test$to_label[cur_test$to_label =="TCF1/7_CD4"] <- "TCF1/7 CD4"

cur_test$from_label[cur_test$from_label =="TCF1/7_CD8"] <- "TCF1/7 CD8"
cur_test$to_label[cur_test$to_label =="TCF1/7_CD8"] <- "TCF1/7 CD8"


#by patient group
#split
p <-cur_test %>% subset(DX.name=="Adenocarcinoma"| DX.name=="Squamous cell carcinoma")%>% subset(Grade !="NA") %>% as_tibble() %>%#)
  group_by(metacluster, from_label, to_label, DX.name) %>%
  summarize(mean_sig = mean(sigval, na.rm = TRUE)) %>%
  ggplot() + 
    geom_tile(aes(from_label, to_label, fill = mean_sig)) + facet_grid( ~ metacluster) +
  scale_fill_gradient2(limits=c(-1, 1),low = "dark blue", mid = "white", high = "dark red") +
  theme_classic(base_size = 15) +
  theme(axis.text.x = element_text(angle = 90, hjust = 0))
ggsave(plot=p, file=file.path(plot_folder, "Neighbourhood_histocat_Split by PG.pdf"), width=26, height=8)

```

#Metastasis
```{r}
#d.met
clinical.data$Dist.Met[is.na(clinical.data$Dist.Met)] <- "NA"
clinical.data$LN.Met[is.na(clinical.data$LN.Met)] <- "NA"
clinical.data$DX.name[is.na(clinical.data$DX.name)] <- "NA"

clinical.data$NeoAdj[is.na(clinical.data$NeoAdj)] <- "NA"

d.met.df <-data.frame("Patient_ID"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$Patient_ID,
           "NeoAdj"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$NeoAdj,
           "TumourType"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$DX.name,
           "Gender"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$Gender,
           "Grade"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$Grade,
           "T.new"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$T.new,
           "N"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$N,
           "M"=clinical.data[clinical.data$Dist.Met=="Dist. Metastases",]$M
           )
print(d.met.df)
write.csv(d.met.df, file=file.path(data_folder, "Patient_ID_DistMet_all.csv"))

d.met.df.s <- d.met.df[d.met.df$TumourType =="Adenocarcinoma"|
                         d.met.df$TumourType =="Squamous cell carcinoma",]
d.met.df.s <- d.met.df.s[d.met.df.s$NeoAdj =="NoNeoAdjuvantTherapy",]
write.csv(d.met.df.s, file=file.path(data_folder, "Patient_ID_DistMet_minusNeoAdj.csv"))

#ln met
clinical.data$LN.Met[is.na(clinical.data$LN.Met)] <- "NA"

ln.met.df <-data.frame("Patient_ID"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$Patient_ID,
           "NeoAdj"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$NeoAdj,
           "TumourType"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$DX.name,
           "Gender"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$Gender,
           "Grade"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$Grade,
            "T.new"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$T.new,
           "N"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$N,
           "M"=clinical.data[clinical.data$LN.Met=="LN Metastases",]$M
           )

write.csv(ln.met.df, file=file.path(data_folder, "Patient_ID_LNMet_all.csv"))

ln.met.df.s <- ln.met.df[ln.met.df$TumourType =="Adenocarcinoma"|
                         ln.met.df$TumourType =="Squamous cell carcinoma",]

ln.met.df.s <- ln.met.df.s[ln.met.df.s$NeoAdj =="NoNeoAdjuvantTherapy",]
write.csv(ln.met.df.s, file=file.path(data_folder, "Patient_ID_LNMet_minusNeoAdj.csv"))

```

```{r}
clinical.data[clinical.data$DX.name=="Squamous cell carcinoma"&
                clinical.data$Gender==1&
                clinical.data$Grade==2&
                clinical.data$T.new==3,]$Patient_ID

```


```{r}
tumour <- "Adenocarcinoma"

gen <- 2
grad <-2
t.n <- 3
table(fibro.sce[, fibro.sce$Patient_ID %in% clinical.data[clinical.data$DX.name==tumour&
                clinical.data$Gender==gen&
                clinical.data$Grade==grad&
                clinical.data$T.new==t.n,]$Patient_ID]$cell_category,
      fibro.sce[, fibro.sce$Patient_ID %in% clinical.data[clinical.data$DX.name==tumour&
                clinical.data$Gender==gen&
                clinical.data$Grade==grad&
                clinical.data$T.new==t.n,]$Patient_ID]$Patient_ID) %>% data.frame() %>% arrange(Freq)
```


```{r}
met.cohort <- read.csv(file.path(data_folder, "Patient_ID_DistMet_minusNeoAdj_controlCohort.csv"))
met.cohort

met.cohort$Control[is.na(met.cohort$Control)] <-"NA"

met.cohort.pat <- met.cohort %>% select(Patient_ID, Control)

fibro.sce$MetCohort <- "NA"

clinical.data$MetCohort <- "NA"

clinical.data$MetCohort[clinical.data$Patient_ID %in% met.cohort.pat$Patient_ID] <-"Distant Metastases"
clinical.data$MetCohort[clinical.data$Patient_ID %in% met.cohort.pat$Control] <-"No Metastases"

fibro.sce$MetCohort[fibro.sce$Patient_ID %in% met.cohort.pat$Patient_ID] <-"Distant Metastases"
fibro.sce$MetCohort[fibro.sce$Patient_ID %in% met.cohort.pat$Control] <-"No Metastases"
fibro.sce$MetCohort %>% unique
clinical.data$MetCohort %>% unique

```

## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce[,fibro.sce$MetCohort!="NA"]))

categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","NeoAdj","Gender","Stage","Relapse")
categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse")

categories <- "MetCohort"
tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")


plot_list <- list()

for (i in (categories)) {
  #for (k in tumour.type) {
    # df <- as.data.frame(colData(fibro.sce[,fibro.sce$MetCohort!="NA"&
    #                                       fibro.sce$DX.name==k]))
  k = "both tumour types"
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$MetCohort!="NA"]))
    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=tdat[[i]]))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      scale_colour_manual(values=c("#00A19A","#C6C6C6"))+
        #scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion ,", k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
  pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_",i,"_", k,".pdf")), width=12, height=8)
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  dev.off()
 #}
}
```

#not split KW
```{r, fig.width=12, fig.height=10}
categories <- "MetCohort"
tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")


plot_list <- list()
k ="Both tumours"
for (i in (categories)) {
  
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$MetCohort!="NA"]))

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion ,", k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
    pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_",i,"_", k,".pdf")), width=15, height=15)
    gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
    dev.off()
 
}
```

#Differential abundance analysis loop   neoCohort
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=6, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
  
colData(fibro.sce)<-as.data.frame(colData(fibro.sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce))

#fibro.sce$MetCohort <- as.factor(fibro.sce$MetCohort )
#if necessary: change group_id labels

dat <-dat[dat$MetCohort!="NA",]

category <-c("MetCohort")
#category <-c("NeoAdj")


j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
   # dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_",i,"_",k,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

#p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes.pdf"))
#plot(p)
#p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue.pdf"))
#plot(p)
```
```{r}
metacluster <- read.csv(file=file.path(data_folder, "patient_groups_k4.csv"))
metacluster$X <- NULL

m.test <- left_join(clinical.data.g, metacluster, by="Patient_ID")
table(m.test$metacluster, m.test$DX.name) %>% prop.table(margin=2)

table(m.test[m.test$DX.name=="Adenocarcinoma"|m.test$DX.name=="Squamous cell carcinoma",]$metacluster,
      m.test[m.test$DX.name=="Adenocarcinoma"|m.test$DX.name=="Squamous cell carcinoma",]$DX.name) %>% prop.table()*100


table(m.test$metacluster, m.test$GrowthPattern)
colnames(clinical.data)
```
#Immune patch tma87 test
```{r, fig.width=50, fig.height=50}
tma87 <- all.new[, all.new$TMA =="87A"]
tma87 <- buildSpatialGraph(tma87, img_id = "ImageNumber",
                                 type = "expansion",
                                 threshold = 20,
                                coords=c("Center_X","Center_Y"))
# plotSpatial(tma87,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = T,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87,
#             img_id = "ImageNumber",
#             node_color_by = "hypox_normx",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             directed = FALSE,
#             scales = "free",
#             coords=c("Center_X","Center_Y"))
# 
# plotSpatial(tma87, img_id = "ImageNumber",
#             node_color_by = "Carbonic Anhydrase IX",
#             assay_type = "c_counts_asinh_scaled",
#             #node_shape_by = "ImageNumber",
#             node_size_by = "Area",
#             draw_edges = F,
#             colPairName = "expansion_interaction_graph",
#             #edge_color_by = "hypox_normx",
#             coords=c("Center_X","Center_Y"))



tma87 <- patchDetection(tma87, 
                              patch_cells = tma87$cell_category == "Immune",
                              colPairName = "expansion_interaction_graph",
                              expand_by = 5, 
                              img_id = "ImageNumber",
                              coords=c("Center_X","Center_Y"),
                              min_patch_size=25)

tma87$patch_id[is.na(tma87$patch_id)] <- "NA"


#pdf(file=file.path(plot_folder,"tma87_hypoxic_vs_normoxic_cells.pdf"))

plotSpatial(tma87,
            img_id = "ImageNumber",
            node_color_by = "cell_category",
            #node_shape_by = "ImageNumber",
            node_size_by = "Area",
            draw_edges = F,
            colPairName = "expansion_interaction_graph",
            directed = FALSE,
            scales = "free",
            coords=c("Center_X","Center_Y"))

#dev.off()

#pdf(file=file.path(plot_folder,"tma87_hypoxicPATCH_IDs.pdf"))

plotSpatial(tma87, 
            img_id = "ImageNumber", 
            node_color_by = "patch_id",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
#dev.off()

tma87$immune_patch <- ifelse(tma87$patch_id=="NA","immune_patch","non_immune_patch")

#pdf(file=file.path(plot_folder,"tma87_A_hypoxicPATCH.pdf"))
plotSpatial(tma87, 
            img_id = "ImageNumber", 
            node_color_by = "immune_patch",
            scales = "free",
            coords=c("Center_X","Center_Y"))+guides(color="none")
#dev.off()
#saveRDS(tma87, file=file.path(data_folder, "tma87_hypoxia.rds"))
#rm(tma87)
```


#DA Immune patch test
```{r, fig.height=12, fig.width=8}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)
  
colData(tma87)<-as.data.frame(colData(tma87)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(tma87))

tma87$immune_patch <- as.factor(tma87$immune_patch )
#if necessary: change group_id labels

#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)

category <-c("immune_patch")

#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over",i,k,".pdf",sep="_")))
  gridExtra::grid.arrange(grobs = plot_list)
 # dev.off()
}

p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes.pdf"))
plot(p)
p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue.pdf"))
plot(p)
```

#chemoresponse
```{r}
chemo_response <- read.csv(file=file.path(data_folder, "NeoAnsprechen_new.csv"))
chemo_response$X <- NULL
head(chemo_response)

chemo_response$Patient_ID <- paste(chemo_response$TMA, chemo_response$Nr, sep="_")
table(chemo_response$response)

test <- left_join(chemo_response, clinical.data)

table(test$response, test$DX.name)
```
#chemoresponse
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=6, warning=F, message=F,echo=F,}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)

colData(fibro.sce)<-as.data.frame(colData(fibro.sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce))

dat <- subset(dat, Patient_ID %in% chemo_response$Patient_ID)
#if necessary: change group_id labels

dat <- left_join(dat, chemo_response, by="Patient_ID")
#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
dat <- dat[dat$Radio =="0",]
dat <- dat[dat$diagnosis !="keine Angabe (y)",]
dat <- dat[dat$diagnosis !="keine Angabe",]

#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")
table(dat$response)
#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)

category <-c("Vessel","Pleura","Age","Dist.Met","LN.Met", "Relapse")
category <- "response"
#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_",i,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}

p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_vessel.pdf"))
plot(p)
p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue_vessel.pdf"))
plot(p)

plot_list <- list()
#not split
for (i in category) {
 # for(k in unique(dat$DX.name)){
    #dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  #}
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_",i,".pdf")))
  #gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}
```


```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=6, warning=F, message=F,echo=F,}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)

colData(fibro.sce)<-as.data.frame(colData(fibro.sce)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce))

dat <- subset(dat, Patient_ID %in% chemo_response$Patient_ID)
#if necessary: change group_id labels

dat <- left_join(dat, chemo_response, by="Patient_ID")
#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
dat <- dat[dat$response != "x",]

#dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
#dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
#dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")
table(dat$response)
#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#category <-"Grade"
#dat<-dat %>% drop_na(Grade)

category <-c("Vessel","Pleura","Age","Dist.Met","LN.Met", "Relapse")
category <- "response"
#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming category aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_type"

plot_list <- list()
for (i in category) {
  for(k in unique(dat$DX.name)){
    dat.l <-subset(dat, DX.name==k)

#dat.l <-dat
#k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_",i,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}

p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=Neighbour_Cluster,label =Neighbour_Cluster))+geom_point()+ geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_vessel.pdf"))
plot(p)
p <-t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05,label =Neighbour_Cluster))+geom_point() + geom_text()
#ggsave(p, file=file.path(plot_folder,"logCPM_plot_celltypes_pvalue_vessel.pdf"))
plot(p)

plot_list <- list()
#not split
for (i in category) {
 # for(k in unique(dat$DX.name)){
    #dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = paste(j), values_from =paste(j), values_fn = list("cell_type"=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "Neighbour_Cluster")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(Neighbour_Cluster,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Neighbour_Cluster", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
#ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
  #}
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("DifferentialAbundance_Analysis_celltype_n_over_",i,".pdf")))
  #gridExtra::grid.arrange(grobs = plot_list)
  #dev.off()
}
```


kruskal wallis response

## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
#fibro.sce <- readRDS(file=file.path(data_folder, "FINAL_All_Clustered_FILTERED_inc_tumour_vessel_immune_CAF_minusOther.rds"))
#fibro.sce$DX.name <- as.factor(fibro.sce$DX.name)
#fibro.sce$DX.name %>% replace_na("NA")
fibro.sce$DX.name[is.na(fibro.sce$DX.name)] <- "NA"
fibro.sce$DX.name[is.na(fibro.sce$Vessel)] <- "NA"

df <- as.data.frame(colData(fibro.sce[,fibro.sce$Patient_ID!="Control"&
                                          fibro.sce$DX.name=="Adenocarcinoma"|
                                          fibro.sce$DX.name=="Squamous cell carcinoma"]))



#remove neoadj patients
#df <-df[df$NeoAdj =="NoNeoAdjuvantTherapy",]
clinical.data <- left_join(clinical.data, chemo_response, by="Patient_ID")

categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","NeoAdj","Gender","Stage","Relapse")
categories <- c("Pleura","Vessel","Package_year_bin", "age_group", "Smok", "Dist.Met","LN.Met", "Grade","Gender","Stage","Relapse")
categories <- c("vital_percent","response")

categories <- c("vital_percent")
tumour.type <- c("Adenocarcinoma","Squamous cell carcinoma")
#categories <- c("DX.name", "Grade") 
i <- c("metacluster") 

#categories <- "Pleura"
plot_list <- list()

for (i in (categories)) {
  for (k in tumour.type) {
    df <- as.data.frame(colData(fibro.sce[,fibro.sce$Patient_ID!="Control"&
                                          fibro.sce$DX.name==k]))
df <- df[df$Patient_ID %in% chemo_response$Patient_ID,]
df <- left_join(df, chemo_response, by="Patient_ID")
#df <- df[df$response !="x",]
df <- df[df$diagnosis !="keine Angabe (y)",]
df <- df[df$diagnosis !="keine Angabe",]
df <- df[df$response !="x",]

#remove neoadj patients
#df <-df[df$NeoAdj =="NoNeoAdjuvantTherapy",]

    
    
    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y=paste("Proportion",k), fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
# pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME_",i,"_", k,".pdf")), width=15, height=15)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
    #gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))

# dev.off()
 }
}
```
CIBERSORTx

```{r}
lusc.dat <- read.csv("~/data/datasharing/Milad/For Lena/sqms_fractions_metadata_290923.csv", sep="\t")
lusc.dat$Pat_ID <- lusc.dat$case_submitter_id
lusc.dat = lusc.dat[!duplicated(lusc.dat$Pat_ID),]


surv_data <- read.delim("~/data/datasharing/Milad/For Lena/survival_LUSC_survival copy.txt")
surv_data$Pat_ID <- surv_data$xena_sample

surv_data <-surv_data %>%  separate(Pat_ID, c("TCGA", "x", "y","z")) %>% unite("Pat_ID", TCGA:y, sep="-")
surv_data$Pat_ID

lusc.surv <- left_join(lusc.dat,surv_data, by="Pat_ID")


surv_data$Pat_ID %in% lusc.dat$Pat_ID %>% table

lusc.dat$Pat_ID %in% surv_data$Pat_ID %>% table

lusc.dat$Pat_ID %>% unique %>% length
lusc.dat %>% unique

surv_data$Pat_ID %>% unique %>% length

lusc.surv$Pat_ID %>% unique %>% length

lusc.surv$all_tpCAF <-  rowMeans(lusc.surv[,c('hsp_tpCAF', 'tpCAF')], na.rm=TRUE)
lusc.surv$all_CAF <- rowMeans(lusc.surv[,c('hsp_tpCAF', 'tpCAF', "apCAF","dCAF","mCAF","iCAF", "rCAF","vCAF","IDO_CAF")], na.rm=TRUE)

table(lusc.surv$prior_treatment)
lusc.surv <- lusc.surv[lusc.surv$prior_treatment =="No",]
```


```{r}

lusc.surv$apCAF_G <- ifelse(lusc.surv$apCAF >summary(lusc.surv$apCAF)[3],"apCAF high","apCAF low")
lusc.surv$dCAF_G <- ifelse(lusc.surv$dCAF >summary(lusc.surv$dCAF)[3],"dCAF high","dCAF low")
lusc.surv$hsp_tpCAF_G <- ifelse(lusc.surv$hsp_tpCAF >summary(lusc.surv$hsp_tpCAF)[3],"hsp_tpCAF high","hsp_tpCAF low")
lusc.surv$iCAF_G <- ifelse(lusc.surv$iCAF >summary(lusc.surv$iCAF)[3],"iCAF high","iCAF low")
lusc.surv$mCAF_G <- ifelse(lusc.surv$mCAF >summary(lusc.surv$mCAF)[3],"mCAF high","mCAF low")
lusc.surv$IDO_CAF_G <- ifelse(lusc.surv$IDO_CAF >summary(lusc.surv$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")

lusc.surv$tpCAF_G <- ifelse(lusc.surv$tpCAF >summary(lusc.surv$tpCAF)[3],"tpCAF high","tpCAF low")
lusc.surv$vCAF_G <- ifelse(lusc.surv$vCAF >summary(lusc.surv$vCAF)[3],"vCAF high","vCAF low")
lusc.surv$rCAF_G <- ifelse(lusc.surv$rCAF >summary(lusc.surv$rCAF)[3],"rCAF high","rCAF low")
lusc.surv$all_tpCAF_G <- ifelse(lusc.surv$all_tpCAF >summary(lusc.surv$all_tpCAF)[3],"all tpCAF high","all tpCAF low")


surv <-c("apCAF_G","IDO_CAF_G","hsp_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","mCAF_G","rCAF_G","all_tpCAF_G")
```

```{r}
summary(lusc.surv$all_CAF)*100

summary(luad.surv$all_CAF)*100


```

```{r}
#surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[5]]

lusc.surv$dCAF_G <- "dCAF mid"
lusc.surv$dCAF_G[lusc.surv$dCAF > summary(lusc.surv$dCAF)[5]] <- "dCAF high"
lusc.surv$dCAF_G[lusc.surv$dCAF <= summary(lusc.surv$dCAF)[3]] <- "dCAF low"

lusc.surv$iCAF_G <- "iCAF mid"
lusc.surv$iCAF_G[lusc.surv$iCAF > summary(lusc.surv$iCAF)[5]] <- "iCAF high"
lusc.surv$iCAF_G[lusc.surv$iCAF <= summary(lusc.surv$iCAF)[3]] <- "iCAF low"

lusc.surv$mCAF_G <- "mCAF mid"
lusc.surv$mCAF_G[lusc.surv$mCAF > summary(lusc.surv$mCAF)[5]] <- "mCAF high"
lusc.surv$mCAF_G[lusc.surv$mCAF <= summary(lusc.surv$mCAF)[3]] <- "mCAF low"
 
lusc.surv$all_tpCAF_G <- "all_tpCAF mid"
lusc.surv$all_tpCAF_G[lusc.surv$all_tpCAF > summary(lusc.surv$all_tpCAF)[5]] <- "all_tpCAF high"
lusc.surv$all_tpCAF_G[lusc.surv$all_tpCAF <= summary(lusc.surv$all_tpCAF)[3]] <- "all_tpCAF low"
 
range(lusc.surv$all_CAF)
lusc.surv$apCAF_G %>% unique
surv <-c("dCAF_G","iCAF_G","mCAF_G","all_tpCAF_G")

```


```{r}
lusc.surv$iCAF_fract <- lusc.surv$iCAF / lusc.surv$all_CAF 
lusc.surv$dCAF_fract <- lusc.surv$dCAF / lusc.surv$all_CAF 
lusc.surv$mCAF_fract <- lusc.surv$mCAF / lusc.surv$all_CAF 
lusc.surv$tpCAF_fract <- lusc.surv$tpCAF / lusc.surv$all_CAF 
lusc.surv$all_tpCAF_fract <- lusc.surv$all_tpCAF / lusc.surv$all_CAF 

lusc.surv$hsp_tpCAF_fract <- lusc.surv$hsp_tpCAF / lusc.surv$all_CAF 
lusc.surv$IDO_CAF_fract <- lusc.surv$IDO_CAF / lusc.surv$all_CAF 
lusc.surv$vCAF_fract <- lusc.surv$vCAF / lusc.surv$all_CAF 
lusc.surv$apCAF_fract <- lusc.surv$apCAF / lusc.surv$all_CAF 
lusc.surv$rCAF_fract <- lusc.surv$rCAF / lusc.surv$all_CAF 

lusc.surv$apCAF_fract_G <- ifelse(lusc.surv$apCAF_fract >summary(lusc.surv$apCAF_fract)[3],"apCAF high","apCAF low")
lusc.surv$dCAF_fract_G <- ifelse(lusc.surv$dCAF_fract >summary(lusc.surv$dCAF_fract)[3],"dCAF high","dCAF low")
lusc.surv$hsp_tpCAF_fract_G <- ifelse(lusc.surv$hsp_tpCAF_fract >summary(lusc.surv$hsp_tpCAF_fract)[3],"hsp_tpCAF high","hsp_tpCAF low")
lusc.surv$iCAF_fract_G <- ifelse(lusc.surv$iCAF_fract >summary(lusc.surv$iCAF_fract)[3],"iCAF high","iCAF low")
lusc.surv$mCAF_fract_G <- ifelse(lusc.surv$mCAF_fract >summary(lusc.surv$mCAF_fract)[3],"mCAF high","mCAF low")
lusc.surv$IDO_CAF_fract_G <- ifelse(lusc.surv$IDO_CAF_fract >summary(lusc.surv$IDO_CAF_fract)[3],"IDO_CAF high","IDO_CAF low")

lusc.surv$tpCAF_fract_G <- ifelse(lusc.surv$tpCAF_fract >summary(lusc.surv$tpCAF_fract)[3],"tpCAF high","tpCAF low")
lusc.surv$vCAF_fract_G <- ifelse(lusc.surv$vCAF_fract >summary(lusc.surv$vCAF_fract)[3],"vCAF high","vCAF low")
lusc.surv$rCAF_fract_G <- ifelse(lusc.surv$rCAF_fract >summary(lusc.surv$rCAF_fract)[3],"rCAF high","rCAF low")
lusc.surv$all_tpCAF_fract_G <- ifelse(lusc.surv$all_tpCAF_fract >summary(lusc.surv$all_tpCAF_fract)[3],"all tpCAF high","all tpCAF low")

surv <-c("apCAF_fract_G","IDO_CAF_fract_G","hsp_tpCAF_fract_G","dCAF_fract_G","vCAF_fract_G","iCAF_fract_G","tpCAF_fract_G","mCAF_fract_G","rCAF_fract_G","all_tpCAF_fract_G")

```


```{r  survival Fibro category proportions not split high low, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=5}
#out.width="50%",
i <- "apCAF_G"
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
   # dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-lusc.surv
  dat <- data.table(dat)
  k="LUSC"
  dat<- dat[is.na(dat$OS.time) !=T,]
  dat<- dat[is.na(dat$OS) !=T,]
 
#OS
# pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ dat[[i]],data = dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#     abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS.time, OS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               #conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               palette = "jco",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_OS over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
# pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ i,data = surv_dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#    abbr.colnames = FALSE, na = " "))

  dat <-lusc.surv
  dat <- data.table(dat)
  k="LUSC"
  dat<- dat[is.na(dat$PFI.time) !=T,]
  dat<- dat[is.na(dat$PFI) !=T,]
 
  
km_trt_fit <- survfit(Surv(PFI.time, PFI) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("PFI over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_PFI over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit


#DFI
dat <-lusc.surv
  dat <- data.table(dat)
  k="LUSC"
  dat<- dat[is.na(dat$DFI.time) !=T,]
  dat<- dat[is.na(dat$DFI) !=T,]
 
  
km_trt_fit <- survfit(Surv(DFI.time, DFI) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFI over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFI over",i,"_per_",k,".pdf")), width=6, height=6)
 print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

#DSS
dat <-lusc.surv
  dat <- data.table(dat)
  k="LUSC"
  dat<- dat[is.na(dat$DSS.time) !=T,]
  dat<- dat[is.na(dat$DSS) !=T,]
 
  
km_trt_fit <- survfit(Surv(DSS.time, DSS) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DSS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DSS over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

  #}
}
```

#ADENO
```{r}
luad.dat <- read.csv("~/data/datasharing/Milad/For Lena/adenos_fractions_metadata_200923.csv", sep="\t")
luad.dat$Pat_ID <- luad.dat$case_submitter_id
luad.dat = luad.dat[!duplicated(luad.dat$Pat_ID),]


surv_data <- read.delim("~/data/datasharing/Milad/For Lena/survival_LUAD_survival.txt")
surv_data$Pat_ID <- surv_data$X_PATIENT
surv_data = surv_data[!duplicated(surv_data$Pat_ID),]


luad.surv <- left_join(luad.dat,surv_data, by="Pat_ID")


surv_data$X_PATIENT %in% luad.dat$Pat_ID %>% table

luad.dat$Pat_ID %in% surv_data$X_PATIENT %>% table

luad.dat$Pat_ID %>% unique %>% length
luad.dat %>% unique

surv_data$Pat_ID %>% unique %>% length

luad.surv$Pat_ID %>% unique %>% length

luad.surv$all_tpCAF <-  rowMeans(luad.surv[,c('hsp_tpCAF', 'tpCAF')], na.rm=TRUE)
luad.surv$all_CAF <- rowMeans(luad.surv[,c('hsp_tpCAF', 'tpCAF', "apCAF","dCAF","mCAF","iCAF", "rCAF","vCAF","IDO_CAF")], na.rm=TRUE)

range(lusc.surv$all_CAF)
table(luad.surv$prior_treatment)
luad.surv <- luad.surv[luad.surv$prior_treatment =="No",]
0.004916091*100
```


```{r}

luad.surv$apCAF_G <- ifelse(luad.surv$apCAF >summary(luad.surv$apCAF)[3],"apCAF high","apCAF low")
luad.surv$dCAF_G <- ifelse(luad.surv$dCAF >summary(luad.surv$dCAF)[3],"dCAF high","dCAF low")
luad.surv$hsp_tpCAF_G <- ifelse(luad.surv$hsp_tpCAF >summary(luad.surv$hsp_tpCAF)[3],"hsp_tpCAF high","hsp_tpCAF low")
luad.surv$iCAF_G <- ifelse(luad.surv$iCAF >summary(luad.surv$iCAF)[3],"iCAF high","iCAF low")
luad.surv$mCAF_G <- ifelse(luad.surv$mCAF >summary(luad.surv$mCAF)[3],"mCAF high","mCAF low")
luad.surv$IDO_CAF_G <- ifelse(luad.surv$IDO_CAF >summary(luad.surv$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")

luad.surv$tpCAF_G <- ifelse(luad.surv$tpCAF >summary(luad.surv$tpCAF)[3],"tpCAF high","tpCAF low")
luad.surv$vCAF_G <- ifelse(luad.surv$vCAF >summary(luad.surv$vCAF)[3],"vCAF high","vCAF low")
luad.surv$rCAF_G <- ifelse(luad.surv$rCAF >summary(luad.surv$rCAF)[3],"rCAF high","rCAF low")
luad.surv$all_tpCAF_G <- ifelse(luad.surv$all_tpCAF >summary(luad.surv$all_tpCAF)[3],"all tpCAF high","all tpCAF low")


surv <-c("apCAF_G","IDO_CAF_G","hsp_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","mCAF_G","rCAF_G","all_tpCAF_G")
```

```{r}
#surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[5]]

luad.surv$dCAF_G <- "dCAF mid"
luad.surv$dCAF_G[luad.surv$dCAF > summary(luad.surv$dCAF)[5]] <- "dCAF high"
luad.surv$dCAF_G[luad.surv$dCAF <= summary(luad.surv$dCAF)[3]] <- "dCAF low"

luad.surv$iCAF_G <- "iCAF mid"
luad.surv$iCAF_G[luad.surv$iCAF > summary(luad.surv$iCAF)[5]] <- "iCAF high"
luad.surv$iCAF_G[luad.surv$iCAF <= summary(luad.surv$iCAF)[3]] <- "iCAF low"

luad.surv$mCAF_G <- "mCAF mid"
luad.surv$mCAF_G[luad.surv$mCAF > summary(luad.surv$mCAF)[5]] <- "mCAF high"
luad.surv$mCAF_G[luad.surv$mCAF <= summary(luad.surv$mCAF)[3]] <- "mCAF low"
 
luad.surv$all_tpCAF_G <- "all_tpCAF mid"
luad.surv$all_tpCAF_G[luad.surv$all_tpCAF > summary(luad.surv$all_tpCAF)[5]] <- "all_tpCAF high"
luad.surv$all_tpCAF_G[luad.surv$all_tpCAF <= summary(luad.surv$all_tpCAF)[3]] <- "all_tpCAF low"
 

luad.surv$apCAF_G %>% unique
surv <-c("dCAF_G","iCAF_G","mCAF_G","all_tpCAF_G")

```

```{r}
luad.surv$iCAF_fract <- luad.surv$iCAF / luad.surv$all_CAF 
luad.surv$dCAF_fract <- luad.surv$dCAF / luad.surv$all_CAF 
luad.surv$mCAF_fract <- luad.surv$mCAF / luad.surv$all_CAF 
luad.surv$tpCAF_fract <- luad.surv$tpCAF / luad.surv$all_CAF 
luad.surv$all_tpCAF_fract <- luad.surv$all_tpCAF / luad.surv$all_CAF 

luad.surv$hsp_tpCAF_fract <- luad.surv$hsp_tpCAF / luad.surv$all_CAF 
luad.surv$IDO_CAF_fract <- luad.surv$IDO_CAF / luad.surv$all_CAF 
luad.surv$vCAF_fract <- luad.surv$vCAF / luad.surv$all_CAF 
luad.surv$apCAF_fract <- luad.surv$apCAF / luad.surv$all_CAF 
luad.surv$rCAF_fract <- luad.surv$rCAF / luad.surv$all_CAF 

luad.surv$apCAF_fract_G <- ifelse(luad.surv$apCAF_fract >summary(luad.surv$apCAF_fract)[3],"apCAF high","apCAF low")
luad.surv$dCAF_fract_G <- ifelse(luad.surv$dCAF_fract >summary(luad.surv$dCAF_fract)[3],"dCAF high","dCAF low")
luad.surv$hsp_tpCAF_fract_G <- ifelse(luad.surv$hsp_tpCAF_fract >summary(luad.surv$hsp_tpCAF_fract)[3],"hsp_tpCAF high","hsp_tpCAF low")
luad.surv$iCAF_fract_G <- ifelse(luad.surv$iCAF_fract >summary(luad.surv$iCAF_fract)[3],"iCAF high","iCAF low")
luad.surv$mCAF_fract_G <- ifelse(luad.surv$mCAF_fract >summary(luad.surv$mCAF_fract)[3],"mCAF high","mCAF low")
luad.surv$IDO_CAF_fract_G <- ifelse(luad.surv$IDO_CAF_fract >summary(luad.surv$IDO_CAF_fract)[3],"IDO_CAF high","IDO_CAF low")

luad.surv$tpCAF_fract_G <- ifelse(luad.surv$tpCAF_fract >summary(luad.surv$tpCAF_fract)[3],"tpCAF high","tpCAF low")
luad.surv$vCAF_fract_G <- ifelse(luad.surv$vCAF_fract >summary(luad.surv$vCAF_fract)[3],"vCAF high","vCAF low")
luad.surv$rCAF_fract_G <- ifelse(luad.surv$rCAF_fract >summary(luad.surv$rCAF_fract)[3],"rCAF high","rCAF low")
luad.surv$all_tpCAF_fract_G <- ifelse(luad.surv$all_tpCAF_fract >summary(luad.surv$all_tpCAF_fract)[3],"all tpCAF high","all tpCAF low")

surv <-c("apCAF_fract_G","IDO_CAF_fract_G","hsp_tpCAF_fract_G","dCAF_fract_G","vCAF_fract_G","iCAF_fract_G","tpCAF_fract_G","mCAF_fract_G","rCAF_fract_G","all_tpCAF_fract_G")

```


```{r  survival Fibro category proportions not split high low, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=5}
#out.width="50%",
i <- "apCAF_G"
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
   # dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-luad.surv
  dat <- data.table(dat)
  k="luad"
  dat<- dat[is.na(dat$OS.time) !=T,]
  dat<- dat[is.na(dat$OS) !=T,]
 
#OS
# pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ dat[[i]],data = dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#     abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS.time, OS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               #conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               palette = "jco",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_OS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
# pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ i,data = surv_dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#    abbr.colnames = FALSE, na = " "))

  dat <-luad.surv
  dat <- data.table(dat)
  k="luad"
  dat<- dat[is.na(dat$PFI.time) !=T,]
  dat<- dat[is.na(dat$PFI) !=T,]
 
  
km_trt_fit <- survfit(Surv(PFI.time, PFI) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("PFI over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit


#DFI
dat <-luad.surv
  dat <- data.table(dat)
  k="luad"
  dat<- dat[is.na(dat$DFI.time) !=T,]
  dat<- dat[is.na(dat$DFI) !=T,]
 
  
km_trt_fit <- survfit(Surv(DFI.time, DFI) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFI over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

#DSS
dat <-luad.surv
  dat <- data.table(dat)
  k="luad"
  dat<- dat[is.na(dat$DSS.time) !=T,]
  dat<- dat[is.na(dat$DSS) !=T,]
 
  
km_trt_fit <- survfit(Surv(DSS.time, DSS) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DSS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

  #}
}
```

#LUAD & LUSC together
```{r}
colnames(lusc.surv) %in% colnames(luad.surv) %>% table

colnames(luad.surv) %in% colnames(lusc.surv) %>% table

colnames(lusc.surv)[!colnames(lusc.surv) %in% colnames(luad.surv)]
colnames(luad.surv)[!colnames(luad.surv) %in% colnames(lusc.surv)]
lusc.surv$cases.case_id <- NULL
lusc.surv$X.r. <- NULL
lusc.surv$xena_sample <- NULL
lusc.surv$z <- NULL

luad.surv$sample <- NULL
all.surv <- rbind(lusc.surv, luad.surv)
```

```{r}

all.surv$apCAF_G <- ifelse(all.surv$apCAF >summary(all.surv$apCAF)[3],"apCAF high","apCAF low")
all.surv$dCAF_G <- ifelse(all.surv$dCAF >summary(all.surv$dCAF)[3],"dCAF high","dCAF low")
all.surv$hsp_tpCAF_G <- ifelse(all.surv$hsp_tpCAF >summary(all.surv$hsp_tpCAF)[3],"hsp_tpCAF high","hsp_tpCAF low")
all.surv$iCAF_G <- ifelse(all.surv$iCAF >summary(all.surv$iCAF)[3],"iCAF high","iCAF low")
all.surv$mCAF_G <- ifelse(all.surv$mCAF >summary(all.surv$mCAF)[3],"mCAF high","mCAF low")
all.surv$IDO_CAF_G <- ifelse(all.surv$IDO_CAF >summary(all.surv$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")

all.surv$tpCAF_G <- ifelse(all.surv$tpCAF >summary(all.surv$tpCAF)[3],"tpCAF high","tpCAF low")
all.surv$vCAF_G <- ifelse(all.surv$vCAF >summary(all.surv$vCAF)[3],"vCAF high","vCAF low")
all.surv$rCAF_G <- ifelse(all.surv$rCAF >summary(all.surv$rCAF)[3],"rCAF high","rCAF low")
all.surv$all_tpCAF_G <- ifelse(all.surv$all_tpCAF >summary(all.surv$all_tpCAF)[3],"all tpCAF high","all tpCAF low")


surv <-c("apCAF_G","IDO_CAF_G","hsp_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","mCAF_G","rCAF_G","all_tpCAF_G")
```

```{r}
#surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[5]]

all.surv$dCAF_G <- "dCAF mid"
all.surv$dCAF_G[all.surv$dCAF > summary(all.surv$dCAF)[5]] <- "dCAF high"
all.surv$dCAF_G[all.surv$dCAF <= summary(all.surv$dCAF)[3]] <- "dCAF low"

all.surv$iCAF_G <- "iCAF mid"
all.surv$iCAF_G[all.surv$iCAF > summary(all.surv$iCAF)[5]] <- "iCAF high"
all.surv$iCAF_G[all.surv$iCAF <= summary(all.surv$iCAF)[3]] <- "iCAF low"

all.surv$mCAF_G <- "mCAF mid"
all.surv$mCAF_G[all.surv$mCAF > summary(all.surv$mCAF)[5]] <- "mCAF high"
all.surv$mCAF_G[all.surv$mCAF <= summary(all.surv$mCAF)[3]] <- "mCAF low"
 
all.surv$all_tpCAF_G <- "all_tpCAF mid"
all.surv$all_tpCAF_G[all.surv$all_tpCAF > summary(all.surv$all_tpCAF)[5]] <- "all_tpCAF high"
all.surv$all_tpCAF_G[all.surv$all_tpCAF <= summary(all.surv$all_tpCAF)[3]] <- "all_tpCAF low"
 

all.surv$apCAF_G %>% unique
surv <-c("dCAF_G","iCAF_G","mCAF_G","all_tpCAF_G")

```

```{r}
all.surv$iCAF_fract <- all.surv$iCAF / all.surv$all_CAF 
all.surv$dCAF_fract <- all.surv$dCAF / all.surv$all_CAF 
all.surv$mCAF_fract <- all.surv$mCAF / all.surv$all_CAF 
all.surv$tpCAF_fract <- all.surv$tpCAF / all.surv$all_CAF 
all.surv$all_tpCAF_fract <- all.surv$all_tpCAF / all.surv$all_CAF 

all.surv$hsp_tpCAF_fract <- all.surv$hsp_tpCAF / all.surv$all_CAF 
all.surv$IDO_CAF_fract <- all.surv$IDO_CAF / all.surv$all_CAF 
all.surv$vCAF_fract <- all.surv$vCAF / all.surv$all_CAF 
all.surv$apCAF_fract <- all.surv$apCAF / all.surv$all_CAF 
all.surv$rCAF_fract <- all.surv$rCAF / all.surv$all_CAF 

all.surv$apCAF_fract_G <- ifelse(all.surv$apCAF_fract >summary(all.surv$apCAF_fract)[3],"apCAF high","apCAF low")
all.surv$dCAF_fract_G <- ifelse(all.surv$dCAF_fract >summary(all.surv$dCAF_fract)[3],"dCAF high","dCAF low")
all.surv$hsp_tpCAF_fract_G <- ifelse(all.surv$hsp_tpCAF_fract >summary(all.surv$hsp_tpCAF_fract)[3],"hsp_tpCAF high","hsp_tpCAF low")
all.surv$iCAF_fract_G <- ifelse(all.surv$iCAF_fract >summary(all.surv$iCAF_fract)[3],"iCAF high","iCAF low")
all.surv$mCAF_fract_G <- ifelse(all.surv$mCAF_fract >summary(all.surv$mCAF_fract)[3],"mCAF high","mCAF low")
all.surv$IDO_CAF_fract_G <- ifelse(all.surv$IDO_CAF_fract >summary(all.surv$IDO_CAF_fract)[3],"IDO_CAF high","IDO_CAF low")

all.surv$tpCAF_fract_G <- ifelse(all.surv$tpCAF_fract >summary(all.surv$tpCAF_fract)[3],"tpCAF high","tpCAF low")
all.surv$vCAF_fract_G <- ifelse(all.surv$vCAF_fract >summary(all.surv$vCAF_fract)[3],"vCAF high","vCAF low")
all.surv$rCAF_fract_G <- ifelse(all.surv$rCAF_fract >summary(all.surv$rCAF_fract)[3],"rCAF high","rCAF low")
all.surv$all_tpCAF_fract_G <- ifelse(all.surv$all_tpCAF_fract >summary(all.surv$all_tpCAF_fract)[3],"all tpCAF high","all tpCAF low")

surv <-c("apCAF_fract_G","IDO_CAF_fract_G","hsp_tpCAF_fract_G","dCAF_fract_G","vCAF_fract_G","iCAF_fract_G","tpCAF_fract_G","mCAF_fract_G","rCAF_fract_G","all_tpCAF_fract_G")

```


```{r  survival Fibro category proportions not split high low, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=5}
#out.width="50%",
i <- "apCAF_G"
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
   # dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-all.surv
  dat <- data.table(dat)
  k="all"
  dat<- dat[is.na(dat$OS.time) !=T,]
  dat<- dat[is.na(dat$OS) !=T,]
 
#OS
# pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ dat[[i]],data = dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#     abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS.time, OS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               #conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               palette = "jco",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_OS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
# pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ i,data = surv_dat)
# print(pw)
# print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#    symbols = c("****", "***", "**", "*", "+", "."),
#    abbr.colnames = FALSE, na = " "))

  dat <-all.surv
  dat <- data.table(dat)
  k="all"
  dat<- dat[is.na(dat$PFI.time) !=T,]
  dat<- dat[is.na(dat$PFI) !=T,]
 
  
km_trt_fit <- survfit(Surv(PFI.time, PFI) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("PFI over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit


#DFI
dat <-all.surv
  dat <- data.table(dat)
  k="all"
  dat<- dat[is.na(dat$DFI.time) !=T,]
  dat<- dat[is.na(dat$DFI) !=T,]
 
  
km_trt_fit <- survfit(Surv(DFI.time, DFI) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFI over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

#DSS
dat <-all.surv
  dat <- data.table(dat)
  k="all"
  dat<- dat[is.na(dat$DSS.time) !=T,]
  dat<- dat[is.na(dat$DSS) !=T,]
 
  
km_trt_fit <- survfit(Surv(DSS.time, DSS) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DSS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
# pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
# print(p,newpage=FALSE)
# dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())

  #}
}
```