---
title: "R Notebook - Analysis Fibros"
output:
  html_document:
    df_print: paged
---
```{r load libraries, echo=F, message=F, warning=F}
library(ggpubr)
library(dplyr)
#library(tidyverse)
library(RColorBrewer)
library(qwraps2)
library(table1)
library(SingleCellExperiment)
#library(uwot)
library(tidyr)
library(scater)
library(ggridges)
library(viridis)
library(viridisLite)
library(ggplot2)
library(data.table)
library(CATALYST)
library(gridExtra)
library(Rphenograph)
library(ComplexHeatmap)
library(CATALYST)
library(scales)
library(survival)
library(broom)
library(pheatmap)
library(FlowSOM)
library(Seurat)
library(Rphenoannoy)
library(dplyr)
library(data.table)
library(ggthemes)
library(diffcyt)
library(edgeR)
library(rstatix)
library(dendextend)

library(ggdendro)
library(dendextend)
library(FactoMineR)
library(factoextra)
library(survminer)
library(corrplot)
library(rstatix)
library(graphics)
library(cowplot)
library(cluster)
library(glmnet)
library(fastDummies)

library(igraph)
library(SingleCellExperiment)
library(S4Vectors)
library(stringr)
library(DT)
library(dplyr)
library(tidyr)
library(mclust)
library(ggplot2)
library(RColorBrewer)
library(scater)
library(Rphenoannoy)
library(factoextra)
library(cluster)
library(dendextend)
library(ggthemes)
set.seed(101100)
```



```{r  Set wd and load data}
#set working directory 
wd <-dirname(getwd())

#clinical.data
data_folder <-(file.path(wd,"sce_objects","final objects with categories","FINAL"))
plot_folder <-(file.path(wd,"plots"))

fibro.sce <- readRDS(file=file.path(data_folder, "FIBRO_CLINICAL-DATA_FILTERED.rds"))
fibro.sce$DX.name[is.na(fibro.sce$DX.name)]<-"NA"

```

Define clinical data
```{r clinical data, message=FALSE, warning=FALSE, echo=FALSE}
clinical.data <- read.csv(file=file.path(wd,"sce_objects","clinical_data", "clinical_data_ROI_ac_combined_CORRECT.csv"))

clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]
clinical.data$X <-NULL
clinical.data$X.1 <-NULL
head(clinical.data)
```
Table with Immune cell numbers including Fibros removing undefined
```{r  Table with immune cell numbers per patient, echo=FALSE, message=FALSE, warning=FALSE}
#All Fibros together
tbl <- as.data.frame(table(fibro.sce[,fibro.sce$Patient_ID!="Control" ]$Patient_ID))
colnames(tbl) <-c("Patient ID", "Fibro number overall")
#write.csv(tbl, file=file.path(plot_folder, paste("Immune cell numbers per patient overall including T-excluding undefined cells.csv")))
#print(tbl)

summary(tbl$`Fibro number overall`) #3-6259
tbl[tbl$`Fibro number overall` <=100,] #43 patients have less than 100 F

#Lowest 10% of all patients' Fibro numbers
tbl[order(tbl$`Fibro number overall`),]$`Fibro number overall`[1:100] #1-23


#Highest 10% of all patients' Fibro numbers
tbl[order(-tbl$`Fibro number overall`),]$`Fibro number overall`[1:100] #760-2378

tbl[tbl$`Fibro number overall` <=100,] #43 patients have less than 100 Fibros=10%. 77 patients have less than 15 Fibros

all_fibro_pat <- tbl[tbl$`Fibro number overall` <=100,]$`Patient ID`

length(unique(fibro.sce$Patient_ID))
```

Remove ROIs
```{r  Table with Immune cell numbers per image, echo=FALSE, message=FALSE, warning=FALSE}
#All Immune cells together
tbl <- as.data.frame(table(fibro.sce[,fibro.sce$Patient_ID!="Control"]$RoiID))
colnames(tbl) <-c("ROI ID", "Fibro number overall")
#write.csv(tbl, file=file.path(plot_folder, paste("Fibro numbers per ROI overall including Fibros-excluding undefined.csv")))
#print(tbl)
summary(tbl$`Fibro number overall`) #1-5075
tbl[tbl$`Fibro number overall` <=10,] #93 images have less than 50 Fibros (10% of median)
#Lowest 10% of all patients' Fibro numbers
tbl[order(tbl$`Fibro number overall`),]$`Fibro number overall`[1:200] #1-110


#Highest 10% of all patients' Fibro numbers
tbl[order(-tbl$`Fibro number overall`),]$`Fibro number overall`[1:200] #1385-5075
#per image cut at 50 Fibros per image equals lowest 5% -> ensures that there's at least 50 Fibros per patient

all_fibro_roi <- tbl[tbl$`Fibro number overall` <=50,]$`ROI ID`
```


Remove patients and roi
```{r  patient roi and pat_roi removal, echo=FALSE, message=FALSE, warning=FALSE}
#Patient removal
fibro.sce_pat <- fibro.sce[,fibro.sce$Patient_ID!="Control"&
                               !fibro.sce$Patient_ID%in%all_fibro_pat]
length(unique(fibro.sce_pat$Patient_ID)) #1025

#Roi removal
fibro.sce_roi <- fibro.sce[,fibro.sce$Patient_ID!="Control"&
                               !fibro.sce$RoiID%in%all_fibro_roi]
length(unique(fibro.sce_roi$Patient_ID)) #1039

#Patient & Roi removal
fibro.sce_pat.roi <- fibro.sce[,fibro.sce$Patient_ID!="Control"&
                               !fibro.sce$Patient_ID%in%all_fibro_pat&
                               !fibro.sce$RoiID%in%all_fibro_roi]
length(unique(fibro.sce_pat.roi$Patient_ID)) #1025
```

```{r  Save SCE patient and roi removed, include=FALSE, echo=FALSE,warning=FALSE, message=FALSE, eval=FALSE}
data_folder <-(file.path(wd,"sce_objects","stroma","CAF"))

saveRDS(fibro.sce_pat.roi,file=file.path(data_folder, paste("Fibro_sce_pat_roi_rem.rds",sep="")))
saveRDS(fibro.sce_roi,file=file.path(data_folder, paste("Fibro_sce_roi_rem.rds",sep="")))
saveRDS(fibro.sce_pat,file=file.path(data_folder, paste("Fibro_sce_pat_rem.rds",sep="")))

fibro.sce_pat.roi <-readRDS(file=file.path(data_folder, paste("Fibro_sce_pat_roi_rem.rds",sep="")))
fibro.sce_roi <-readRDS(file=file.path(data_folder, paste("Fibro_sce_roi_rem.rds",sep="")))
fibro.sce_pat <-readRDS(file=file.path(data_folder, paste("Fibro_sce_pat_rem.rds",sep="")))

table(fibro.sce_pat.roi$cell_type)
```


##Analysis
#Proportions Fibro CATEGORY

## **Analysis**
In the following, only tumours that were identified as adenocarcinomas or squamous cell carcinomas by pathologists will be used.

## **Fibro Category**

## **Proportions**
Optimal number of patient metaclusters Fibro category proportions
```{r  optimal number of clusters for non Fibro category type proportion clusters, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=6, fig.height=4}
#Calculate Proportions
neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
tdat <-as.data.frame(table( fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$cell_type))


colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_wide <-tdat_wide[!tdat_wide$Patient_ID%in% neoadj_pat$Patient_ID,]
tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID
#tdat_m <-tdat_m[,1:2]
hc <- hclust(dist(tdat_m[,-1], method="euclidian"),"ward.D2")

#devtools::install_github("kassambara/factoextra")
sbg <-cutree(hc, k=2)
fviz_cluster(list(data = tdat_wide[,-1], cluster = sbg))

fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "wss", k.max=15)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "gap_stat", k.max=15)

p <-fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "silhouette", k.max=15)
plot(p)
#ggsave(p, file=file.path(plot_folder, "Silhouette_optClusters_Meta4.pdf"), width=6, height=4)
#install.packages("cluster")
gap_stat <- clusGap(tdat_wide[,-1], FUN = hcut, nstart = 25, K.max = 10, B = 100)
fviz_gap_stat(gap_stat)

# Compute distance matrix
#res.dist <- dist(tdat_wide[,-1], method = "euclidean")
```

## Patients are ordered by hierarchical clustering (euclidian, wards.D2)
```{r  Fibro category proportions ordered by hierarchical clustering, message=FALSE, warning=FALSE, echo=FALSE}
fibro.sce_pat$DX.name[is.na(fibro.sce_pat$DX.name)] <- "NA"

tdat <-as.data.frame(table( fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID

hc <- hclust(dist(tdat_m[,-1], method="euclidian"),"ward.D2")
tdat_wide$Patient_ID <- factor(tdat_wide$Patient_ID, levels = hc$labels[hc$order])
tdat$Patient_ID <- factor(tdat$Patient_ID, levels = hc$labels[hc$order])

tdat_wide
```

Patient based metaclusters split by metacluster
```{r  Barplot Fibro category proportions, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
#Barplot proportions ordered by
mycol <-c("#1D76B5","#EF7D20","#2CA237","#D6272A","#8F67A9","#8D564C","#D278AF","#7F7F7F","#BCBC20","#34B9C9","#AEC6E8")
p <-ggplot(tdat,aes(x=freq, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+#scale_fill_tableau("Tableau 20")+
  scale_fill_manual(values=mycol)
plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-Category_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k =4) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat,aes(x=n, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+#scale_fill_tableau("Tableau 20")+
  theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  scale_fill_manual(values=mycol)
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_CAF_type_proportions_K4.pdf")), width=12, height=6)
```

```{r  merge hc metacluster into t_dat Fibro category proportions, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]

#cut dendrogram, add metacluster info to tdat
ct <-as.data.frame(cutree(hc, k= 4))

colnames(ct)<-"metacluster"
ct$metacluster <-as.factor(ct$metacluster)
ct$Patient_ID <- rownames(ct)

tdat_wide_ct <-left_join(tdat_wide, ct, by="Patient_ID")
tdat_wide_ct <- left_join(tdat_wide_ct, clinical.data, by="Patient_ID")
table(tdat_wide_ct$metacluster)

#split barlot by metacluster
tdat_ct <-merge(tdat, ct, by="Patient_ID")

p <-ggplot(tdat_ct,aes(y=freq,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")+
  facet_grid(~ metacluster, scales = "free", space = "free")+
   scale_fill_manual(values=mycol)
ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_split_metacluster_caf-category_proportions_K4.pdf")))
plot(p)

write.csv(ct, file=file.path(plot_folder, "patient_groups_k4.csv"))
```

```{r  heatmap metacluster cell category expression proportions}
tdat_ct
tdat_ct_w <-tdat_ct %>% pivot_wider(id_cols = "metacluster",names_from = "Phenotype", values_from = "freq",values_fn = mean)
tdat_ct_w_m <- as.matrix(tdat_ct_w[,-1])
rownames(tdat_ct_w_m) <-tdat_ct_w$metacluster

pheatmap(scale(t(tdat_ct_w_m)))

pheatmap(t(tdat_ct_w_m))

cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
}
 
data_subset_norm <- t(apply(tdat_ct_w_m, 2, cal_z_score))

pdf(file.path(plot_folder, "metacluster_k4_CAF.pdf"))
pheatmap(data_subset_norm)
dev.off()

ggsave(p, file=file.path(plot_folder, "metacluster_k4_CAF.pdf"))

p <- ggplot(tdat_ct, aes(x=as.factor(metacluster), y=freq)) + 
    geom_boxplot(fill="slateblue", alpha=0.2) + 
    facet_wrap(~Phenotype,scales="free_y")+
    xlab("metacluster")
ggsave(p, file=file.path(plot_folder, "metacluster_k4_CAF.pdf"))
tdat_ct %>%
  group_by(metacluster, Phenotype) %>%summarise(Mean=mean(freq*100), Max=max(freq*100), Min=min(freq*100), Median=median(freq*100), Std=sd(freq*100))
```
```{r, fig.width=8, fig.height=8}
chisq_dat <- left_join(tdat_wide_ct, ct)

chisq_dat$Relapse <-factor(chisq_dat$Relapse) 
chisq_dat$Grade <-factor(chisq_dat$Grade)
chisq_dat$DX.name <-factor(chisq_dat$DX.name) 

levels(chisq_dat$Relapse) <- c("No Relapse", "Relapse")
levels(chisq_dat$DX.name) <- c("LUAC", "LUSC")
levels(chisq_dat$Grade) <- c("Grade 1", "Grade 2","Grade 3")

var <- c("DX.name","Grade","Dist.Met","LN.Met","Relapse", "Gender")

for(i in var){
  print(i)
  chisq <- chisq.test(chisq_dat$metacluster, chisq_dat[[i]])
chisq %>% print
chisq$observed

corrplot(chisq$residuals, is.cor = FALSE,col=colorRampPalette(c("white","lightblue","red"))(100))
pdf(file=file.path(plot_folder, paste("Chisq_meta4_",i,".pdf")), width=4, height=4)
corrplot(chisq$residuals, is.cor = FALSE,col=colorRampPalette(c("white","lightblue","red"))(100))

dev.off()
}
```

Differential abundance metaclusters



## **Survival analysis** - Fibro category
Fibro categories (CD4 and CD8) are grouped into "high" and "low" using the proportion's median as a cut-off.    
- high > median  
- low < median  
Patients who received neoadjuvant treatment are excluded from survival analysis.  
```{r  survival data Fibro category proportions high-low, message=FALSE, warning=FALSE, echo=FALSE}
tdat_wide_ct <- left_join(tdat_wide, clinical.data, by="Patient_ID")

neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat,]

#high low by median
surv_dat$Collagen_CAF_G <- ifelse(surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
surv_dat$hypoxic_CAF_G <- ifelse(surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")
surv_dat$mCAF_G <- ifelse(surv_dat$mCAF >summary(surv_dat$mCAF)[3],"mCAF high","mCAF low")
surv_dat$SMA_CAF_G <- ifelse(surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
surv_dat$tpCAF_G <- ifelse(surv_dat$tpCAF >summary(surv_dat$tpCAF)[3],"tpCAF high","tpCAF low")
surv_dat$iCAF_G <- ifelse(surv_dat$iCAF >summary(surv_dat$iCAF)[3],"iCAF high","iCAF low")
surv_dat$vCAF_G <- ifelse(surv_dat$vCAF >summary(surv_dat$vCAF)[3],"vCAF high","vCAF low")
surv_dat$dCAF_G <- ifelse(surv_dat$dCAF >summary(surv_dat$dCAF)[3],"dCAF high","dCAF low")
surv_dat$hypoxic_tpCAF_G <- ifelse(surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
surv_dat$IDO_CAF_G <- ifelse(surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
surv_dat$PDPN_CAF_G <- ifelse(surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")

caf_strat <-surv_dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster")
surv <- "metacluster"
#surv <-"metacluster"
```


#CoxPH for Fibro category proportions corrected for Stage, Grade and M
```{r  Coxph Fibro category proportions, echo=F, message=FALSE, warning=FALSE}
surv_dat
surv_dat<-surv_dat[!surv_dat$OS == 0, ]
time <- surv_dat$OS
status <- surv_dat$censoringOS
surv_dat$metacluster <-as.factor(surv_dat$metacluster)
surv_dat$Grade <-as.numeric(surv_dat$Grade)
rownames(surv_dat) <- surv_dat$Patient_ID
res.cox <- coxph(Surv(time, status) ~ metacluster, data = surv_dat)
res.cox


res.cox <- coxph(Surv(time, status) ~   PDPN_CAF + IDO_CAF+hypoxic_tpCAF+dCAF+vCAF+iCAF+tpCAF+mCAF+hypoxic_CAF+SMA_CAF+Collagen_CAF+Stage+Grade+M.new, data =  surv_dat)

#res.cox <- coxph(Surv(time, status) ~ `CD4+`+tpCAF+iCAF+mCAF+dCAF+vCAF+`SMA+ CAF`+`IDO+ CAF`+`dividing tpCAF`+`hypoxic CAF`+Grade, data =  surv_dat)
summary(res.cox)


td_res = tidy(res.cox, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
td_res <-td_res[td_res$term !="Grade"&
                  td_res$term !="Stage"&
                  td_res$term !="M.new",]

p <-ggplot(td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
#xlim(0,2)+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
#scale_colour_tableau()
  scale_color_jco()
#
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "CAF_coxph.pdf"), width=6, height=4)
```

## Not split by tumour type (AC and SQC together)
```{r  survival Fibro category proportions not split high low, message=FALSE, warning=FALSE, echo=FALSE, fig.height=5, fig.width=5}
#out.width="50%",
tdat_wide_ct <- left_join(tdat_wide, clinical.data, by="Patient_ID")

neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]
surv_dat <- left_join(surv_dat, ct)

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat,]
surv <- "metacluster"
#not split by Tumour Type (AC/SQC)
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
 
#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
print(pw)
print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
   symbols = c("****", "***", "**", "*", "+", "."),
    abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               #conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               palette = "jco",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_OS over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
print(pw)
print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
   symbols = c("****", "***", "**", "*", "+", "."),
   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
#km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=6, height=6)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
```

#clean
#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis clean, fig.width=6, fig.height=4, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor

dat<-tdat_wide_ct %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% as_tibble()
#if necessary: change group_id labels
dat <-left_join(dat, ct)
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]


subtype <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met","Relapse","DX.name")

#define the naming subtype aka Celltype

j <-"metacluster"

plot_list <- list()
for (i in subtype) {
  #for(k in unique(dat$DX.name)){    #uncomment this if you want to split your loop e.g. by tumour type
   # dat.l <-subset(dat, DX.name==k) #uncomment this if you want to split your loop e.g. by tumour type

dat.l <-dat
k="both tumour types" # comment this if you want to split by e.g. tumour type
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = "metacluster", values_from ="metacluster", values_fn = list(metacluster=length),names_prefix = "")

test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "FibroTypes")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(FibroTypes,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Celltype", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)


  #} #uncomment this if you want to split by e.g. tumour type
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save individual pdf plots for each variable
  pdf(file=file.path(plot_folder, paste0("DA_Celltype_n_over_",i,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=FibroTypes))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()

surv_dat
tdat_wide_ct
```

## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
#sce.all <- readRDS(file=file.path(data_folder, "FINAL_All_Clustered_FILTERED_inc_tumour_vessel_immune_CAF_minusOther.rds"))
sce.all$DX.name <- as.factor(sce.all$DX.name)
sce.all$DX.name %>% replace_na("NA")
sce.all$DX.name[is.na(sce.all$DX.name)] <- "NA"

df <- as.data.frame(colData(sce.all[,sce.all$Patient_ID!="Control"&
                                          sce.all$DX.name=="Adenocarcinoma"|
                                          sce.all$DX.name=="Squamous cell carcinoma"]))

#remove neoadj patients
df <-df[df$Patient_ID%in% tdat_wide_ct$Patient_ID,]

categories <- c("metacluster") 
#categories <- c("DX.name", "Grade") 
i <- c("metacluster") 

plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_subtype, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-left_join(t, ct, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(ct)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("KW_W_CAF_TME",i,".pdf")), width=15, height=15)
  gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/5))
 dev.off()
}
```

```{r, fig.width=6,fig.height=4}
sce.all$OS_c <-ifelse(sce.all$OS >1231, "long OS","short OS")
sce.all$DFS_c <-ifelse(sce.all$DFS >1427, "long DFS","short DFS")

library(diffcyt)
library(edgeR)
library(ggplot2)
library(ggthemes)
#BiocManager::install(c("diffcyt", "edgeR"))
#Patient Number must be numeric
library(tidyr)
library(dplyr)
#groupId must be factor
sce.all$DX.name <- as.factor(sce.all$DX.name)
colData(sce.all)<-as.data.frame(colData(sce.all)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(sce.all))

#if necessary: change group_id labels

dat$DX.name <- as.factor(dat$DX.name)

dat <- dat[is.na(dat$DX.name)==F,]
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
dat$DX.name %>% table

subtype <-c("OS_c","DFS_c")

#define the naming subtype aka Celltype

j <-"cell_type"
#subtype="OS_c"
j <- "cell_subtype"
plot_list <- list()

for (i in subtype) {
  #for(k in unique(dat$DX.name)){    #uncomment this if you want to split your loop e.g. by tumour type
   # dat.l <-subset(dat, DX.name==k) #uncomment this if you want to split your loop e.g. by tumour type

dat.l <-dat
k="both tumour types" # comment this if you want to split by e.g. tumour type
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = "cell_subtype", values_from ="cell_subtype", values_fn = list(cell_subtype=length),names_prefix = "")

test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "FibroTypes")
library(ggthemes)
plot_list[[k]] <-
ggplot(t.op, aes(reorder(FibroTypes,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Celltype", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)


  #} #uncomment this if you want to split by e.g. tumour type
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save individual pdf plots for each variable
  pdf(file=file.path(plot_folder, paste0("DA_all_Celltype_n_over_OS",i,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=FibroTypes))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()
```


```{r, fig.width=8, fig.height=8}
df_t <- table(df$cell_subtype, df$Patient_ID)

df_t <- prop.table(df_t, margin=2)
df_t <- as.data.frame(df_t)
colnames(df_t) <- c("Phenotype", "Patient_ID","freq")
df_ct<-left_join(df_t, ct, by.x="Patient_ID", by.y="Patient_ID")
    

head(df_ct)
df_ct_w <- pivot_wider(df_ct,id_cols=c("metacluster"),names_from = "Phenotype", values_from ="freq", values_fn = mean,names_prefix = "")

df_ct_w_m <- as.matrix(df_ct_w[,-1])
rownames(df_ct_w_m) <-df_ct_w$metacluster

pheatmap(scale(t(df_ct_w_m)))

pheatmap(t(df_ct_w_m))


cal_z_score <- function(x){
  (x - mean(x)) / sd(x)
}
 
data_subset_norm <- t(apply(df_ct_w_m, 2, cal_z_score))
pheatmap(data_subset_norm)

pdf(file.path(plot_folder, "metacluster_k4_CAF_TME.pdf"))
pheatmap(data_subset_norm)
dev.off()

#remove CAFs

df_ct_w_s <-df_ct_w %>% select(-contains(c("CAF")))

df_ct_w_s_m <- as.matrix(df_ct_w_s[,-1])
rownames(df_ct_w_s_m) <-df_ct_w_s$metacluster

data_subset_norm <- t(apply(df_ct_w_s_m, 2, cal_z_score))
pheatmap(data_subset_norm)

pdf(file.path(plot_folder, "metacluster_k4_CAF_TME_minusCAF.pdf"))
pheatmap(data_subset_norm)
dev.off()
```


#####
## Split by tumour type (AC and SQC individually)
```{r  survival Fibro category proportions split high low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#OS survival
surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster")

#split by Tumour Type (AC/SQC)
for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
    
dat$Collagen_CAF_G <- ifelse(dat$Collagen_CAF >summary(dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
dat$hypoxic_CAF_G <- ifelse(dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")
dat$mCAF_G <- ifelse(dat$mCAF >summary(dat$mCAF)[3],"mCAF high","mCAF low")
dat$SMA_CAF_G <- ifelse(dat$SMA_CAF >summary(dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
dat$tpCAF_G <- ifelse(dat$tpCAF >summary(dat$tpCAF)[3],"tpCAF high","tpCAF low")
dat$iCAF_G <- ifelse(dat$iCAF >summary(dat$iCAF)[3],"iCAF high","iCAF low")
dat$vCAF_G <- ifelse(dat$vCAF >summary(dat$vCAF)[3],"vCAF high","vCAF low")
dat$dCAF_G <- ifelse(dat$dCAF >summary(dat$dCAF)[3],"dCAF high","dCAF low")
dat$hypoxic_tpCAF_G <- ifelse(dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
dat$IDO_CAF_G <- ifelse(dat$IDO_CAF >summary(dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
dat$PDPN_CAF_G <- ifelse(dat$PDPN_CAF >summary(dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")


caf_strat <-dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat",paste0("CAF_strat_hi_low_proportion_",k,".csv")))

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
   #abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
#km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_OS over",i,"_per_",k,".pdf")), width=4, height=4)
print(p,newpage=FALSE)
dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#PDF
pdf(file=file.path(plot_folder, paste0("Survival_CAF_Prop_hi-low_DFS over",i,"_per_",k,".pdf")), width=4, height=4)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
} 
```

## Lasso-regressed cox-ph model  
Including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high / low as well as the proportion (continuous).   
```{r  coxph Fibro category proportions, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.width=8, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor"))) #))

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)

#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients


#correct
df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_jco()
p
ggsave(plot=p, file=file.path(plot_folder, "Lasso_coxph_CAF_prop.pdf"), width = 8, height = 6)



active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_jco()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-Category_Proportions_high-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))


#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

## Cell groups categorised into "high", "mid", "low".  
- high > 3rd quantile  
- mid >1st quantile and < 3rd quantile  
- low < 1st quantile  
```{r  survival Fibro category proportions classified as high mid low, message=FALSE, warning=FALSE, echo=FALSE}
surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[5]] <-"mCAF high"
surv_dat$mCAF_G[surv_dat$mCAF <=summary(surv_dat$mCAF)[2]] <-"mCAF low"
surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[2]& surv_dat$mCAF<=summary(surv_dat$mCAF)[5]] <-"mCAF medium"

surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[5]] <-"vCAF high"
surv_dat$vCAF_G[surv_dat$vCAF <=summary(surv_dat$vCAF)[2]] <-"vCAF low"
surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[2]& surv_dat$vCAF<=summary(surv_dat$vCAF)[5]] <-"vCAF medium"

surv_dat$tpCAF_G[surv_dat$tpCAF >summary(surv_dat$tpCAF)[5]] <-"tpCAF high"
surv_dat$tpCAF_G[surv_dat$tpCAF <=summary(surv_dat$tpCAF)[2]] <-"tpCAF low"
surv_dat$tpCAF_G[surv_dat$tpCAF >summary(surv_dat$tpCAF)[2]& surv_dat$tpCAF<=summary(surv_dat$tpCAF)[5]] <-"tpCAF medium"

surv_dat$iCAF_G[surv_dat$iCAF >summary(surv_dat$iCAF)[5]] <-"iCAF high"
surv_dat$iCAF_G[surv_dat$iCAF <=summary(surv_dat$iCAF)[2]] <-"iCAF low"
surv_dat$iCAF_G[surv_dat$iCAF >summary(surv_dat$iCAF)[2]& surv_dat$iCAF<=summary(surv_dat$iCAF)[5]] <-"iCAF medium"

surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[5]] <-"dCAF high"
surv_dat$dCAF_G[surv_dat$dCAF <=summary(surv_dat$dCAF)[2]] <-"dCAF low"
surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[2]& surv_dat$dCAF<=summary(surv_dat$dCAF)[5]] <-"dCAF medium"

surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF <=summary(surv_dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[2]& surv_dat$Collagen_CAF<=summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF <=summary(surv_dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[2]& surv_dat$hypoxic_CAF<=summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF high"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF <=summary(surv_dat$SMA_CAF)[2]] <-"SMA_CAF low"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[2]& surv_dat$SMA_CAF<=summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF medium"

surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF <=summary(surv_dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[2]& surv_dat$hypoxic_tpCAF<=summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF high"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF <=summary(surv_dat$IDO_CAF)[2]] <-"IDO_CAF low"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[2]& surv_dat$IDO_CAF<=summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF medium"

surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF <=summary(surv_dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[2]& surv_dat$PDPN_CAF<=summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"

surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster")


caf_strat <-surv_dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat","CAF_strat_hi_mid_low_proportion.csv"))

```

## Survival Fibro category proportions high mid low not split
```{r  survival Fibro category proportions not split high mid low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#not split by Tumour Type (AC/SQC)
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
  
#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
  # symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
  # symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
```

## Survival Fibro category proportions high mid low split by tumour type
```{r  survival Fibro category proportions split high mid low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#split by Tumour Type (AC/SQC)
for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$mCAF_G[dat$mCAF >summary(dat$mCAF)[5]] <-"mCAF high"
dat$mCAF_G[dat$mCAF <=summary(dat$mCAF)[2]] <-"mCAF low"
dat$mCAF_G[dat$mCAF >summary(dat$mCAF)[2]& dat$mCAF<=summary(dat$mCAF)[5]] <-"mCAF medium"

dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[5]] <-"vCAF high"
dat$vCAF_G[dat$vCAF <=summary(dat$vCAF)[2]] <-"vCAF low"
dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[2]& dat$vCAF<=summary(dat$vCAF)[5]] <-"vCAF medium"

dat$tpCAF_G[dat$tpCAF >summary(dat$tpCAF)[5]] <-"tpCAF high"
dat$tpCAF_G[dat$tpCAF <=summary(dat$tpCAF)[2]] <-"tpCAF low"
dat$tpCAF_G[dat$tpCAF >summary(dat$tpCAF)[2]& dat$tpCAF<=summary(dat$tpCAF)[5]] <-"tpCAF medium"

dat$iCAF_G[dat$iCAF >summary(dat$iCAF)[5]] <-"iCAF high"
dat$iCAF_G[dat$iCAF <=summary(dat$iCAF)[2]] <-"iCAF low"
dat$iCAF_G[dat$iCAF >summary(dat$iCAF)[2]& dat$iCAF<=summary(dat$iCAF)[5]] <-"iCAF medium"

dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[5]] <-"dCAF high"
dat$dCAF_G[dat$dCAF <=summary(dat$dCAF)[2]] <-"dCAF low"
dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[2]& dat$dCAF<=summary(dat$dCAF)[5]] <-"dCAF medium"

dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
dat$Collagen_CAF_G[dat$Collagen_CAF <=summary(dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[2]& dat$Collagen_CAF<=summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
dat$hypoxic_CAF_G[dat$hypoxic_CAF <=summary(dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[2]& dat$hypoxic_CAF<=summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[5]] <-"SMA_CAF high"
dat$SMA_CAF_G[dat$SMA_CAF <=summary(dat$SMA_CAF)[2]] <-"SMA_CAF low"
dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[2]& dat$SMA_CAF<=summary(dat$SMA_CAF)[5]] <-"SMA_CAF medium"

dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF <=summary(dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[2]& dat$hypoxic_tpCAF<=summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[5]] <-"IDO_CAF high"
dat$IDO_CAF_G[dat$IDO_CAF <=summary(dat$IDO_CAF)[2]] <-"IDO_CAF low"
dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[2]& dat$IDO_CAF<=summary(dat$IDO_CAF)[5]] <-"IDO_CAF medium"

dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
dat$PDPN_CAF_G[dat$PDPN_CAF <=summary(dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[2]& dat$PDPN_CAF<=summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"


caf_strat <-dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat",paste0("CAF_strat_hi_mid_low_proportion_",k,".csv")))


#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

## Lasso-regressed cox-ph model  
including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high mid low as well as the proportion (continuous).   
```{r  coxph Fibro category proportions high mid low, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=8, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor"))) #)),"AG" #,NT,"Area","TMA_ImageID"

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)


#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_tableau()
p


active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-Category_Proportions_high-mid-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))


#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```



In group comparison (Wilcoxon for 2 groups or KW for >2 groups) for Fibro categories over clinical variables:  
  - T.new (TNM)
  - N (TNM)
  - M.new (TNM)
  - Relapse
  - Grade
  - Stage
  - Gender
  - Typ (Tumour Type)
  - Dist.Met (Distant metastases yes/no)
  - LN.Met (Lymph node metastases yes/no)
  
## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro category proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))

#remove neoadj patients
df <-df[!df$Patient_ID%in% neoadj_pat$Patient_ID,]
categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender") 
#categories <- c("DX.name", "Grade") 

plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-merge(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
  pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Proportions_WOneo",i,".pdf")), width=10, height=6)
  gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/2))
  dev.off()
}
```

## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy SPLIT by tumour type
```{r  KW W Fibro category proportions WO neo SPLIT by tumour type, fig.width=12, fig.height=18, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))

#remove neoadj patients
df <-df[!df$Patient_ID%in% neoadj_pat$Patient_ID,]
categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","Stage","Grade","Gender") 
#categories <- c("DX.name", "Grade") 

plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-merge(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype, DX.name) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
     # facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      facet_grid(Phenotype~DX.name)+
      scale_color_viridis_d()+
      scale_color_tableau()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat$i <-tdat[[i]]
      tdat$i <- as.factor(tdat$i)
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      

      pvalues <- tdat %>% 
      group_by(Phenotype,DX.name) %>% 
      summarise(p=wilcox.test(freq~i, paired=F)$p.value)
      tdat <- left_join(tdat, pvalues, by.x = c("DX.name","Phenotype"), by.y =c("Phenotype","DX.name"), all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      
#res <- tdat %>% group_by(DX.name) %>% 
#       do(w = wilcox.test(freq~i, data=., paired=FALSE)) %>% 
 #      summarise(DX.name, Wilcox = w$p.value)


      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+#.data[[i]]))+
        geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
        facet_grid(Phenotype~DX.name+p.wt)+
        scale_color_tableau()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=3) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_WOneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Phenotype)))
 # dev.off()
}
```


## Neoadjuvantly treated patients are included, the same categories are used plus:  
- NeoAdj (Neoadjuvant therapy yes/no)
- Chemo (Neoadjuvant therapy = chemotherapy)
- Radio (Neoadjuvant therapy = radiotherapy)
#here now
```{r  KW W Fibro category proportions with NEO, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj")
categories <- "Grade"
plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-merge(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      scale_color_jco()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      #labs( y="Proportion")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p <0.05))+#.data[[i]])
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+

        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        #labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        labs(x=paste(i),  fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=4) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
  pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Proportions_Wneo",i,"_new.pdf")), width=10, height=6)
  gridExtra::grid.arrange(grobs = plot_list, ncol=6)#ncol=round(length(unique(t$Phenotype))/2)
  dev.off()
}
```


```{r  KW W Fibro category proportions with NEO SPLIT by tumour type, fig.width=12, fig.height=18, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","Stage","Grade","Gender","Chemo","Radio","NeoAdj")

plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_type, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-merge(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype, DX.name) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
     # facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      facet_grid(Phenotype~DX.name)+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Proportion")+
     theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat$i <-tdat[[i]]
      tdat$i <- as.factor(tdat$i)
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      

      pvalues <- tdat %>% 
      group_by(Phenotype,DX.name) %>% 
      summarise(p=wilcox.test(freq~i, paired=F)$p.value)
      tdat <- left_join(tdat, pvalues, by.x = c("DX.name","Phenotype"), by.y =c("Phenotype","DX.name"), all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+#colour=.data[[i]]
        geom_boxplot()+
        geom_point()+
       # facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
        facet_grid(Phenotype~DX.name+p.wt)+
        scale_color_tableau()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=3) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_WOneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Phenotype)))
 # dev.off()
}
```

## **Fibro category**
## **Densities**
Generally, densities are first calculated per tissue area. For patients with more than 1 image, the average density is calculated subsequently.  
Optimal number of Fibro category densities patients metaclusters:
```{r  Fibro category density optimal number of clusters, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=6, fig.height=4}
#Calculate Densities
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
  #t <-merge(t, clinical.data, by="Patient_ID")
tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

#tdat_wide <-tdat_wide[!tdat_wide$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID

hc <- hclust(dist(tdat_m[,-1]),"ward.D2")

#devtools::install_github("kassambara/factoextra")
library(FactoMineR)
library(factoextra)
sbg <-cutree(hc, k=8)
fviz_cluster(list(data = tdat_wide[,-1], cluster = sbg))

fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "wss", k.max=20)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "gap_stat", k.max=20)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "silhouette", k.max=20)

#install.packages("cluster")
library(cluster)
gap_stat <- clusGap(tdat_wide[,-1], FUN = hcut, nstart = 25, K.max = 10, B = 100)
fviz_gap_stat(gap_stat)

# Compute distance matrix
res.dist <- dist(tdat_wide[,-1], method = "euclidean")
```

```{r  Calculate densities Fibro category, message=FALSE, warning=FALSE, echo=FALSE}
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
  #t <-merge(t, clinical.data, by="Patient_ID")

  #remove super high density outliers (total density >10000)  
 # tdat <-tdat[ !tdat$Patient_ID%in%surv_excl,]

#CAF type distribution over all patients
tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")
tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID


hc <- hclust(dist(tdat_m[,-1]),"ward.D2")
#order Patients after clustering results
tdat_wide$Patient_ID <- factor(tdat_wide$Patient_ID, levels = labels(hc))
tdat$Patient_ID <- factor(tdat$Patient_ID, levels = labels(hc))

#tdat_wide <-tdat_wide[ !tdat_wide$Patient_ID%in%surv_excl,]

```

## Barplot showing absolute density per patietn coloured by Fibro category together with hierarchical clustering tree coloured by patient metaclusters.
```{r Barolot Fibro category densities, fig.width=12, fig.height=6, message=FALSE, warning=FALSE, echo=FALSE}
#barolot (sqrt of density)
p <-ggplot(tdat,aes(y=sqrt(density),x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")#+theme(legend.position = "none")

#barplot total density
p <-ggplot(tdat,aes(y=density,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")#+theme(legend.position = "none")


#coloured dendrogram
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k = 8) %>% as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()
pg <-plot_grid(p1,p, align="v", ncol=1)
pg
##ggsave(plot=pg, file=file.path(plot_folder, paste("Barplot_Tcell-Category-Densities_HC_ordered_dendro.pdf")), width=12, height=6)
```
Add patient metacluster to data and plot clusters separately for better identification
```{r Fibro category densities merge hc, message=FALSE, warning=FALSE, echo=FALSE,fig.width=12, fig.height=6}
clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]

#cut dendrogram, add metacluster info to tdat
ct <-as.data.frame(cutree(hc, k=8))

colnames(ct)<-"metacluster"
ct$metacluster <-as.factor(ct$metacluster)
ct$Patient_ID <- rownames(ct)

tdat_wide_ct <-left_join(tdat_wide, ct, by="Patient_ID")
tdat_wide_ct <- left_join(tdat_wide_ct, clinical.data, by="Patient_ID")
table(tdat_wide_ct$metacluster)

#split barlot by metacluster
tdat_ct <-merge(tdat, ct, by="Patient_ID")
ggplot(tdat_ct,aes(y=density,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")+
  facet_grid(~ metacluster, scales = "free", space = "free")


```

```{r  heatmap metacluster cell category expression density}
tdat_ct
tdat_ct_w <-tdat_ct %>% pivot_wider(id_cols = "metacluster",names_from = "Phenotype", values_from = "density",values_fn = mean)
tdat_ct_w_m <- as.matrix(tdat_ct_w[,-1])
rownames(tdat_ct_w_m) <-tdat_ct_w$metacluster

pheatmap(scale(t(tdat_ct_w_m)))

pheatmap(t(tdat_ct_w_m))
```


## Survival analysis over Fibro category densities high low.  
- High > median
- Low < median
```{r  surv_dat Fibro category densities high low, message=FALSE, warning=FALSE, echo=FALSE}
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat$Patient_ID,]

surv_dat$total_density <- rowSums(surv_dat[,2:12])
#surv_excl <-surv_dat[surv_dat$total_density>10000,]$Patient_ID

#surv_dat <-surv_dat[ !surv_dat$Patient_ID%in%surv_excl]
#high low
surv_dat$Density_G <- ifelse(surv_dat$total_density >summary(surv_dat$total_density)[3],"Density high","Density low")
surv_dat$mCAF_G <- ifelse(surv_dat$mCAF >summary(surv_dat$mCAF)[3],"mCAF high","mCAF low")
surv_dat$vCAF_G <- ifelse(surv_dat$vCAF >summary(surv_dat$vCAF)[3],"vCAF high","vCAF low")
surv_dat$iCAF_G <- ifelse(surv_dat$iCAF >summary(surv_dat$iCAF)[3],"iCAF high","iCAF low")
surv_dat$dCAF_G <- ifelse(surv_dat$dCAF >summary(surv_dat$dCAF)[3],"dCAF high","dCAF low")
surv_dat$tpCAF_G <- ifelse(surv_dat$tpCAF >summary(surv_dat$tpCAF)[3],"tpCAF high","tpCAF low")
surv_dat$hypoxic_tpCAF_G <- ifelse(surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
surv_dat$hypoxic_CAF_G <- ifelse(surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")
surv_dat$Collagen_CAF_G <- ifelse(surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
surv_dat$PDPN_CAF_G <- ifelse(surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")
surv_dat$SMA_CAF_G <- ifelse(surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
surv_dat$IDO_CAF_G <- ifelse(surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")


caf_strat <-surv_dat %>% select(contains(c("_G", "Patient_ID")))
write.csv(caf_strat,file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
```

#CoxPH for Fibro category density corrected for Stage, Grade and M
```{r  Coxph Fibro category density, echo=F, message=FALSE, warning=FALSE}
surv_dat
surv_dat<-surv_dat[!surv_dat$OS == 0, ]
time <- surv_dat$OS
status <- surv_dat$censoringOS
surv_dat$metacluster <-as.factor(surv_dat$metacluster)
surv_dat$Grade <-as.numeric(surv_dat$Grade)
rownames(surv_dat) <- surv_dat$Patient_ID
res.cox <- coxph(Surv(time, status) ~ metacluster, data = surv_dat)
res.cox


res.cox <- coxph(Surv(time, status) ~   IDO_CAF + SMA_CAF+PDPN_CAF +hypoxic_CAF+hypoxic_tpCAF+tpCAF+ dCAF+iCAF+vCAF+mCAF+Collagen_CAF+Stage+Grade+M.new, data =  surv_dat)

#res.cox <- coxph(Surv(time, status) ~ `CD4+`+tpCAF+iCAF+mCAF+dCAF+vCAF+`SMA+ CAF`+`IDO+ CAF`+`dividing tpCAF`+`hypoxic CAF`+Grade, data =  surv_dat)
summary(res.cox)


td_res = tidy(res.cox, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
td_res <-td_res[td_res$term !="Grade"&
                  td_res$term !="Stage"&
                  td_res$term !="M.new",]

p <-ggplot(td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
#xlim(0,2)+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
scale_colour_jco()
#
plot(p)
ggsave(plot=p, file=file.path(plot_folder, "CAF_density_coxph.pdf"), width=6, height=4)
```

## Not split by tumour type (AC and SQC together)
```{r  survival Fibro category densities high low not split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=4}
#Not split
#surv <-c("metacluster")
surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")

#surv <-c("metacluster")
library(survminer)

for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
#OS
km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)

pdf(file=file.path(plot_folder, paste0("Survival_Density-CAF_hi-low_OS over",i,"_per_",k,".pdf")), width=4, height=4)
print(p,newpage=FALSE)
dev.off()


p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))
#km_trt_fit

#disease free survival
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               palette="jco",
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

pdf(file=file.path(plot_folder, paste0("Survival_Density-CAF_hi-low_DFS over",i,"_per_",k,".pdf")), width=4, height=4)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit

pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))
km_trt_fit
}
```

## Split by tumour type (AC and SQC individually)
```{r  survival Fibro category densities high low split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#Split

for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$Density_G <- ifelse(dat$total_density >summary(dat$total_density)[3],"Density high","Density low")
dat$mCAF_G <- ifelse(dat$mCAF >summary(dat$mCAF)[3],"mCAF high","mCAF low")
dat$vCAF_G <- ifelse(dat$vCAF >summary(dat$vCAF)[3],"vCAF high","vCAF low")
dat$iCAF_G <- ifelse(dat$iCAF >summary(dat$iCAF)[3],"iCAF high","iCAF low")
dat$dCAF_G <- ifelse(dat$dCAF >summary(dat$dCAF)[3],"dCAF high","dCAF low")
dat$tpCAF_G <- ifelse(dat$tpCAF >summary(dat$tpCAF)[3],"tpCAF high","tpCAF low")
dat$hypoxic_tpCAF_G <- ifelse(dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
dat$hypoxic_CAF_G <- ifelse(dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")
dat$Collagen_CAF_G <- ifelse(dat$Collagen_CAF >summary(dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
dat$PDPN_CAF_G <- ifelse(dat$PDPN_CAF >summary(dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")
dat$SMA_CAF_G <- ifelse(dat$SMA_CAF >summary(dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
dat$IDO_CAF_G <- ifelse(dat$IDO_CAF >summary(dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")

caf_strat <- dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat", paste0("CAF_strat_hi_low_density_split_",k,".csv")))
  }
}

library(survminer)

for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$Density_G <- ifelse(dat$total_density >summary(dat$total_density)[3],"Density high","Density low")
dat$mCAF_G <- ifelse(dat$mCAF >summary(dat$mCAF)[3],"mCAF high","mCAF low")
dat$vCAF_G <- ifelse(dat$vCAF >summary(dat$vCAF)[3],"vCAF high","vCAF low")
dat$iCAF_G <- ifelse(dat$iCAF >summary(dat$iCAF)[3],"iCAF high","iCAF low")
dat$dCAF_G <- ifelse(dat$dCAF >summary(dat$dCAF)[3],"dCAF high","dCAF low")
dat$tpCAF_G <- ifelse(dat$tpCAF >summary(dat$tpCAF)[3],"tpCAF high","tpCAF low")
dat$hypoxic_tpCAF_G <- ifelse(dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
dat$hypoxic_CAF_G <- ifelse(dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")
dat$Collagen_CAF_G <- ifelse(dat$Collagen_CAF >summary(dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
dat$PDPN_CAF_G <- ifelse(dat$PDPN_CAF >summary(dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")
dat$SMA_CAF_G <- ifelse(dat$SMA_CAF >summary(dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
dat$IDO_CAF_G <- ifelse(dat$IDO_CAF >summary(dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)  
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               palette="jco",
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)

pdf(file=file.path(plot_folder, paste0("Survival_Density-CAF_hi-low_OS over",i,"_per_",k,".pdf")), width=4, height=4)
print(p,newpage=FALSE)
dev.off()


#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               palette="jco",
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

pdf(file=file.path(plot_folder, paste0("Survival_Density-CAF_hi-low_DFS over",i,"_per_",k,".pdf")), width=4, height=4)
print(p,newpage=FALSE)
dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

## Lasso-regressed cox-ph model  
Including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high / low as well as the densities (continuous).   
```{r  coxph Fibro category densities high-low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.width=8, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor"))) #)),"AG" #,NT,"Area","TMA_ImageID"

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)


#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_jco()
p
ggsave(plot=p, file=file.path(plot_folder, "Lasso_coxph_CAF-density.pdf"))

active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
#ggsave(file=file.path(plot_folder, paste("CoxPH_Fibro_Density_high-low_Lasso.pdf")), plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))


#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

## Survival Fibro category densities high-mid-low     
- high    > 3rd quantile   
- mid     > 1st quantile < 3rd quantile   
- low     < 1st quantile   
```{r  surv_dat Fibro category densities high mid low, message=FALSE, warning=FALSE, echo=FALSE}
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat$Patient_ID,]

surv_dat$total_density <- rowSums(surv_dat[,2:12])

#High Med Low
surv_dat$Density_G[surv_dat$total_density >summary(surv_dat$total_density)[5]] <-"Density high"
surv_dat$Density_G[surv_dat$total_density <=summary(surv_dat$total_density)[2]] <-"Density low"
surv_dat$Density_G[surv_dat$total_density >summary(surv_dat$total_density)[2]& surv_dat$total_density<summary(surv_dat$total_density)[5]] <-"Density medium"

surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[5]] <-"mCAF high"
surv_dat$mCAF_G[surv_dat$mCAF <=summary(surv_dat$mCAF)[2]] <-"mCAF low"
surv_dat$mCAF_G[surv_dat$mCAF >summary(surv_dat$mCAF)[2]& surv_dat$mCAF<=summary(surv_dat$mCAF)[5]] <-"mCAF medium"

surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[5]] <-"vCAF high"
surv_dat$vCAF_G[surv_dat$vCAF <=summary(surv_dat$vCAF)[2]] <-"vCAF low"
surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[2]& surv_dat$vCAF<=summary(surv_dat$vCAF)[5]] <-"vCAF medium"

surv_dat$tpCAF_G[surv_dat$tpCAF >summary(surv_dat$tpCAF)[5]] <-"tpCAF high"
surv_dat$tpCAF_G[surv_dat$tpCAF <=summary(surv_dat$tpCAF)[2]] <-"tpCAF low"
surv_dat$tpCAF_G[surv_dat$tpCAF >summary(surv_dat$tpCAF)[2]& surv_dat$tpCAF<=summary(surv_dat$tpCAF)[5]] <-"tpCAF medium"

surv_dat$iCAF_G[surv_dat$iCAF >summary(surv_dat$iCAF)[5]] <-"iCAF high"
surv_dat$iCAF_G[surv_dat$iCAF <=summary(surv_dat$iCAF)[2]] <-"iCAF low"
surv_dat$iCAF_G[surv_dat$iCAF >summary(surv_dat$iCAF)[2]& surv_dat$iCAF<=summary(surv_dat$iCAF)[5]] <-"iCAF medium"

surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[5]] <-"dCAF high"
surv_dat$dCAF_G[surv_dat$dCAF <=summary(surv_dat$dCAF)[2]] <-"dCAF low"
surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[2]& surv_dat$dCAF<=summary(surv_dat$dCAF)[5]] <-"dCAF medium"

surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF <=summary(surv_dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[2]& surv_dat$Collagen_CAF<=summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF <=summary(surv_dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[2]& surv_dat$hypoxic_CAF<=summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF high"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF <=summary(surv_dat$SMA_CAF)[2]] <-"SMA_CAF low"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[2]& surv_dat$SMA_CAF<=summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF medium"

surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF <=summary(surv_dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[2]& surv_dat$hypoxic_tpCAF<=summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF high"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF <=summary(surv_dat$IDO_CAF)[2]] <-"IDO_CAF low"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[2]& surv_dat$IDO_CAF<=summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF medium"

surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF <=summary(surv_dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[2]& surv_dat$PDPN_CAF<=summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"


caf_strat <- dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat", paste0("CAF_strat_hi_mid_low_density.csv")))

surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")
```

## Fibro category densities split by tumour type
```{r  survival Fibro category densities high-mid-low not split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#Not split
surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")
#surv <-"metacluster"
library(survminer)

for (i in surv){
  dat <-surv_dat
  k="AC & SCC together"
#OS
km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_type_hi-med-low_OS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit

#disease free survival
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_type_hi-med-low_DFS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit

pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit
}
```

## Fibro category densities split by tumour type
```{r  survival Fibro category densities high-mid-low split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")

for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$Density_G[dat$total_density >summary(dat$total_density)[5]] <-"Density high"
dat$Density_G[dat$total_density <summary(dat$total_density)[2]] <-"Density low"
dat$Density_G[dat$total_density >summary(dat$total_density)[2]& dat$total_density<summary(dat$total_density)[5]] <-"Density medium"

dat$mCAF_G[dat$mCAF >summary(dat$mCAF)[5]] <-"mCAF high"
dat$mCAF_G[dat$mCAF <=summary(dat$mCAF)[2]] <-"mCAF low"
dat$mCAF_G[dat$mCAF >summary(dat$mCAF)[2]& dat$mCAF<=summary(dat$mCAF)[5]] <-"mCAF medium"

dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[5]] <-"vCAF high"
dat$vCAF_G[dat$vCAF <=summary(dat$vCAF)[2]] <-"vCAF low"
dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[2]& dat$vCAF<=summary(dat$vCAF)[5]] <-"vCAF medium"

dat$tpCAF_G[dat$tpCAF >summary(dat$tpCAF)[5]] <-"tpCAF high"
dat$tpCAF_G[dat$tpCAF <=summary(dat$tpCAF)[2]] <-"tpCAF low"
dat$tpCAF_G[dat$tpCAF >summary(dat$tpCAF)[2]& dat$tpCAF<=summary(dat$tpCAF)[5]] <-"tpCAF medium"

dat$iCAF_G[dat$iCAF >summary(dat$iCAF)[5]] <-"iCAF high"
dat$iCAF_G[dat$iCAF <=summary(dat$iCAF)[2]] <-"iCAF low"
dat$iCAF_G[dat$iCAF >summary(dat$iCAF)[2]& dat$iCAF<=summary(dat$iCAF)[5]] <-"iCAF medium"

dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[5]] <-"dCAF high"
dat$dCAF_G[dat$dCAF <=summary(dat$dCAF)[2]] <-"dCAF low"
dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[2]& dat$dCAF<=summary(dat$dCAF)[5]] <-"dCAF medium"

dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
dat$Collagen_CAF_G[dat$Collagen_CAF <=summary(dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[2]& dat$Collagen_CAF<=summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
dat$hypoxic_CAF_G[dat$hypoxic_CAF <=summary(dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[2]& dat$hypoxic_CAF<=summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[5]] <-"SMA_CAF high"
dat$SMA_CAF_G[dat$SMA_CAF <=summary(dat$SMA_CAF)[2]] <-"SMA_CAF low"
dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[2]& dat$SMA_CAF<=summary(dat$SMA_CAF)[5]] <-"SMA_CAF medium"

dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF <=summary(dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[2]& dat$hypoxic_tpCAF<=summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[5]] <-"IDO_CAF high"
dat$IDO_CAF_G[dat$IDO_CAF <=summary(dat$IDO_CAF)[2]] <-"IDO_CAF low"
dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[2]& dat$IDO_CAF<=summary(dat$IDO_CAF)[5]] <-"IDO_CAF medium"

dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
dat$PDPN_CAF_G[dat$PDPN_CAF <=summary(dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[2]& dat$PDPN_CAF<=summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"


caf_strat <- dat %>% select(contains(c("Patient_ID","_G")))
write.csv(caf_strat, file=file.path(wd,"patient_strat", paste0("CAF_strat_hi_mid_low_density_split_",k,".csv")))

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)  
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])


#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_type_hi-med-low_OS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_type_hi-med-low_DFS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```



## Lasso-regressed cox-ph model   
including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high mid low as well as the densities (continuous).   
```{r coxph Fibro category densities high-mid-low, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=8, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor")))

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)


#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_tableau()
p

active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-Category_Density_high-mid-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))

#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

## Kruskal Wallis / Wilcoxon comparison between groups of clincial variables without neoadjuvant treated patients.
```{r  KW W Fibro category density WO neo,warning=FALSE, message=FALSE, echo=FALSE, fig.width=12, fig.height=8}
#define variables to be tested here
categories <- c( "Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")
#categories <- c("DX.name","Grade")
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[2:12])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:13])), names_to = "Phenotype",values_to = "density")

#remove
tdat <-tdat[!tdat$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_c <-merge(tdat, clinical.data, by="Patient_ID")
categories <- c("Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")
#categories <- c("DX.name","Grade")

plot_list <- list()
for (i in (categories)) {
  for (j in unique(tdat_c$Phenotype)){
    tdat<-tdat_c
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Mean patient density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }
    
     else{
      
        tdat<-tdat_c
        tdat[[i]] <-as.factor(tdat[[i]])
        tdat <-tdat %>% drop_na(i)
        tdat$Phenotype <-factor(tdat$Phenotype)
        tdat$Phenotype <-droplevels(tdat$Phenotype)
        tdat <-tdat %>% drop_na(i)

        tdat <-subset(tdat, Phenotype==j)
          detach("package:dplyr", unload=TRUE)
          library(dplyr)
        
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$density~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))
    
      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=p<0.05))+ #.data[[i]]
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
        #facet_grid(Phenotype~DX.name+p.wt)+
        scale_color_viridis_d()+
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")    }  
 
    }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Densities_WOneo",i,".pdf")), width=12, height=8)
 gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 dev.off()
}
```


```{r  KW W Fibro category density WO neo split by tumour type,warning=FALSE, message=FALSE, echo=FALSE, fig.width=12, fig.height=18}
#define variables to be tested here
categories <- c( "Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")
#categories <- c("DX.name","Grade")
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[2:12])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:13])), names_to = "Phenotype",values_to = "density")

#remove
tdat <-tdat[!tdat$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_c <-merge(tdat, clinical.data, by="Patient_ID")
categories <- c("Dist.Met", "T.new","M.new","N","Relapse","Stage","Grade","Gender")
#categories <- c("DX.name","Grade")

plot_list <- list()


for (i in (categories)) {
  for (j in unique(tdat_c$Phenotype)){
    tdat<-tdat_c
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Mean patient density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }
    
     else{
      
        tdat<-tdat_c
        tdat$i <-tdat[[i]]
        tdat$i <- as.factor(tdat$i)
        tdat[[i]] <-as.factor(tdat[[i]])
        tdat <-tdat %>% drop_na(i)
        tdat$Phenotype <-factor(tdat$Phenotype)
        tdat$Phenotype <-droplevels(tdat$Phenotype)
        tdat <-tdat %>% drop_na(i)

        tdat <-subset(tdat, Phenotype==j)
          detach("package:dplyr", unload=TRUE)
          library(dplyr)
        
      pvalues <- tdat %>% 
      group_by(Phenotype, DX.name) %>% 
      summarise(p=wilcox.test(density~i, paired=F)$p.value)
      tdat <- left_join(tdat, pvalues, by.x = c("Phenotype","DX.name"), by.y =c("Phenotype","DX.name"), all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))
    
      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=p<0.05))+#.data[[i]]
        geom_violin(width=0.5) +
        geom_boxplot(width=0.3, color="grey", alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Phenotype~DX.name+p.wt)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }  
 
    }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=3) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Densities_WOneo",i,".pdf")), width=12, height=8)
 #gridExtra::grid.arrange(grobs = plot_list, ncol=6)
# dev.off()
}


```
## Kruskal Wallis / Wilcoxon comparison between groups of clincial variables with neoadjuvant treated patients.
```{r  KW Wilcox Fibro Category density W neo,warning=FALSE, message=FALSE, echo=FALSE, fig.width=12, fig.height=8}
#define variables to be tested here
categories <- c( "Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")

fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[,2:12])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:13])), names_to = "Phenotype",values_to = "density")

tdat_c <-merge(tdat, clinical.data, by="Patient_ID")
categories <- c("Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj")
plot_list <- list()

for (i in (categories)) {
  for (j in unique(tdat_c$Phenotype)){
    tdat<-tdat_c
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
     stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Mean patient density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }
    
     else{
      
        tdat<-tdat_c
        tdat[[i]] <-as.factor(tdat[[i]])
        tdat <-tdat %>% drop_na(i)
        tdat$Phenotype <-factor(tdat$Phenotype)
        tdat$Phenotype <-droplevels(tdat$Phenotype)
        tdat <-tdat %>% drop_na(i)

        tdat <-subset(tdat, Phenotype==j)
          detach("package:dplyr", unload=TRUE)
          library(dplyr)
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$density~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))
    
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), color=p>0.05))+#.data[[i]]
        geom_violin(width=0.5) +
        geom_boxplot(width=0.3, color="grey", alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        #facet_grid(Phenotype~DX.name+p.wt)+
        #ggtitle("paired")+
        scale_color_viridis_d()+
         scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(T, F)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }  
 
    }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=6) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Densities_Wneo",i,".pdf")), width=12, height=8)
 gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 dev.off()
}
```


```{r  KW Wilcox Fibro Category density W neo split by tumouor,warning=FALSE, message=FALSE, echo=FALSE,fig.width=12, fig.height=18}
#define variables to be tested here
categories <- c( "Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")

fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[,2:12])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:13])), names_to = "Phenotype",values_to = "density")

tdat_c <-merge(tdat, clinical.data, by="Patient_ID")
categories <- c("Dist.Met", "T.new","M.new","N","Relapse","Stage","Grade","Gender","Chemo","Radio","NeoAdj")
plot_list <- list()

for (i in (categories)) {
  for (j in unique(tdat_c$Phenotype)){
    tdat<-tdat_c
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype, DX.name) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      #facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      facet_grid(Phenotype~DX.name)+
      scale_color_viridis_d()+
      theme_bw()+
      labs( y="Mean patient density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }
    
     else{
      
        tdat<-tdat_c
        tdat$i <-tdat[[i]]
        tdat$i <- as.factor(tdat$i)
        tdat[[i]] <-as.factor(tdat[[i]])
        tdat <-tdat %>% drop_na(i)
        tdat$Phenotype <-factor(tdat$Phenotype)
        tdat$Phenotype <-droplevels(tdat$Phenotype)
        tdat <-tdat %>% drop_na(i)

        tdat <-subset(tdat, Phenotype==j)
          detach("package:dplyr", unload=TRUE)
          library(dplyr)
        
      pvalues <- tdat %>% 
      group_by(Phenotype, DX.name) %>% 
      summarise(p=wilcox.test(density~i, paired=F)$p.value)
      tdat <- left_join(tdat, pvalues, by.x = c("Phenotype","DX.name"), by.y =c("Phenotype","DX.name"), all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))
    
      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = sqrt(density), colour=p<0.05))+#colour=.data[[i]]
        geom_violin(width=0.5) +
        geom_boxplot(width=0.3, color="grey", alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        #facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        facet_grid(Phenotype~DX.name+p.wt)+
        #ggtitle("paired")+
        scale_color_tableau()+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }  
 
    }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=3) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("KW_W_CAF_Densities_WOneo",i,".pdf")), width=12, height=8)
 #gridExtra::grid.arrange(grobs = plot_list, ncol=6)
# dev.off()
}


```

```{r}
#proportions
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Squamous cell carcinoma.csv"))
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Adenocarcinoma.csv"))
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
```

```{r}
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))
unique(colnames(df))
table(df$tpCAF_G, df$Collagen_CAF_G)
table(df$tpCAF_G, df$hypoxic_CAF_G)
table(df$tpCAF_G, df$mCAF_G)
table(df$tpCAF_G, df$SMA_CAF_G)
table(df$tpCAF_G, df$tpCAF_G)
table(df$tpCAF_G, df$iCAF_G)
table(df$tpCAF_G, df$vCAF_G)
table(df$tpCAF_G, df$dCAF_G)
table(df$tpCAF_G, df$hypoxic_tpCAF_G)
table(df$tpCAF_G, df$IDO_CAF_G)
table(df$tpCAF_G, df$PDPN_CAF_G)

table(df$Collagen_CAF_G, df$hypoxic_CAF_G)
table(df$Collagen_CAF_G, df$mCAF_G)
table(df$Collagen_CAF_G, df$SMA_CAF_G)
table(df$Collagen_CAF_G, df$tpCAF_G)
table(df$Collagen_CAF_G, df$iCAF_G)
table(df$Collagen_CAF_G, df$vCAF_G)
table(df$Collagen_CAF_G, df$dCAF_G)
table(df$Collagen_CAF_G, df$hypoxic_tpCAF_G)
table(df$Collagen_CAF_G, df$IDO_CAF_G)
table(df$Collagen_CAF_G, df$PDPN_CAF_G)

table(df$hypoxic_CAF_G, df$mCAF_G)
table(df$hypoxic_CAF_G, df$SMA_CAF_G)
table(df$hypoxic_CAF_G, df$tpCAF_G)
table(df$hypoxic_CAF_G, df$iCAF_G)
table(df$hypoxic_CAF_G, df$vCAF_G)
table(df$hypoxic_CAF_G, df$dCAF_G)
table(df$hypoxic_CAF_G, df$hypoxic_tpCAF_G)
table(df$hypoxic_CAF_G, df$IDO_CAF_G)
table(df$hypoxic_CAF_G, df$PDPN_CAF_G)

table(df$mCAF_G, df$SMA_CAF_G)
table(df$mCAF_G, df$tpCAF_G)
table(df$mCAF_G, df$iCAF_G)
table(df$mCAF_G, df$vCAF_G)
table(df$mCAF_G, df$dCAF_G)
table(df$mCAF_G, df$hypoxic_tpCAF_G)
table(df$mCAF_G, df$IDO_CAF_G)
table(df$mCAF_G, df$PDPN_CAF_G)

table(df$iCAF_G, df$tpCAF_G)
table(df$iCAF_G, df$iCAF_G)
table(df$iCAF_G, df$vCAF_G)
table(df$iCAF_G, df$dCAF_G)
table(df$iCAF_G, df$hypoxic_tpCAF_G)
table(df$iCAF_G, df$IDO_CAF_G)
table(df$iCAF_G, df$PDPN_CAF_G)

table(df$vCAF_G, df$dCAF_G)
table(df$vCAF_G, df$hypoxic_tpCAF_G)
table(df$vCAF_G, df$IDO_CAF_G)
table(df$vCAF_G, df$PDPN_CAF_G)

table(df$hypoxic_tpCAF_G, df$IDO_CAF_G)
table(df$hypoxic_tpCAF_G, df$PDPN_CAF_G)

table(df$IDO_CAF_G, df$PDPN_CAF_G)


clinical.data
```

```{r}
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")
#Area_px_Stroma
da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Stroma,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
  #t <-merge(t, clinical.data, by="Patient_ID")

  #remove super high density outliers (total density >10000)  
 # tdat <-tdat[ !tdat$Patient_ID%in%surv_excl,]
#CAF type distribution over all patients

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID


hc <- hclust(dist(tdat_m[,-1]),"ward.D2")
#order Patients after clustering results
tdat_wide$Patient_ID <- factor(tdat_wide$Patient_ID, levels = labels(hc))
tdat$Patient_ID <- factor(tdat$Patient_ID, levels = labels(hc))

#tdat_wide <-tdat_wide[ !tdat_wide$Patient_ID%in%surv_excl,]

```

## All Density here
```{r density all strat high low, fig.width=4, fig.height=4, message=F, warning=F}
#here
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

#Density
#df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
#df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_mid_low_density.csv"))


df$X <-NULL
tdat_n <- tdat %>% 
  group_by(Patient_ID) %>% 
  summarise(density = sum(density))
tdat_n$Phenotype <- "Total Stroma density"
tdat_n$Phenotype <- as.factor(tdat_n$Phenotype)
hl_m <- left_join(tdat, df, by="Patient_ID")
hl_m <- left_join(tdat_n, df, by="Patient_ID")

ac_sqc <- clinical.data[clinical.data$DX.name=="Adenocarcinoma"|clinical.data$DX.name=="Squamous cell carcinoma",]$Patient_ID
hl_m <- hl_m[hl_m$Patient_ID %in% ac_sqc,]

categories <- c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G") #,"Density_G"
plot_list <- list()


for (i in (categories)) {
hl_m <- left_join(tdat_n, df, by="Patient_ID")
hl_m <- hl_m[hl_m$Patient_ID %in% ac_sqc,]

  for (j in unique(hl_m$Phenotype)){
    df_l<-hl_m
    df_l[[i]] <-as.factor(df_l[[i]])
    df_l <-df_l %>% drop_na(i)
    df_l$i <-as.factor(df_l[[i]])
    df_l$Phenotype <-droplevels(df_l$Phenotype)

    df_l <-subset(df_l, Phenotype==j)

    if (length(unique(df_l[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- df_l%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
    #create plot list
    plot_list[[j]]<-
      ggplot(df_l, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_tableau()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
if(length(unique(df_l[[i]])) == 2){
    
      df_l<-hl_m
      df_l$i <- df_l[[i]]
      df_l$i <-as.factor(df_l$i)
      df_l[[i]] <-as.factor(df_l[[i]])
      df_l <-df_l %>% drop_na(i)
      df_l$Phenotype <-droplevels(df_l$Phenotype)
      df_l <- left_join(df_l, clinical.data, by="Patient_ID")
      df_l <-subset(df_l, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- df_l %>% 
      #group_by(Phenotype,Grade) %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(density~i, paired=F)$p.value)
     # df_l <- merge(df_l, pvalues, by.x = c("Phenotype","Grade"), by.y =c("Phenotype","Grade"), all.x = TRUE)
      df_l <- merge(df_l, pvalues, by.x = c("Phenotype"), by.y =c("Phenotype"), all.x = TRUE)
      df_l$p.wt <- paste0('p=',round(df_l$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(df_l, aes(x= .data[[i]], y = sqrt(density), colour=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        #facet_grid(Phenotype~Grade+p.wt)+
        #ggtitle("paired")+
        scale_color_tableau()+
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }  
    }
   }  
#print(categories)
  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=1) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("tcell_category_Density_Wo-NeoAdj",i,".pdf")))
 # gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 # dev.off()
}
```
## SQC Density
```{r density all strat high low, fig.width=4, fig.height=4, message=F, warning=F}
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Squamous cell carcinoma.csv"))

#Density
#df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
#df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_mid_low_density.csv"))


df$X <-NULL
tdat_n <- tdat %>% 
  group_by(Patient_ID) %>% 
  summarise(density = sum(density))
tdat_n$Phenotype <- "Total Stroma density"
tdat_n$Phenotype <- as.factor(tdat_n$Phenotype)
hl_m <- left_join(tdat, df, by="Patient_ID")
hl_m <- left_join(tdat_n, df, by="Patient_ID")

ac_sqc <- clinical.data[clinical.data$DX.name=="Squamous cell carcinoma",]$Patient_ID
hl_m <- hl_m[hl_m$Patient_ID %in% ac_sqc,]

categories <- c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G") #,"Density_G"
plot_list <- list()


for (i in (categories)) {
hl_m <- left_join(tdat_n, df, by="Patient_ID")
hl_m <- hl_m[hl_m$Patient_ID %in% ac_sqc,]

  for (j in unique(hl_m$Phenotype)){
    df_l<-hl_m
    df_l[[i]] <-as.factor(df_l[[i]])
    df_l <-df_l %>% drop_na(i)
    df_l$i <-as.factor(df_l[[i]])
    df_l$Phenotype <-droplevels(df_l$Phenotype)

    df_l <-subset(df_l, Phenotype==j)

    if (length(unique(df_l[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- df_l%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
    #create plot list
    plot_list[[j]]<-
      ggplot(df_l, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_tableau()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
if(length(unique(df_l[[i]])) == 2){
    
      df_l<-hl_m
      df_l$i <- df_l[[i]]
      df_l$i <-as.factor(df_l$i)
      df_l[[i]] <-as.factor(df_l[[i]])
      df_l <-df_l %>% drop_na(i)
      df_l$Phenotype <-droplevels(df_l$Phenotype)
      df_l <- left_join(df_l, clinical.data, by="Patient_ID")
      df_l <-subset(df_l, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- df_l %>% 
     # group_by(Phenotype,Grade) %>% 
      group_by(Phenotype) %>%   
      summarise(p=wilcox.test(density~i, paired=F)$p.value)
     # df_l <- merge(df_l, pvalues, by.x = c("Phenotype","Grade"), by.y =c("Phenotype","Grade"), all.x = TRUE)
      df_l <- merge(df_l, pvalues, by.x = c("Phenotype"), by.y =c("Phenotype"), all.x = TRUE)
      df_l$p.wt <- paste0('p=',round(df_l$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(df_l, aes(x= .data[[i]], y = sqrt(density), colour=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        #facet_grid(Phenotype~Grade+p.wt)+
        #ggtitle("paired")+
        scale_color_tableau()+
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }  
 
    }
   }  
#print(categories)
  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=1) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("tcell_category_Density_Wo-NeoAdj",i,".pdf")))
 # gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 # dev.off()
}
```

## AC Density
```{r density all strat high low, fig.width=4, fig.height=4, message=F, warning=F}
df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion_Adenocarcinoma.csv"))

#Density
#df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_lo_density.csv"))
#df <- read.csv(file=file.path(wd,"patient_strat","CAF_strat_hi_mid_low_density.csv"))


df$X <-NULL
tdat_n <- tdat %>% 
  group_by(Patient_ID) %>% 
  summarise(density = sum(density))
tdat_n$Phenotype <- "Total Stroma density"
tdat_n$Phenotype <- as.factor(tdat_n$Phenotype)
hl_m <- left_join(tdat, df, by="Patient_ID")
hl_m <- left_join(tdat_n, df, by="Patient_ID")

ac_sqc <- clinical.data[clinical.data$DX.name=="Adenocarcinoma",]$Patient_ID
hl_m <- hl_m[hl_m$Patient_ID %in% ac_sqc,]

categories <- c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G") #,"Density_G"
plot_list <- list()


for (i in (categories)) {
hl_m <- left_join(tdat_n, df, by="Patient_ID")
hl_m <- hl_m[hl_m$Patient_ID %in% ac_sqc,]

  for (j in unique(hl_m$Phenotype)){
    df_l<-hl_m
    df_l[[i]] <-as.factor(df_l[[i]])
    df_l <-df_l %>% drop_na(i)
    df_l$i <-as.factor(df_l[[i]])
    df_l$Phenotype <-droplevels(df_l$Phenotype)

    df_l <-subset(df_l, Phenotype==j)

    if (length(unique(df_l[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- df_l%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   stat.test$y.position <-sqrt(stat.test$y.position)
    #create plot list
    plot_list[[j]]<-
      ggplot(df_l, aes(x= .data[[i]], y = sqrt(density), colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_tableau()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
if(length(unique(df_l[[i]])) == 2){
    
      df_l<-hl_m
      df_l$i <- df_l[[i]]
      df_l$i <-as.factor(df_l$i)
      df_l[[i]] <-as.factor(df_l[[i]])
      df_l <-df_l %>% drop_na(i)
      df_l$Phenotype <-droplevels(df_l$Phenotype)
      df_l <- left_join(df_l, clinical.data, by="Patient_ID")
      df_l <-subset(df_l, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- df_l %>% 
     # group_by(Phenotype,Grade) %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(density~i, paired=F)$p.value)
     # df_l <- merge(df_l, pvalues, by.x = c("Phenotype","Grade"), by.y =c("Phenotype","Grade"), all.x = TRUE)
      df_l <- merge(df_l, pvalues, by.x = c("Phenotype"), by.y =c("Phenotype"), all.x = TRUE)
      df_l$p.wt <- paste0('p=',round(df_l$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(df_l, aes(x= .data[[i]], y = sqrt(density), colour=p<0.05))+#.data[[i]]
        #geom_violin(width=0.5) +
        geom_boxplot(width=0.3, alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        #facet_grid(Phenotype~Grade+p.wt)+
        #ggtitle("paired")+
        scale_color_tableau()+
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),legend.position = "none")
    }  
 
    }
   }  
#print(categories)
  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=1) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("tcell_category_Density_Wo-NeoAdj",i,".pdf")))
 # gridExtra::grid.arrange(grobs = plot_list, ncol=6)
 # dev.off()
}
```

#Distance binning
```{r, Distance binning}
dat.fibro <-as_tibble(colData(fibro.sce_pat.roi))
#dat.fibro$Distance <- dat.fibro$Compartment
dat.fibro$cell_type <-factor(dat.fibro$cell_type)
#comp
dat.fibro$Distance_comp <- cut(dat.fibro$Compartment, breaks=c((-10000000), 0, 10000000), labels=c( "Stroma", "Tumour"))

#10px
dat.fibro$Distance_30px <- cut(dat.fibro$Compartment, breaks=c(-10000, -150, -120, -90,-60, -30, 0, 30, 60, 90, 1000), labels=c("<(-150)","-150 - (-120)", "-120 - (-90)", "-90 - (-60)", "-60 - (-30)", "-30 - 0", "0 - 30", "30 - 60", "60 - 90", ">90" ))
dat.fibro$Distance_30px <- factor(dat.fibro$Distance_30px, levels = c("<(-150)","-150 - (-120)", "-120 - (-90)", "-90 - (-60)", "-60 - (-30)", "-30 - 0", "0 - 30", "30 - 60", "60 - 90", ">90"))

```

#looping through distances based on phenotype
```{r, looping through distances, fig.height=12, fig.width=25}
#dat.fibro <-as_tibble(colData(sub.sce))
#get distance binning from column names
categories <- grep("Distance_", names(dat.fibro), value=TRUE)
categories <- c("Distance_30px")
i <- c("Distance_30px")

df <- dat.fibro

plot_list <- list()

for (i in (categories)) {
  #plot_list <-list()
  t<- table(df$cell_type, df$Patient_ID, as.matrix(df[[i]]))
  t <-as.data.frame(t)
  colnames(t) <- c("Phenotype", "Patient", i,"n")
  t$Phenotype <-factor(t$Phenotype)
  t[[i]] <-factor(t[[i]], levels=levels(df[[i]]))
   #calculate frequency over Phenotype
  t<-t %>%
    #dplyr::count(Phenotype, i,Patient) %>%
    dplyr::group_by(Patient) %>%
    dplyr::mutate(freq = n / sum(n))
  
  tdat<-t
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat <-subset(tdat, Phenotype==j)
    tdat$i <-tdat[[i]]
    
    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs(x="Distance", y="Proportion", fill="Area_Phenotype")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
     # stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
    else {
      tdat <-subset(tdat, Phenotype==j)
  detach("package:dplyr", unload=TRUE)
      library(dplyr)
  pvalues <- tdat %>% 
  group_by(Phenotype) %>% 
  summarise(p=wilcox.test(freq~i)$p.value)
  tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
  tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

  #Plot list, all js together over i
  plot_list[[j]]<-
    ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
    geom_boxplot()+
    geom_point()+
    facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
    theme(axis.title.x=element_text("Phenotype"))+
    scale_color_viridis_d()+
    theme_bw()+
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
    labs(x="Distance", y="Proportion", fill="Area_Phenotype")+
    theme(axis.text.x =element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
    theme(legend.position = "none")
    }
   }  
  #plot
  suppressWarnings(gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/2)))
  
  #save out in individual pdfs for each variable
  #pdf(file=file.path(results_folder, paste0("CAF_Type_",i,"_new.pdf")),width=12, height=6)
  #gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/2))
  #dev.off()
} 
```



#looping through phenotypes based on distances
```{r, looping through distances, fig.height=12, fig.width=25}
#dat.fibro <-as_tibble(colData(sub.sce))
#get distance binning from column names
categories <- grep("Distance_", names(dat.fibro), value=TRUE)
categories <- c("Distance_comp")
i <- c("Distance_30px")
categories <- c("Distance_30px")

df <- dat.fibro

plot_list <- list()





for (i in (categories)) {
  #plot_list <-list()
  t<- table(df$cell_type, df$Patient_ID,df[[i]])
  t <-as.data.frame(t)
  colnames(t) <- c("Phenotype", "Patient", i,"n")
  t$Phenotype <-factor(t$Phenotype)
  t[[i]] <-factor(t[[i]], levels=levels(df[[i]]))
   #calculate frequency over Phenotype
  t<-t %>%
    #dplyr::count(Phenotype, i,Patient) %>%
    dplyr::group_by(Patient, Distance_30px) %>%
    dplyr::mutate(freq = n / sum(n))
  t$freq[is.na(t$freq)==T] <-0
  tdat<-t
  
  for (j in unique(t$Distance_30px)){
    tdat<-t
    tdat <-subset(tdat, Distance_30px==j)
    tdat$i <-tdat$Phenotype
    
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Distance_30px) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= Phenotype, y = freq, colour=Phenotype))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Distance_30px, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs(x="Distance", y="Proportion", fill="Area_Phenotype")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
    # stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
   
  #plot
  suppressWarnings(gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/2)))
  
  #save out in individual pdfs for each variable
  #pdf(file=file.path(results_folder, paste0("CAF_Type_",i,"_new.pdf")),width=12, height=6)
  #gridExtra::grid.arrange(grobs = plot_list, ncol=round(length(unique(t$Phenotype))/2))
  #dev.off()
} 

dat.fibro %>%
  select(Patient_ID,CellType, Compartment) %>%
  group_by(CellType) %>%
 summarise(across( fun=mean))


dat.fibro %>%
  group_by(CellType) %>%
  summarise(mean = mean(Compartment), n = n())

summary(dat.fibro$Compartment)
stat(dat.fibro$Compartment, dat.fibro$CellType)
```
########################################################################################################################################################

##Analysis
#Proportions Fibro CATEGORY

## **Analysis**
In the following, only tumours that were identified as adenocarcinomas or squamous cell carcinomas by pathologists will be used.

## **Fibro Category**

## **Proportions**
Optimal number of patient metaclusters Fibro category proportions
```{r  optimal number of clusters for non Fibro category subtype proportion clusters, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=6, fig.height=4}
#Calculate Proportions
neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
tdat <-as.data.frame(table( fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$cell_subtype))


colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_wide <-tdat_wide[!tdat_wide$Patient_ID%in% neoadj_pat$Patient_ID,]
tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID
#tdat_m <-tdat_m[,1:2]
hc <- hclust(dist(tdat_m[,-1], method="euclidian"),"ward.D2")

#devtools::install_github("kassambara/factoextra")
sbg <-cutree(hc, k=2)
fviz_cluster(list(data = tdat_wide[,-1], cluster = sbg))

fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "wss", k.max=15)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "gap_stat", k.max=15)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "silhouette", k.max=15)

#install.packages("cluster")
gap_stat <- clusGap(tdat_wide[,-1], FUN = hcut, nstart = 25, K.max = 10, B = 100)
fviz_gap_stat(gap_stat)

# Compute distance matrix
#res.dist <- dist(tdat_wide[,-1], method = "euclidean")
```

## Patients are ordered by hierarchical clustering (euclidian, wards.D2)
```{r  Fibro subtype proportions ordered by hierarchical clustering, message=FALSE, warning=FALSE, echo=FALSE}
tdat <-as.data.frame(table( fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID

hc <- hclust(dist(tdat_m[,-1], method="euclidian"),"ward.D2")
tdat_wide$Patient_ID <- factor(tdat_wide$Patient_ID, levels = hc$labels[hc$order])
tdat$Patient_ID <- factor(tdat$Patient_ID, levels = hc$labels[hc$order])

tdat_wide
```

Patient based metaclusters split by metacluster
```{r  Barplot Fibro subtype proportions, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
#Barplot proportions ordered by
p <-ggplot(tdat,aes(x=freq, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")
#plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-Category_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k = 14) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat,aes(x=n, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
##ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_cell_subtype_proportions.pdf")), width=6, height=6)
```

```{r  merge hc metacluster into t_dat Fibro subtype proportions, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]

#cut dendrogram, add metacluster info to tdat
ct <-as.data.frame(cutree(hc, k= 10))

colnames(ct)<-"metacluster"
ct$metacluster <-as.factor(ct$metacluster)
ct$Patient_ID <- rownames(ct)

tdat_wide_ct <-left_join(tdat_wide, ct, by="Patient_ID")
tdat_wide_ct <- left_join(tdat_wide_ct, clinical.data, by="Patient_ID")
table(tdat_wide_ct$metacluster)

#split barlot by metacluster
tdat_ct <-merge(tdat, ct, by="Patient_ID")

p <-ggplot(tdat_ct,aes(y=freq,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")+
  facet_grid(~ metacluster, scales = "free", space = "free")
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_split_metacluster_tcell-category_proportions.pdf")))
plot(p)
```


## **Survival analysis** - Fibro category
Fibro categories (CD4 and CD8) are grouped into "high" and "low" using the proportion's median as a cut-off.    
- high > median  
- low < median  
Patients who received neoadjuvant treatment are excluded from survival analysis.  
```{r  survival data Fibro subtype proportions high-low, message=FALSE, warning=FALSE, echo=FALSE}
neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat,]

#high low by median
surv_dat$Collagen_CAF_G <- ifelse(surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
surv_dat$hypoxic_CAF_G <- ifelse(surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")

surv_dat$mCAF_MMP11_G <- ifelse(surv_dat$mCAF_MMP11 >summary(surv_dat$mCAF_MMP11)[3],"mCAF_MMP11 high","mCAF_MMP11 low")
surv_dat$mCAF_Col_Cdh_G <- ifelse(surv_dat$mCAF_Col_Cdh >summary(surv_dat$mCAF_Col_Cdh)[3],"mCAF_Col_Cdh high","mCAF_Col_Cdh low")

surv_dat$SMA_CAF_G <- ifelse(surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")

surv_dat$tpCAF_CD10_G <- ifelse(surv_dat$tpCAF_CD10 >summary(surv_dat$tpCAF_CD10)[3],"tpCAF_CD10 high","tpCAF_CD10 low")
surv_dat$tpCAF_CD73_G <- ifelse(surv_dat$tpCAF_CD73 >summary(surv_dat$tpCAF_CD73)[3],"tpCAF_CD73 high","tpCAF_CD73 low")

surv_dat$iCAF_CD248_G <- ifelse(surv_dat$iCAF_CD248 >summary(surv_dat$iCAF_CD248)[3],"iCAF_CD248 high","iCAF_CD248 low")
surv_dat$iCAF_CD34_G <- ifelse(surv_dat$iCAF_CD34 >summary(surv_dat$iCAF_CD34)[3],"iCAF_CD34 high","iCAF_CD34 low")

surv_dat$vCAF_G <- ifelse(surv_dat$vCAF >summary(surv_dat$vCAF)[3],"vCAF high","vCAF low")
surv_dat$dCAF_G <- ifelse(surv_dat$dCAF >summary(surv_dat$dCAF)[3],"dCAF high","dCAF low")
surv_dat$hypoxic_tpCAF_G <- ifelse(surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
surv_dat$IDO_CAF_G <- ifelse(surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
surv_dat$PDPN_CAF_G <- ifelse(surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")

surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","tpCAF_CD10_G","tpCAF_CD73_G","SMA_CAF_G","mCAF_MMP11_G","mCAF_Col_Cdh_G","hypoxic_CAF_G","Collagen_CAF_G","iCAF_CD34_G", "iCAF_CD248_G","metacluster")
```


#CoxPH for Fibro category proportions corrected for Stage, Grade and M
```{r  Coxph Fibro subtype proportions, echo=F, message=FALSE, warning=FALSE}
surv_dat
surv_dat<-surv_dat[!surv_dat$OS == 0, ]
time <- surv_dat$OS
status <- surv_dat$censoringOS
surv_dat$metacluster <-as.factor(surv_dat$metacluster)
surv_dat$Grade <-as.numeric(surv_dat$Grade)
rownames(surv_dat) <- surv_dat$Patient_ID
res.cox <- coxph(Surv(time, status) ~ metacluster, data = surv_dat)
res.cox


res.cox <- coxph(Surv(time, status) ~   mCAF_MMP11+PDPN_CAF +mCAF_Col_Cdh+iCAF_CD34+iCAF_CD248+ IDO_CAF+hypoxic_tpCAF+dCAF+vCAF+tpCAF_CD10+tpCAF_CD73+hypoxic_CAF+SMA_CAF+Collagen_CAF+ Stage+Grade+M.new, data =  surv_dat)

#res.cox <- coxph(Surv(time, status) ~ `CD4+`+tpCAF+iCAF+mCAF+dCAF+vCAF+`SMA+ CAF`+`IDO+ CAF`+`dividing tpCAF`+`hypoxic CAF`+Grade, data =  surv_dat)
summary(res.cox)


td_res = tidy(res.cox, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
td_res <-td_res[td_res$term !="Grade"&
                  td_res$term !="Stage"&
                  td_res$term !="M.new",]

p <-ggplot(td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
#xlim(0,2)+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
#
plot(p)
```

## Not split by tumour type (AC and SQC together)
```{r  survival Fibro subtype proportions not split high low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#not split by Tumour Type (AC/SQC)
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
  
#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
```

## Split by tumour type (AC and SQC individually)
```{r  survival Fibro subtype proportions split high low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#OS survival
surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","tpCAF_CD10_G","tpCAF_CD73_G","SMA_CAF_G","mCAF_MMP11_G","mCAF_Col_Cdh_G","hypoxic_CAF_G","Collagen_CAF_G","iCAF_CD34_G", "iCAF_CD248_G","metacluster")

#split by Tumour Type (AC/SQC)
for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
    
dat$Collagen_CAF_G <- ifelse(dat$Collagen_CAF >summary(dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
dat$hypoxic_CAF_G <- ifelse(dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")

dat$mCAF_MMP11_G <- ifelse(dat$mCAF_MMP11 >summary(dat$mCAF_MMP11)[3],"mCAF_MMP11 high","mCAF_MMP11 low")
dat$mCAF_Col_Cdh_G <- ifelse(dat$mCAF_Col_Cdh >summary(dat$mCAF_Col_Cdh)[3],"mCAF_Col_Cdh high","mCAF_Col_Cdh low")

dat$SMA_CAF_G <- ifelse(dat$SMA_CAF >summary(dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")

dat$tpCAF_CD10_G <- ifelse(dat$tpCAF_CD10 >summary(dat$tpCAF_CD10)[3],"tpCAF_CD10 high","tpCAF_CD10 low")
dat$tpCAF_CD73_G <- ifelse(dat$tpCAF_CD73 >summary(dat$tpCAF_CD73)[3],"tpCAF_CD73 high","tpCAF_CD73 low")

dat$iCAF_CD248_G <- ifelse(dat$iCAF_CD248 >summary(dat$iCAF_CD248)[3],"iCAF_CD248 high","iCAF_CD248 low")
dat$iCAF_CD34_G <- ifelse(dat$iCAF_CD34 >summary(dat$iCAF_CD34)[3],"iCAF_CD34 high","iCAF_CD34 low")

dat$vCAF_G <- ifelse(dat$vCAF >summary(dat$vCAF)[3],"vCAF high","vCAF low")
dat$dCAF_G <- ifelse(dat$dCAF >summary(dat$dCAF)[3],"dCAF high","dCAF low")
dat$hypoxic_tpCAF_G <- ifelse(dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
dat$IDO_CAF_G <- ifelse(dat$IDO_CAF >summary(dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
dat$PDPN_CAF_G <- ifelse(dat$PDPN_CAF >summary(dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
   #abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

## Lasso-regressed cox-ph model  
Including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high / low as well as the proportion (continuous).   
```{r  coxph Fibro subtype proportions, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.width=6, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor"))) #))

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)

#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correrct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_tableau()
p

active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-Category_Proportions_high-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))


#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

## Cell groups categorised into "high", "mid", "low".  
- high > 3rd quantile  
- mid >1st quantile and < 3rd quantile  
- low < 1st quantile  
```{r  survival Fibro subtype proportions classified as high mid low, message=FALSE, warning=FALSE, echo=FALSE}
surv_dat$mCAF_Col_Cdh_G[surv_dat$mCAF_Col_Cdh >summary(surv_dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh high"
surv_dat$mCAF_Col_Cdh_G[surv_dat$mCAF_Col_Cdh <=summary(surv_dat$mCAF_Col_Cdh)[2]] <-"mCAF_Col_Cdh low"
surv_dat$mCAF_Col_Cdh_G[surv_dat$mCAF_Col_Cdh >summary(surv_dat$mCAF_Col_Cdh)[2]& surv_dat$mCAF_Col_Cdh<=summary(surv_dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh medium"

surv_dat$mCAF_MMP11_G[surv_dat$mCAF_MMP11 >summary(surv_dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 high"
surv_dat$mCAF_MMP11_G[surv_dat$mCAF_MMP11 <=summary(surv_dat$mCAF_MMP11)[2]] <-"mCAF_MMP11 low"
surv_dat$mCAF_MMP11_G[surv_dat$mCAF_MMP11 >summary(surv_dat$mCAF_MMP11)[2]& surv_dat$mCAF_MMP11<=summary(surv_dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 medium"

surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[5]] <-"vCAF high"
surv_dat$vCAF_G[surv_dat$vCAF <=summary(surv_dat$vCAF)[2]] <-"vCAF low"
surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[2]& surv_dat$vCAF<=summary(surv_dat$vCAF)[5]] <-"vCAF medium"

surv_dat$tpCAF_CD10_G[surv_dat$tpCAF_CD10 >summary(surv_dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 high"
surv_dat$tpCAF_CD10_G[surv_dat$tpCAF_CD10 <=summary(surv_dat$tpCAF_CD10)[2]] <-"tpCAF_CD10 low"
surv_dat$tpCAF_CD10_G[surv_dat$tpCAF_CD10 >summary(surv_dat$tpCAF_CD10)[2]& surv_dat$tpCAF_CD10<=summary(surv_dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 medium"

surv_dat$tpCAF_CD73_G[surv_dat$tpCAF_CD73 >summary(surv_dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 high"
surv_dat$tpCAF_CD73_G[surv_dat$tpCAF_CD73 <=summary(surv_dat$tpCAF_CD73)[2]] <-"tpCAF_CD73 low"
surv_dat$tpCAF_CD73_G[surv_dat$tpCAF_CD73 >summary(surv_dat$tpCAF_CD73)[2]& surv_dat$tpCAF_CD73<=summary(surv_dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 medium"

surv_dat$iCAF_CD34_G[surv_dat$iCAF_CD34 >summary(surv_dat$iCAF_CD34)[5]] <-"iCAF_CD34 high"
surv_dat$iCAF_CD34_G[surv_dat$iCAF_CD34 <=summary(surv_dat$iCAF_CD34)[2]] <-"iCAF_CD34 low"
surv_dat$iCAF_CD34_G[surv_dat$iCAF_CD34 >summary(surv_dat$iCAF_CD34)[2]& surv_dat$iCAF_CD34<=summary(surv_dat$iCAF_CD34)[5]] <-"iCAF_CD34 medium"

surv_dat$iCAF_CD248_G[surv_dat$iCAF_CD248 >summary(surv_dat$iCAF_CD248)[5]] <-"iCAF_CD248 high"
surv_dat$iCAF_CD248_G[surv_dat$iCAF_CD248 <=summary(surv_dat$iCAF_CD248)[2]] <-"iCAF_CD248 low"
surv_dat$iCAF_CD248_G[surv_dat$iCAF_CD248 >summary(surv_dat$iCAF_CD248)[2]& surv_dat$iCAF_CD248<=summary(surv_dat$iCAF_CD248)[5]] <-"iCAF_CD248 medium"

surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[5]] <-"dCAF high"
surv_dat$dCAF_G[surv_dat$dCAF <=summary(surv_dat$dCAF)[2]] <-"dCAF low"
surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[2]& surv_dat$dCAF<=summary(surv_dat$dCAF)[5]] <-"dCAF medium"

surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF <=summary(surv_dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[2]& surv_dat$Collagen_CAF<=summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF <=summary(surv_dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[2]& surv_dat$hypoxic_CAF<=summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF high"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF <=summary(surv_dat$SMA_CAF)[2]] <-"SMA_CAF low"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[2]& surv_dat$SMA_CAF<=summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF medium"

surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF <=summary(surv_dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[2]& surv_dat$hypoxic_tpCAF<=summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF high"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF <=summary(surv_dat$IDO_CAF)[2]] <-"IDO_CAF low"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[2]& surv_dat$IDO_CAF<=summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF medium"

surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF <=summary(surv_dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[2]& surv_dat$PDPN_CAF<=summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"

surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","SMA_CAF_G","hypoxic_CAF_G","Collagen_CAF_G","tpCAF_CD73_G","tpCAF_CD10_G","mCAF_Col_Cdh_G","mCAF_MMP11_G","iCAF_CD34_G", "iCAF_CD248_G", "metacluster")

```

## Survival Fibro category proportions high mid low not split
```{r  survival Fibro subtype proportions not split high mid low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#not split by Tumour Type (AC/SQC)
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
  
#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
  # symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
  # symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
```

## Survival Fibro category proportions high mid low split by tumour type
```{r  survival Fibro subtype proportions split high mid low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#split by Tumour Type (AC/SQC)
for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$mCAF_Col_Cdh_G[dat$mCAF_Col_Cdh >summary(dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh high"
dat$mCAF_Col_Cdh_G[dat$mCAF_Col_Cdh <=summary(dat$mCAF_Col_Cdh)[2]] <-"mCAF_Col_Cdh low"
dat$mCAF_Col_Cdh_G[dat$mCAF_Col_Cdh >summary(dat$mCAF_Col_Cdh)[2]& dat$mCAF_Col_Cdh<=summary(dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh medium"

dat$mCAF_MMP11_G[dat$mCAF_MMP11 >summary(dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 high"
dat$mCAF_MMP11_G[dat$mCAF_MMP11 <=summary(dat$mCAF_MMP11)[2]] <-"mCAF_MMP11 low"
dat$mCAF_MMP11_G[dat$mCAF_MMP11 >summary(dat$mCAF_MMP11)[2]& dat$mCAF_MMP11<=summary(dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 medium"

dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[5]] <-"vCAF high"
dat$vCAF_G[dat$vCAF <=summary(dat$vCAF)[2]] <-"vCAF low"
dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[2]& dat$vCAF<=summary(dat$vCAF)[5]] <-"vCAF medium"

dat$tpCAF_CD10_G[dat$tpCAF_CD10 >summary(dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 high"
dat$tpCAF_CD10_G[dat$tpCAF_CD10 <=summary(dat$tpCAF_CD10)[2]] <-"tpCAF_CD10 low"
dat$tpCAF_CD10_G[dat$tpCAF_CD10 >summary(dat$tpCAF_CD10)[2]& dat$tpCAF_CD10<=summary(dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 medium"

dat$tpCAF_CD73_G[dat$tpCAF_CD73 >summary(dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 high"
dat$tpCAF_CD73_G[dat$tpCAF_CD73 <=summary(dat$tpCAF_CD73)[2]] <-"tpCAF_CD73 low"
dat$tpCAF_CD73_G[dat$tpCAF_CD73 >summary(dat$tpCAF_CD73)[2]& dat$tpCAF_CD73<=summary(dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 medium"

dat$iCAF_CD34_G[dat$iCAF_CD34 >summary(dat$iCAF_CD34)[5]] <-"iCAF_CD34 high"
dat$iCAF_CD34_G[dat$iCAF_CD34 <=summary(dat$iCAF_CD34)[2]] <-"iCAF_CD34 low"
dat$iCAF_CD34_G[dat$iCAF_CD34 >summary(dat$iCAF_CD34)[2]& dat$iCAF_CD34<=summary(dat$iCAF_CD34)[5]] <-"iCAF_CD34 medium"

dat$iCAF_CD248_G[dat$iCAF_CD248 >summary(dat$iCAF_CD248)[5]] <-"iCAF_CD248 high"
dat$iCAF_CD248_G[dat$iCAF_CD248 <=summary(dat$iCAF_CD248)[2]] <-"iCAF_CD248 low"
dat$iCAF_CD248_G[dat$iCAF_CD248 >summary(dat$iCAF_CD248)[2]& dat$iCAF_CD248<=summary(dat$iCAF_CD248)[5]] <-"iCAF_CD248 medium"

dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[5]] <-"dCAF high"
dat$dCAF_G[dat$dCAF <=summary(dat$dCAF)[2]] <-"dCAF low"
dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[2]& dat$dCAF<=summary(dat$dCAF)[5]] <-"dCAF medium"

dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
dat$Collagen_CAF_G[dat$Collagen_CAF <=summary(dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[2]& dat$Collagen_CAF<=summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
dat$hypoxic_CAF_G[dat$hypoxic_CAF <=summary(dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[2]& dat$hypoxic_CAF<=summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[5]] <-"SMA_CAF high"
dat$SMA_CAF_G[dat$SMA_CAF <=summary(dat$SMA_CAF)[2]] <-"SMA_CAF low"
dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[2]& dat$SMA_CAF<=summary(dat$SMA_CAF)[5]] <-"SMA_CAF medium"

dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF <=summary(dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[2]& dat$hypoxic_tpCAF<=summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[5]] <-"IDO_CAF high"
dat$IDO_CAF_G[dat$IDO_CAF <=summary(dat$IDO_CAF)[2]] <-"IDO_CAF low"
dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[2]& dat$IDO_CAF<=summary(dat$IDO_CAF)[5]] <-"IDO_CAF medium"

dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
dat$PDPN_CAF_G[dat$PDPN_CAF <=summary(dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[2]& dat$PDPN_CAF<=summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
  # abbr.colnames = FALSE, na = " "))
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

## Lasso-regressed cox-ph model  
including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high mid low as well as the proportion (continuous).   
```{r  coxph Fibro subtype proportions high mid low, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=6, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor"))) #)),"AG" #,NT,"Area","TMA_ImageID"

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)


#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_tableau()
p

active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-Category_Proportions_high-mid-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))


#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

#Correlation of Fibro category proportions with clinical parameters
```{r  Correlation of non Fibro subtype proportions and clinical parameters, message=FALSE, warning=FALSE, echo=FALSE, eval=F}
fibro.sce_pat$NeoAdj <- ifelse(fibro.sce_pat$Chemo==1 |fibro.sce_pat$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                           fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")
tdat_wide <-tdat_wide[!tdat_wide$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID

tdat_wide <-merge(tdat_wide, clinical.data, by="Patient_ID")
tdat_wide_as <-tdat_wide[tdat_wide$DX.name=="Adenocarcinoma" | tdat_wide$DX.name=="Squamous cell carcinoma",]
tdat_wide_as$LN.Met <-ifelse(tdat_wide_as$LN.Met=="LN Metastases", 1,0)
tdat_wide_as$Dist.Met <-ifelse(tdat_wide_as$Dist.Met=="Dist. Metastases", 1,0)

c.param <- c("Gender","T.new","N","M.new","Dist.Met","LN.Met","Stage")
for(i in c.param){
  print(i)
print(cor.test(tdat_wide_as$CD4,tdat_wide_as[[i]], method="spearman", exact=F))
  }
```


In group comparison (Wilcoxon for 2 groups or KW for >2 groups) for Fibro categories over clinical variables:  
  - T.new (TNM)
  - N (TNM)
  - M.new (TNM)
  - Relapse
  - Grade
  - Stage
  - Gender
  - Typ (Tumour Type)
  - Dist.Met (Distant metastases yes/no)
  - LN.Met (Lymph node metastases yes/no)
  
## Kruskal-Wallis / Wilcoxon Fibro category ~ clinical data excluding neoadjuvant therapy
```{r  KW W Fibro subtype proportions WO neo, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))

#remove neoadj patients
df <-df[!df$Patient_ID%in% neoadj_pat$Patient_ID,]
categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender") 

plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_subtype, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-merge(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      labs( y="Proportion")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=7) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
  #pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_WOneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Phenotype)))
 # dev.off()
}
```

## Neoadjuvantly treated patients are included, the same categories are used plus:  
- NeoAdj (Neoadjuvant therapy yes/no)
- Chemo (Neoadjuvant therapy = chemotherapy)
- Radio (Neoadjuvant therapy = radiotherapy)
```{r  KW W Fibro subtype proportions with NEO, fig.width=12, fig.height=10, message=FALSE, warning=FALSE, echo=FALSE}
df <- as.data.frame(colData(fibro.sce_pat[,fibro.sce_pat$Patient_ID!="Control"&
                                          fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))

categories <- c("Dist.Met","LN.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj")

plot_list <- list()

for (i in (categories)) {

    t <- table(df$cell_subtype, df$Patient_ID)
    t <- prop.table(t, margin=2)
    t <- as.data.frame(t)
    colnames(t) <- c("Phenotype", "Patient_ID","freq")
    t<-merge(t, clinical.data, by.x="Patient_ID", by.y="Patient_ID")
    tdat <-t
    tdat$i <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$Phenotype <-droplevels(tdat$Phenotype)
  
  for (j in unique(t$Phenotype)){
    tdat<-t
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(freq~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = freq, colour=.data[[i]]))+
      geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=4, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      labs( y="Proportion")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }
    
    else {
if(is.element(i,colnames(clinical.data)) == TRUE){
    
      tdat<-t
      tdat[[i]] <-as.factor(tdat[[i]])
      tdat <-tdat %>% drop_na(i)
      tdat$Phenotype <-droplevels(tdat$Phenotype)

      tdat <-subset(tdat, Phenotype==j)
      detach("package:dplyr", unload=TRUE)
      library(dplyr)
      
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$freq~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))

      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = freq, colour=p<0.05))+
        geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=4, strip.position="top")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(x=paste(i), y="Proportion", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }
   }  

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=7) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
#  pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-Category_Proportions_Wneo",i,".pdf")), width=10, height=5)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=length(unique(t$Phenotype)))
 # dev.off()
}
```



## **Fibro subtype**
## **Densities**
Generally, densities are first calculated per tissue area. For patients with more than 1 image, the average density is calculated subsequently.  
Optimal number of Fibro subtype densities patients metaclusters:
```{r  Fibro subtype density optimal number of clusters, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=6, fig.height=4}
#Calculate Densities
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
  #t <-merge(t, clinical.data, by="Patient_ID")
tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

#tdat_wide <-tdat_wide[!tdat_wide$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID

hc <- hclust(dist(tdat_m[,-1]),"ward.D2")

#devtools::install_github("kassambara/factoextra")
library(FactoMineR)
library(factoextra)
sbg <-cutree(hc, k=8)
fviz_cluster(list(data = tdat_wide[,-1], cluster = sbg))

fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "wss", k.max=20)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "gap_stat", k.max=20)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "silhouette", k.max=20)

#install.packages("cluster")
library(cluster)
gap_stat <- clusGap(tdat_wide[,-1], FUN = hcut, nstart = 25, K.max = 10, B = 100)
fviz_gap_stat(gap_stat)

# Compute distance matrix
res.dist <- dist(tdat_wide[,-1], method = "euclidean")
```

```{r  Calculate densities Fibro subtype, message=FALSE, warning=FALSE, echo=FALSE}
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
  #t <-merge(t, clinical.data, by="Patient_ID")
  
  
#CAF type distribution over all patients
tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")
tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID


hc <- hclust(dist(tdat_m[,-1]),"ward.D2")
#order Patients after clustering results
tdat_wide$Patient_ID <- factor(tdat_wide$Patient_ID, levels = labels(hc))
tdat$Patient_ID <- factor(tdat$Patient_ID, levels = labels(hc))
```

## Barplot showing absolute density per patietn coloured by Fibro subtype together with hierarchical clustering tree coloured by patient metaclusters.
```{r Barolot Fibro subtype densities, fig.width=12, fig.height=6, message=FALSE, warning=FALSE, echo=FALSE}
#barolot (sqrt of density)
p <-ggplot(tdat,aes(y=sqrt(density),x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")#+theme(legend.position = "none")

#barplot total density
p <-ggplot(tdat,aes(y=density,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")#+theme(legend.position = "none")


#coloured dendrogram
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k = 10) %>% as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()
pg <-plot_grid(p1,p, align="v", ncol=1)
pg
##ggsave(plot=pg, file=file.path(plot_folder, paste("Barplot_Tcell-subtype-Densities_HC_ordered_dendro.pdf")), width=12, height=6)
```
Add patient metacluster to data and plot clusters separately for better identification
```{r Fibro subtype densities merge hc, message=FALSE, warning=FALSE, echo=FALSE}
clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]

#cut dendrogram, add metacluster info to tdat
ct <-as.data.frame(cutree(hc, k=10))

colnames(ct)<-"metacluster"
ct$metacluster <-as.factor(ct$metacluster)
ct$Patient_ID <- rownames(ct)

tdat_wide_ct <-left_join(tdat_wide, ct, by="Patient_ID")
tdat_wide_ct <- left_join(tdat_wide_ct, clinical.data, by="Patient_ID")
table(tdat_wide_ct$metacluster)

#split barlot by metacluster
tdat_ct <-merge(tdat, ct, by="Patient_ID")
ggplot(tdat_ct,aes(y=density,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 20")+
    theme(legend.position="bottom")+
  facet_grid(~ metacluster, scales = "free", space = "free")
```

## Survival analysis over Fibro subtype densities high low.  
- High > median
- Low < median
```{r  surv_dat Fibro subtype densities high low, message=FALSE, warning=FALSE, echo=FALSE}
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat$Patient_ID,]

surv_dat$total_density <- rowSums(surv_dat[,2:15])

#high low
surv_dat$Density_G <- ifelse(surv_dat$total_density >summary(surv_dat$total_density)[3],"Density high","Density low")
surv_dat$Collagen_CAF_G <- ifelse(surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
surv_dat$hypoxic_CAF_G <- ifelse(surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")

surv_dat$mCAF_MMP11_G <- ifelse(surv_dat$mCAF_MMP11 >summary(surv_dat$mCAF_MMP11)[3],"mCAF_MMP11 high","mCAF_MMP11 low")
surv_dat$mCAF_Col_Cdh_G <- ifelse(surv_dat$mCAF_Col_Cdh >summary(surv_dat$mCAF_Col_Cdh)[3],"mCAF_Col_Cdh high","mCAF_Col_Cdh low")

surv_dat$SMA_CAF_G <- ifelse(surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")

surv_dat$tpCAF_CD10_G <- ifelse(surv_dat$tpCAF_CD10 >summary(surv_dat$tpCAF_CD10)[3],"tpCAF_CD10 high","tpCAF_CD10 low")
surv_dat$tpCAF_CD73_G <- ifelse(surv_dat$tpCAF_CD73 >summary(surv_dat$tpCAF_CD73)[3],"tpCAF_CD73 high","tpCAF_CD73 low")

surv_dat$iCAF_CD248_G <- ifelse(surv_dat$iCAF_CD248 >summary(surv_dat$iCAF_CD248)[3],"iCAF_CD248 high","iCAF_CD248 low")
surv_dat$iCAF_CD34_G <- ifelse(surv_dat$iCAF_CD34 >summary(surv_dat$iCAF_CD34)[3],"iCAF_CD34 high","iCAF_CD34 low")

surv_dat$vCAF_G <- ifelse(surv_dat$vCAF >summary(surv_dat$vCAF)[3],"vCAF high","vCAF low")
surv_dat$dCAF_G <- ifelse(surv_dat$dCAF >summary(surv_dat$dCAF)[3],"dCAF high","dCAF low")
surv_dat$hypoxic_tpCAF_G <- ifelse(surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
surv_dat$IDO_CAF_G <- ifelse(surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
surv_dat$PDPN_CAF_G <- ifelse(surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")

```

#CoxPH for Fibro subtype density corrected for Stage, Grade and M
```{r  Coxph Fibro subtype density, echo=F, message=FALSE, warning=FALSE}
surv_dat
surv_dat<-surv_dat[!surv_dat$OS == 0, ]
time <- surv_dat$OS
status <- surv_dat$censoringOS
surv_dat$metacluster <-as.factor(surv_dat$metacluster)
surv_dat$Grade <-as.numeric(surv_dat$Grade)
rownames(surv_dat) <- surv_dat$Patient_ID
res.cox <- coxph(Surv(time, status) ~ metacluster, data = surv_dat)
res.cox


res.cox <- coxph(Surv(time, status) ~   IDO_CAF + SMA_CAF+PDPN_CAF+Collagen_CAF +hypoxic_CAF+hypoxic_tpCAF+tpCAF_CD10+tpCAF_CD73+ dCAF+iCAF_CD34+iCAF_CD248+vCAF+mCAF_MMP11+mCAF_Col_Cdh+Stage+Grade+M.new, data =  surv_dat)

#res.cox <- coxph(Surv(time, status) ~ `CD4+`+tpCAF+iCAF+mCAF+dCAF+vCAF+`SMA+ CAF`+`IDO+ CAF`+`dividing tpCAF`+`hypoxic CAF`+Grade, data =  surv_dat)
summary(res.cox)


td_res = tidy(res.cox, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
td_res <-td_res[td_res$term !="Grade"&
                  td_res$term !="Stage"&
                  td_res$term !="M.new",]

p <-ggplot(td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
#xlim(0,2)+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
#
plot(p)
```

## Not split by tumour type (AC and SQC together)
```{r  survival Fibro subtype densities high low not split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#Not split
#surv <-c("metacluster")
#surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")
library(survminer)

for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
#OS
km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-low_OS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()


p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))
#km_trt_fit

#disease free survival
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-low_DFS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit

pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))
km_trt_fit
}
```

## Split by tumour type (AC and SQC individually)
```{r  survival Fibro subtype densities high low split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#Split
library(survminer)

for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$Density_G <- ifelse(dat$total_density >summary(dat$total_density)[3],"Density high","Density low")
dat$Density_G <- ifelse(dat$total_density >summary(dat$total_density)[3],"Density high","Density low")
dat$Collagen_CAF_G <- ifelse(dat$Collagen_CAF >summary(dat$Collagen_CAF)[3],"Collagen_CAF high","Collagen_CAF low")
dat$hypoxic_CAF_G <- ifelse(dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[3],"hypoxic_CAF high","hypoxic_CAF low")

dat$mCAF_MMP11_G <- ifelse(dat$mCAF_MMP11 >summary(dat$mCAF_MMP11)[3],"mCAF_MMP11 high","mCAF_MMP11 low")
dat$mCAF_Col_Cdh_G <- ifelse(dat$mCAF_Col_Cdh >summary(dat$mCAF_Col_Cdh)[3],"mCAF_Col_Cdh high","mCAF_Col_Cdh low")

dat$SMA_CAF_G <- ifelse(dat$SMA_CAF >summary(dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")

dat$tpCAF_CD10_G <- ifelse(dat$tpCAF_CD10 >summary(dat$tpCAF_CD10)[3],"tpCAF_CD10 high","tpCAF_CD10 low")
dat$tpCAF_CD73_G <- ifelse(dat$tpCAF_CD73 >summary(dat$tpCAF_CD73)[3],"tpCAF_CD73 high","tpCAF_CD73 low")

dat$iCAF_CD248_G <- ifelse(dat$iCAF_CD248 >summary(dat$iCAF_CD248)[3],"iCAF_CD248 high","iCAF_CD248 low")
dat$iCAF_CD34_G <- ifelse(dat$iCAF_CD34 >summary(dat$iCAF_CD34)[3],"iCAF_CD34 high","iCAF_CD34 low")

dat$vCAF_G <- ifelse(dat$vCAF >summary(dat$vCAF)[3],"vCAF high","vCAF low")
dat$dCAF_G <- ifelse(dat$dCAF >summary(dat$dCAF)[3],"dCAF high","dCAF low")
dat$hypoxic_tpCAF_G <- ifelse(dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[3],"hypoxic_tpCAF high","hypoxic_tpCAF low")
dat$IDO_CAF_G <- ifelse(dat$IDO_CAF >summary(dat$IDO_CAF)[3],"IDO_CAF high","IDO_CAF low")
dat$PDPN_CAF_G <- ifelse(dat$PDPN_CAF >summary(dat$PDPN_CAF)[3],"PDPN_CAF high","PDPN_CAF low")

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)  
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-low_OS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()


#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-low_DFS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

## Lasso-regressed cox-ph model  
Including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high / low as well as the densities (continuous).   
```{r  coxph Fibro subtype densities high-low, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=6, fig.width=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor"))) #)),"AG" #,NT,"Area","TMA_ImageID"

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)


#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_tableau()
p

active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-subtype_Density_high-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))


#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

## Survival Fibro subtype densities high-mid-low     
- high    > 3rd quantile   
- mid     > 1st quantile < 3rd quantile   
- low     < 1st quantile   
```{r  surv_dat Fibro subtype densities high mid low, message=FALSE, warning=FALSE, echo=FALSE}
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat$Patient_ID,]

surv_dat$total_density <- rowSums(surv_dat[,2:15])

#High Med Low
surv_dat$Density_G[surv_dat$total_density >summary(surv_dat$total_density)[5]] <-"Density high"
surv_dat$Density_G[surv_dat$total_density <summary(surv_dat$total_density)[2]] <-"Density low"
surv_dat$Density_G[surv_dat$total_density >summary(surv_dat$total_density)[2]& surv_dat$total_density<summary(surv_dat$total_density)[5]] <-"Density medium"

surv_dat$mCAF_Col_Cdh_G[surv_dat$mCAF_Col_Cdh >summary(surv_dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh high"
surv_dat$mCAF_Col_Cdh_G[surv_dat$mCAF_Col_Cdh <=summary(surv_dat$mCAF_Col_Cdh)[2]] <-"mCAF_Col_Cdh low"
surv_dat$mCAF_Col_Cdh_G[surv_dat$mCAF_Col_Cdh >summary(surv_dat$mCAF_Col_Cdh)[2]& surv_dat$mCAF_Col_Cdh<=summary(surv_dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh medium"

surv_dat$mCAF_MMP11_G[surv_dat$mCAF_MMP11 >summary(surv_dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 high"
surv_dat$mCAF_MMP11_G[surv_dat$mCAF_MMP11 <=summary(surv_dat$mCAF_MMP11)[2]] <-"mCAF_MMP11 low"
surv_dat$mCAF_MMP11_G[surv_dat$mCAF_MMP11 >summary(surv_dat$mCAF_MMP11)[2]& surv_dat$mCAF_MMP11<=summary(surv_dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 medium"

surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[5]] <-"vCAF high"
surv_dat$vCAF_G[surv_dat$vCAF <=summary(surv_dat$vCAF)[2]] <-"vCAF low"
surv_dat$vCAF_G[surv_dat$vCAF >summary(surv_dat$vCAF)[2]& surv_dat$vCAF<=summary(surv_dat$vCAF)[5]] <-"vCAF medium"

surv_dat$tpCAF_CD10_G[surv_dat$tpCAF_CD10 >summary(surv_dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 high"
surv_dat$tpCAF_CD10_G[surv_dat$tpCAF_CD10 <=summary(surv_dat$tpCAF_CD10)[2]] <-"tpCAF_CD10 low"
surv_dat$tpCAF_CD10_G[surv_dat$tpCAF_CD10 >summary(surv_dat$tpCAF_CD10)[2]& surv_dat$tpCAF_CD10<=summary(surv_dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 medium"

surv_dat$tpCAF_CD73_G[surv_dat$tpCAF_CD73 >summary(surv_dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 high"
surv_dat$tpCAF_CD73_G[surv_dat$tpCAF_CD73 <=summary(surv_dat$tpCAF_CD73)[2]] <-"tpCAF_CD73 low"
surv_dat$tpCAF_CD73_G[surv_dat$tpCAF_CD73 >summary(surv_dat$tpCAF_CD73)[2]& surv_dat$tpCAF_CD73<=summary(surv_dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 medium"

surv_dat$iCAF_CD34_G[surv_dat$iCAF_CD34 >summary(surv_dat$iCAF_CD34)[5]] <-"iCAF_CD34 high"
surv_dat$iCAF_CD34_G[surv_dat$iCAF_CD34 <=summary(surv_dat$iCAF_CD34)[2]] <-"iCAF_CD34 low"
surv_dat$iCAF_CD34_G[surv_dat$iCAF_CD34 >summary(surv_dat$iCAF_CD34)[2]& surv_dat$iCAF_CD34<=summary(surv_dat$iCAF_CD34)[5]] <-"iCAF_CD34 medium"

surv_dat$iCAF_CD248_G[surv_dat$iCAF_CD248 >summary(surv_dat$iCAF_CD248)[5]] <-"iCAF_CD248 high"
surv_dat$iCAF_CD248_G[surv_dat$iCAF_CD248 <=summary(surv_dat$iCAF_CD248)[2]] <-"iCAF_CD248 low"
surv_dat$iCAF_CD248_G[surv_dat$iCAF_CD248 >summary(surv_dat$iCAF_CD248)[2]& surv_dat$iCAF_CD248<=summary(surv_dat$iCAF_CD248)[5]] <-"iCAF_CD248 medium"

surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[5]] <-"dCAF high"
surv_dat$dCAF_G[surv_dat$dCAF <=summary(surv_dat$dCAF)[2]] <-"dCAF low"
surv_dat$dCAF_G[surv_dat$dCAF >summary(surv_dat$dCAF)[2]& surv_dat$dCAF<=summary(surv_dat$dCAF)[5]] <-"dCAF medium"

surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF <=summary(surv_dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
surv_dat$Collagen_CAF_G[surv_dat$Collagen_CAF >summary(surv_dat$Collagen_CAF)[2]& surv_dat$Collagen_CAF<=summary(surv_dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF <=summary(surv_dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
surv_dat$hypoxic_CAF_G[surv_dat$hypoxic_CAF >summary(surv_dat$hypoxic_CAF)[2]& surv_dat$hypoxic_CAF<=summary(surv_dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF high"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF <=summary(surv_dat$SMA_CAF)[2]] <-"SMA_CAF low"
surv_dat$SMA_CAF_G[surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[2]& surv_dat$SMA_CAF<=summary(surv_dat$SMA_CAF)[5]] <-"SMA_CAF medium"

surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF <=summary(surv_dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
surv_dat$hypoxic_tpCAF_G[surv_dat$hypoxic_tpCAF >summary(surv_dat$hypoxic_tpCAF)[2]& surv_dat$hypoxic_tpCAF<=summary(surv_dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF high"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF <=summary(surv_dat$IDO_CAF)[2]] <-"IDO_CAF low"
surv_dat$IDO_CAF_G[surv_dat$IDO_CAF >summary(surv_dat$IDO_CAF)[2]& surv_dat$IDO_CAF<=summary(surv_dat$IDO_CAF)[5]] <-"IDO_CAF medium"

surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF <=summary(surv_dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
surv_dat$PDPN_CAF_G[surv_dat$PDPN_CAF >summary(surv_dat$PDPN_CAF)[2]& surv_dat$PDPN_CAF<=summary(surv_dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"

#surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")
```

## Fibro subtype densities split by tumour type
```{r  survival Fibro subtype densities high-mid-low not split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#Not split
#surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_G","tpCAF_G","SMA_CAF_G","mCAF_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")
library(survminer)

for (i in surv){
  dat <-surv_dat
  k="AC & SCC together"
#OS
km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-med-low_OS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit

#disease free survival
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-med-low_DFS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit

pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit
}
```

## Fibro subtype densities split by tumour type
```{r  survival Fibro subtype densities high-mid-low split, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
surv <-c("PDPN_CAF_G","IDO_CAF_G","hypoxic_tpCAF_G","dCAF_G","vCAF_G","iCAF_CD34_G","iCAF_CD248_G","tpCAF_CD10_G","tpCAF_CD73_G","SMA_CAF_G","mCAF_MMP11_G","mCAF_Col_Cdh_G","hypoxic_CAF_G","Collagen_CAF_G", "metacluster","Density_G")

for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
dat$Density_G[dat$total_density >summary(dat$total_density)[5]] <-"Density high"
dat$Density_G[dat$total_density <summary(dat$total_density)[2]] <-"Density low"
dat$Density_G[dat$total_density >summary(dat$total_density)[2]& dat$total_density<summary(dat$total_density)[5]] <-"Density medium"

dat$mCAF_Col_Cdh_G[dat$mCAF_Col_Cdh >summary(dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh high"
dat$mCAF_Col_Cdh_G[dat$mCAF_Col_Cdh <=summary(dat$mCAF_Col_Cdh)[2]] <-"mCAF_Col_Cdh low"
dat$mCAF_Col_Cdh_G[dat$mCAF_Col_Cdh >summary(dat$mCAF_Col_Cdh)[2]& dat$mCAF_Col_Cdh<=summary(dat$mCAF_Col_Cdh)[5]] <-"mCAF_Col_Cdh medium"

dat$mCAF_MMP11_G[dat$mCAF_MMP11 >summary(dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 high"
dat$mCAF_MMP11_G[dat$mCAF_MMP11 <=summary(dat$mCAF_MMP11)[2]] <-"mCAF_MMP11 low"
dat$mCAF_MMP11_G[dat$mCAF_MMP11 >summary(dat$mCAF_MMP11)[2]& dat$mCAF_MMP11<=summary(dat$mCAF_MMP11)[5]] <-"mCAF_MMP11 medium"

dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[5]] <-"vCAF high"
dat$vCAF_G[dat$vCAF <=summary(dat$vCAF)[2]] <-"vCAF low"
dat$vCAF_G[dat$vCAF >summary(dat$vCAF)[2]& dat$vCAF<=summary(dat$vCAF)[5]] <-"vCAF medium"

dat$tpCAF_CD10_G[dat$tpCAF_CD10 >summary(dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 high"
dat$tpCAF_CD10_G[dat$tpCAF_CD10 <=summary(dat$tpCAF_CD10)[2]] <-"tpCAF_CD10 low"
dat$tpCAF_CD10_G[dat$tpCAF_CD10 >summary(dat$tpCAF_CD10)[2]& dat$tpCAF_CD10<=summary(dat$tpCAF_CD10)[5]] <-"tpCAF_CD10 medium"

dat$tpCAF_CD73_G[dat$tpCAF_CD73 >summary(dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 high"
dat$tpCAF_CD73_G[dat$tpCAF_CD73 <=summary(dat$tpCAF_CD73)[2]] <-"tpCAF_CD73 low"
dat$tpCAF_CD73_G[dat$tpCAF_CD73 >summary(dat$tpCAF_CD73)[2]& dat$tpCAF_CD73<=summary(dat$tpCAF_CD73)[5]] <-"tpCAF_CD73 medium"

dat$iCAF_CD34_G[dat$iCAF_CD34 >summary(dat$iCAF_CD34)[5]] <-"iCAF_CD34 high"
dat$iCAF_CD34_G[dat$iCAF_CD34 <=summary(dat$iCAF_CD34)[2]] <-"iCAF_CD34 low"
dat$iCAF_CD34_G[dat$iCAF_CD34 >summary(dat$iCAF_CD34)[2]& dat$iCAF_CD34<=summary(dat$iCAF_CD34)[5]] <-"iCAF_CD34 medium"

dat$iCAF_CD248_G[dat$iCAF_CD248 >summary(dat$iCAF_CD248)[5]] <-"iCAF_CD248 high"
dat$iCAF_CD248_G[dat$iCAF_CD248 <=summary(dat$iCAF_CD248)[2]] <-"iCAF_CD248 low"
dat$iCAF_CD248_G[dat$iCAF_CD248 >summary(dat$iCAF_CD248)[2]& dat$iCAF_CD248<=summary(dat$iCAF_CD248)[5]] <-"iCAF_CD248 medium"

dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[5]] <-"dCAF high"
dat$dCAF_G[dat$dCAF <=summary(dat$dCAF)[2]] <-"dCAF low"
dat$dCAF_G[dat$dCAF >summary(dat$dCAF)[2]& dat$dCAF<=summary(dat$dCAF)[5]] <-"dCAF medium"

dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF high"
dat$Collagen_CAF_G[dat$Collagen_CAF <=summary(dat$Collagen_CAF)[2]] <-"Collagen_CAF low"
dat$Collagen_CAF_G[dat$Collagen_CAF >summary(dat$Collagen_CAF)[2]& dat$Collagen_CAF<=summary(dat$Collagen_CAF)[5]] <-"Collagen_CAF medium"

dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF high"
dat$hypoxic_CAF_G[dat$hypoxic_CAF <=summary(dat$hypoxic_CAF)[2]] <-"hypoxic_CAF low"
dat$hypoxic_CAF_G[dat$hypoxic_CAF >summary(dat$hypoxic_CAF)[2]& dat$hypoxic_CAF<=summary(dat$hypoxic_CAF)[5]] <-"hypoxic_CAF medium"

dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[5]] <-"SMA_CAF high"
dat$SMA_CAF_G[dat$SMA_CAF <=summary(dat$SMA_CAF)[2]] <-"SMA_CAF low"
dat$SMA_CAF_G[dat$SMA_CAF >summary(dat$SMA_CAF)[2]& dat$SMA_CAF<=summary(dat$SMA_CAF)[5]] <-"SMA_CAF medium"

dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF high"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF <=summary(dat$hypoxic_tpCAF)[2]] <-"hypoxic_tpCAF low"
dat$hypoxic_tpCAF_G[dat$hypoxic_tpCAF >summary(dat$hypoxic_tpCAF)[2]& dat$hypoxic_tpCAF<=summary(dat$hypoxic_tpCAF)[5]] <-"hypoxic_tpCAF medium"

dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[5]] <-"IDO_CAF high"
dat$IDO_CAF_G[dat$IDO_CAF <=summary(dat$IDO_CAF)[2]] <-"IDO_CAF low"
dat$IDO_CAF_G[dat$IDO_CAF >summary(dat$IDO_CAF)[2]& dat$IDO_CAF<=summary(dat$IDO_CAF)[5]] <-"IDO_CAF medium"

dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF high"
dat$PDPN_CAF_G[dat$PDPN_CAF <=summary(dat$PDPN_CAF)[2]] <-"PDPN_CAF low"
dat$PDPN_CAF_G[dat$PDPN_CAF >summary(dat$PDPN_CAF)[2]& dat$PDPN_CAF<=summary(dat$PDPN_CAF)[5]] <-"PDPN_CAF medium"

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)  
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])


#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-med-low_OS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
#   abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)      
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

#pdf(file=file.path(plot_folder, paste0("Survival_Density-cell_subtype_hi-med-low_DFS over",i,"_per_",k,".pdf")))
#print(p,newpage=FALSE)
#dev.off()

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```



## Lasso-regressed cox-ph model   
including clinical parameters, patient metacluster and Fibro categories (CD4 vs CD8) classified as high mid low as well as the densities (continuous).   
```{r coxph Fibro subtype densities high-mid-low, message=FALSE, warning=FALSE, echo=FALSE, out.width="50%", fig.width=6, fig.height=6}
surv_dat$metacluster <-as.numeric(surv_dat$metacluster)
fd_test <- fastDummies::dummy_cols(surv_dat, select_columns = c(paste(surv),"Typ","Grade","T.new","N","M.new","Stage","Smok","Gender", "metacluster")) #

fd_test<-fd_test[!fd_test$OS == 0, ]
time <- fd_test$OS
status <- fd_test$censoringOS

rownames(fd_test) <- fd_test$Patient_ID

fd_test <-fd_test %>%select(-c(paste(surv),"metacluster",colnames(clinical.data),contains("censor")))

fd_test[is.na(fd_test)] <- 0
fd_test_matrix <-data.matrix(fd_test)


#determine lambda
cv.fit <- cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
fit <- glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
#plot(cv.fit)
#cv.fit$lambda.min

#loop to determine optimal lambda for lasso regression
MSEs <- NULL
for (i in 1:100){
                 cv <-  cv.glmnet(fd_test_matrix, Surv(time, status), family = "cox", maxit = 1000)
                 MSEs <- cbind(MSEs, cv$cvm)
             }
  rownames(MSEs) <- cv$lambda
  lambda.min <- as.numeric(names(which.min(rowMeans(MSEs))))

#coef(fit, s = lambda.min)
Coefficients <- coef(fit, s = lambda.min)
Active.Index <- which(Coefficients != 0)
Active.Coefficients <- Coefficients[Active.Index]
#Coefficients

#correct


df <-Coefficients %>% as.data.frame 
df$Coefficients <- rownames(df)
colnames(df) <- c("Predictor","Coefficient")
df <-df[df$Predictor !=0,]

na_td_res <- df[-grep("NA",df$Coefficient),]

p <-ggplot(na_td_res, aes(x = reorder(Coefficient,Predictor), y = Predictor, color=Predictor >0)) +
geom_point(size = 4) +
#geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
#scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 0,color = 'black')+
theme_bw()+
  geom_segment(aes(y = 0, 
                   x = Coefficient, 
                   yend = Predictor, 
                   xend = Coefficient), 
               color = "black") +
scale_colour_tableau()
p

active_coefficients <- Coefficients[,1] != 0
x <- fd_test_matrix[,active_coefficients]
x <- data.frame(x)

vct <-colnames(x)
coxdf<-coxph(Surv(time,status)~.,data=x)

td_res = tidy(coxdf, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
na_td_res <- td_res[-grep("NA",td_res$term),]


p <-ggplot(na_td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
p
##ggsave(file=file.path(plot_folder, paste("CoxPH_Tcell-subtype_Density_high-mid-low_Lasso.pdf")), width=10, height=10, plot=p)

ggforest(coxdf, data =  (fd_test %>% select(-contains("NA"))))

#pdf(file=file.path(plot_folder,paste("COX_selectedFactors_glmnet.pdf")))
#ggforest(coxdf, data = fd_test)
#dev.off()
```

## Kruskal Wallis / Wilcoxon comparison between groups of clincial variables without neoadjuvant treated patients.
```{r  KW W Fibro subtype density WO neo,warning=FALSE, message=FALSE, echo=FALSE, fig.width=18, fig.height=12}
#define variables to be tested here
categories <- c( "Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")

fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[2:15])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:16])), names_to = "Phenotype",values_to = "density")

#remove
tdat <-tdat[!tdat$Patient_ID%in% neoadj_pat$Patient_ID,]

tdat_c <-merge(tdat, clinical.data, by="Patient_ID")
categories <- c("Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")
plot_list <- list()
for (i in (categories)) {
  for (j in unique(tdat_c$Phenotype)){
    tdat<-tdat_c
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = density, colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Mean patient density")+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }
    
     else{
      
        tdat<-tdat_c
        tdat[[i]] <-as.factor(tdat[[i]])
        tdat <-tdat %>% drop_na(i)
        tdat$Phenotype <-factor(tdat$Phenotype)
        tdat$Phenotype <-droplevels(tdat$Phenotype)
        tdat <-tdat %>% drop_na(i)

        tdat <-subset(tdat, Phenotype==j)
          detach("package:dplyr", unload=TRUE)
          library(dplyr)
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$density~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))
    
      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = density, colour=p<0.05))+
        geom_violin(width=0.5) +
        geom_boxplot(width=0.3, color="grey", alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        #ggtitle("paired")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=5) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
 # pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-subtype_Densities_WOneo",i,".pdf")), width=12, height=6)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=3)
#  dev.off()
}
```

## Kruskal Wallis / Wilcoxon comparison between groups of clincial variables with neoadjuvant treated patients.
```{r  KW Wilcox Fibro subtype density W neo,warning=FALSE, message=FALSE, echo=FALSE, fig.width=18, fig.height=12}
#define variables to be tested here
categories <- c( "Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender")

fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- rowSums(tdat_wide[,2:15])
tdat <-tdat_wide %>% pivot_longer(cols=c(colnames(tdat_wide[,2:16])), names_to = "Phenotype",values_to = "density")

tdat_c <-merge(tdat, clinical.data, by="Patient_ID")
categories <- c("Dist.Met", "T.new","M.new","N","Relapse","DX.name","Stage","Grade","Gender","Chemo","Radio","NeoAdj")
plot_list <- list()
for (i in (categories)) {
  for (j in unique(tdat_c$Phenotype)){
    tdat<-tdat_c
    tdat[[i]] <-as.factor(tdat[[i]])
    tdat <-tdat %>% drop_na(i)
    tdat$i <-as.factor(tdat[[i]])
    tdat$Phenotype <-as.factor(tdat$Phenotype)
    tdat$Phenotype <-droplevels(tdat$Phenotype)

    tdat <-subset(tdat, Phenotype==j)

    if (length(unique(tdat[[i]])) > 2)
      {
    #calculate p values, add position for plot
    stat.test <- tdat%>%
     group_by(Phenotype) %>%
     dunn_test(density~i,p.adjust.method = "bonferroni")
    stat.test<-stat.test %>% select(-.y., -statistic)
    stat.test <- stat.test %>% add_xy_position(x = i)
   
    #create plot list
    plot_list[[j]]<-
      ggplot(tdat, aes(x= .data[[i]], y = density, colour=.data[[i]]))+
              geom_violin(width=0.5) +
    geom_boxplot(width=0.3, color="grey", alpha=0.2)+
      #geom_boxplot()+
      geom_point()+
      facet_wrap(~Phenotype, scales="free", ncol=3, strip.position="top")+
      scale_color_viridis_d()+
      theme_bw()+
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
      labs( y="Mean patient density")+
      theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())+
      stat_pvalue_manual(stat.test, label = "p.adj.signif", tip.length = 0, hide.ns = T)+
      theme(legend.position = "none")
    }
    
     else{
      
        tdat<-tdat_c
        tdat[[i]] <-as.factor(tdat[[i]])
        tdat <-tdat %>% drop_na(i)
        tdat$Phenotype <-factor(tdat$Phenotype)
        tdat$Phenotype <-droplevels(tdat$Phenotype)
        tdat <-tdat %>% drop_na(i)

        tdat <-subset(tdat, Phenotype==j)
          detach("package:dplyr", unload=TRUE)
          library(dplyr)
      pvalues <- tdat %>% 
      group_by(Phenotype) %>% 
      summarise(p=wilcox.test(tdat$density~tdat[[i]], paired=F)$p.value)
      tdat <- merge(tdat, pvalues, by.x = "Phenotype", by.y ="Phenotype", all.x = TRUE)
      tdat$p.wt <- paste0('p=',round(tdat$p, digits=3))
    
      #Plot list, all js together over i
      plot_list[[j]]<-
        ggplot(tdat, aes(x= .data[[i]], y = density, colour=p<0.05))+
        geom_violin(width=0.5) +
        geom_boxplot(width=0.3, color="grey", alpha=0.2)+
        #geom_boxplot()+
        geom_point()+
        facet_wrap(~Phenotype+p.wt, scales="free", ncol=3, strip.position="top")+
        #ggtitle("paired")+
        theme(axis.title.x=element_text("Phenotype"))+
      
        scale_colour_manual(values = setNames(c(palette("Tableau 10")[1:2]),c(F, T)))+
        theme_bw()+
        theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
        labs(y="Mean patient density", fill="Area_Phenotype")+
        theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank(),
              legend.position = "none")
    }  
 
    }

  #plot
  gridExtra::grid.arrange(grobs = plot_list, ncol=7) #, ncol=round(length(unique(t$Phenotype)))
  
  #save out in individual pdfs for each variable
#  pdf(file=file.path(plot_folder, paste0("KW_W_Tcell-subtype_Densities_Wneo",i,".pdf")), width=12, height=6)
 # gridExtra::grid.arrange(grobs = plot_list, ncol=3)
#  dev.off()
}
```

```{r  Correlation Fibro subtype densities with clinical parameters, eval=F, echo=T, message=FALSE, warning=FALSE, echo=FALSE}
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Sample) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

  tdat <-tdat %>% 
  group_by(Patient_ID,Phenotype) %>%
  summarise(across(-c(RoiID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

tdat_wide$total_density <- tdat_wide$CD4 + tdat_wide$CD8

tdat_wide <-merge(tdat_wide, clinical.data, by="Patient_ID")
tdat_wide_as <-tdat_wide[tdat_wide$DX.name=="Adenocarcinoma" | tdat_wide$DX.name=="Squamous cell carcinoma",]
tdat_wide_as$LN.Met <-ifelse(tdat_wide_as$LN.Met=="LN Metastases", 1,0)
tdat_wide_as$Dist.Met <-ifelse(tdat_wide_as$Dist.Met=="Dist. Metastases", 1,0)

for(i in c.param){
  print(i)
  print(cor.test(tdat_wide_as$CD4,tdat_wide_as[[i]], method="spearman", exact=F))
  print(cor.test(tdat_wide_as$CD8,tdat_wide_as[[i]], method="spearman", exact=F))
  print(cor.test(tdat_wide_as$total_density,tdat_wide_as[[i]], method="spearman", exact=F))
}
```


```{r  Correlations T cell type densities amongst eachother, message=FALSE, warning=FALSE, echo=FALSE, fig.width=6, fig.height=6}
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

tdat <-tdat %>% 
  group_by(RoiID,Phenotype) %>%
  summarise(across(-c(Patient_ID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
tdat_wide <- pivot_wider(tdat,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

neoadj_roi <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(RoiID) 

tdat_wide <-tdat_wide[!tdat_wide$RoiID%in% neoadj_roi$RoiID,]
rownames(tdat_wide)<-tdat_wide$RoiID

library(corrplot)
cor(tdat_wide[,-1], method="pearson")
#corrplot(cor(tdat_wide[,-1], method="pearson"), col=rev(brewer.pal(10,"RdBu")))

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_wide[,-1], conf.level = .95) #is this test right?


#plot
corrplot(cor(tdat_wide[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))

col_fun = colorRamp2(c(0, 0.5, 1), c("blue", "white", "red"))

pdf(file=file.path(plot_folder, "CAF_density_corrplot_upper.pdf"), width=6, height=6)

corrplot(cor(tdat_wide[,-1], method="pearson"),
         type="upper",
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
        #col=rev(brewer.pal(8,"RdBu")),
        col=rev(COL2('RdBu', 8)),
        method="square",
         pch.col = "white",
         #type="upper",
       #  title = "Correlation of CAF type densities",
        mar=c(0,0,3,0))
dev.off()

#col=wes_palette("Zissou1", 100, type = "continuous"),
```


```{r  Correlations T cell type densities amongst eachother per roi, message=FALSE, warning=FALSE, echo=FALSE, fig.width=6, fig.height=6}
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$Patient_ID!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

tdat <-tdat %>% 
  group_by(RoiID,Phenotype) %>%
  summarise(across(-c(Patient_ID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
tdat_wide <- pivot_wider(tdat,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

neoadj_roi <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(RoiID) 

tdat_wide <-tdat_wide[!tdat_wide$RoiID%in% neoadj_roi$RoiID,]
rownames(tdat_wide)<-tdat_wide$RoiID

library(corrplot)
cor(tdat_wide[,-1], method="pearson")
#corrplot(cor(tdat_wide[,-1], method="pearson"), col=rev(brewer.pal(10,"RdBu")))

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_wide[,-1], conf.level = .95) #is this test right?


#plot
corrplot(cor(tdat_wide[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation of T cell type densities",
        mar=c(0,0,3,0))
```




```{r  Correlations proportions per image CAF Type densities, fig.width=10, fig.height=10, message=FALSE,warning=FALSE,echo=FALSE, fig.width=6, fig.height=6}
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$DX.name!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$DX.name!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_subtype))
colnames(tdat)<-c("RoiID","Phenotype","n")

da <-dplyr::distinct(data.frame("RoiID"=fibro.sce_pat.roi$RoiID,
                                "Area"=fibro.sce_pat.roi$Area_px_Core,
                                "Patient_ID"=fibro.sce_pat.roi$Patient_ID,
                                "DX.name"=fibro.sce_pat.roi$DX.name))

  tdat <-merge(tdat,da,by="RoiID")
  tdat <-tdat[tdat$DX.name=="Adenocarcinoma" | tdat$DX.name=="Squamous cell carcinoma",]
  tdat <-tdat %>%
    #dplyr::count(Type, Area,Patient_ID) %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(density = n / Area*1000000)
  range(tdat$density)

tdat <-tdat %>% 
  group_by(RoiID,Phenotype) %>%
  summarise(across(-c(Patient_ID,n,Area,DX.name), sum, na.rm = TRUE))
  range(tdat$density)
tdat_wide <- pivot_wider(tdat,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="density",names_prefix = "")

neoadj_roi <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(RoiID) 

tdat_wide <-tdat_wide[!tdat_wide$RoiID%in% neoadj_roi$RoiID,]
rownames(tdat_wide)<-tdat_wide$RoiID

library(corrplot)
cor(tdat_wide[,-1], method="pearson")
#corrplot(cor(tdat_wide[,-1], method="pearson"), col=rev(brewer.pal(10,"RdBu")))

#test <- immune.pheno.sub %>% select(contains("Ratio"))
#test$Ratio_tCAF_vCAF <-NULL
sig <- cor.mtest(tdat_wide[,-1], conf.level = .95) #is this test right?

corrplot(cor(tdat_wide[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlation CAF Type densities",
        mar=c(0,0,3,0))
```



```{r  Correlations proportions per image CAF types,message=FALSE,warning=FALSE,echo=FALSE, fig.width=6, fig.height=6}
fibro.sce_roi$NeoAdj <- ifelse(fibro.sce_roi$Chemo==1 |fibro.sce_roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_roi[,fibro.sce_roi$DX.name!="Control"&
                                          fibro.sce_roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_roi$DX.name=="Squamous cell carcinoma"]$RoiID,
                           fibro.sce_roi[,fibro.sce_roi$DX.name!="Control"&
                                          fibro.sce_roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("RoiID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(RoiID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$RoiID <-droplevels(tdat$RoiID)

tdat_wide <- pivot_wider(tdat,id_cols=c("RoiID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")
#tdat_wide <-tdat_wide[!tdat_wide$RoiID%in% neoadj_pat$RoiID,]
rownames(tdat_wide)<-tdat_wide$RoiID

library(corrplot)
cor(tdat_wide[,-1], method="pearson")
#corrplot(cor(tdat_wide[,-1], method="pearson"), col=rev(brewer.pal(10,"RdBu")))

sig <- cor.mtest(tdat_wide[,-1], conf.level = .95) #is this test right?

corrplot(cor(tdat_wide[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlated ratios of CAF type proportions",
        mar=c(0,0,3,0))

pdf(file=file.path(plot_folder, "CAF_proportion_corrplot.pdf"), width=6, height=6)
corrplot(cor(tdat_wide[,-1], method="pearson"),
         type="lower",
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
        #col=rev(brewer.pal(8,"RdBu")),
        col=rev(COL2('RdBu', 8)),
        method="square",
         pch.col = "white",
         #type="upper",
        # title = "Correlation of CAF type proportions",
        mar=c(0,0,3,0))
dev.off()
```

```{r  Correlations proportions per patient CAF types,message=FALSE,warning=FALSE,echo=FALSE, fig.width=6, fig.height=6}
fibro.sce_pat.roi$NeoAdj <- ifelse(fibro.sce_pat.roi$Chemo==1 |fibro.sce_pat.roi$Radio==1,"NeoAdjuvantTherapy","NoNeoAdjuvantTherapy")
tdat <-as.data.frame(table(fibro.sce_pat.roi[,fibro.sce_pat.roi$DX.name!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                           fibro.sce_pat.roi[,fibro.sce_pat.roi$DX.name!="Control"&
                                          fibro.sce_pat.roi$DX.name=="Adenocarcinoma"|
                                          fibro.sce_pat.roi$DX.name=="Squamous cell carcinoma"]$cell_type))
colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")
tdat_wide <-tdat_wide[!tdat_wide$Patient_ID%in% neoadj_pat$Patient_ID,]
rownames(tdat_wide)<-tdat_wide$Patient_ID

library(corrplot)
cor(tdat_wide[,-1], method="pearson")
#corrplot(cor(tdat_wide[,-1], method="pearson"), col=rev(brewer.pal(10,"RdBu")))

sig <- cor.mtest(tdat_wide[,-1], conf.level = .95) #is this test right?

corrplot(cor(tdat_wide[,-1], method="pearson"),
         tl.cex = .7,
         number.cex = .7,
         order = "hclust",
         p.mat = sig$p,
         insig = "label_sig",
         tl.col = "black",
         addrect = 3,
         tl.srt = 90,
         sig.level = c(.001, .01, .05),
         pch.cex = .9,
         col=rev(brewer.pal(10,"RdBu")),
         pch.col = "white",
         #type="upper",
         title = "Correlated ratios of CAF type proportions per patient",
        mar=c(0,0,3,0))
```


#Differential abundance loop

#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis, fig.width=6, fig.height=4, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor
#t <-as.data.frame(table(fibro[,fibro$CAF_Type!="undefined"]$Patient_ID,factor(fibro[,fibro$CAF_Type!="undefined"]$CAF_Type)))
#  colnames(t)<-c("Patient_ID","Phenotype","n")
 # t$Phenotype <-factor(t$Phenotype)

  
colData(fibro.sce_pat[, fibro.sce_pat$DX.name=="Adenocarcinoma"| fibro.sce_pat$DX.name=="Squamous cell carcinoma"])<-as.data.frame(colData(fibro.sce_pat[, fibro.sce_pat$DX.name=="Adenocarcinoma"| fibro.sce_pat$DX.name=="Squamous cell carcinoma"])) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce_pat[, fibro.sce_pat$DX.name=="Adenocarcinoma"| fibro.sce_pat$DX.name=="Squamous cell carcinoma"]))
#if necessary: change group_id labels

#clinical.data$NR <-c(1:length(unique(clinical.data$Patient_ID)))
#dat <-merge(t,clinical.data,by="Patient_ID")
dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]
dat$LN.Met <- ifelse(dat$N ==0, "No LN Metastases", "LN Metastases")
dat$Dist.Met <- ifelse(dat$M.new ==0, "No Dist. Metastases", "Dist. Metastases")
dat$NeoAdj <- ifelse(dat$Radio==1 |dat$Chemo==1, "NeoAdjuvantTherapy", "NoNeoAdjuvantTherapy")

#Only for grade
#dat <-dat[dat$Grade=="2" | dat$Grade=="3",]
#subtype <-"Grade"
#dat<-dat %>% drop_na(Grade)



subtype <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met","Radio","DX.name")
#subtype <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met","Radio","NeoAdj")

#subtype <- "Relapse"
#group_id <-c("M.new")
#dat$group_id <-ifelse(dat$M.new ==0, 0,1)
#dat[[group_id]] <-as.factor(dat[[group_id]])

#define the naming subtype aka Phenotype

#dat<-dat %>% drop_na(paste(group_id))
j <-"cell_type"

plot_list <- list()
for (i in subtype) {
  #for(k in unique(dat$DX.name)){
  # dat.l <-subset(dat, DX.name==k)

dat.l <-dat
k="both tumour types"
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))
#colnames(test) <-c("NR", "Phenotype","group_id")

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = "cell_type", values_from ="cell_type", values_fn = list(cell_type=length),names_prefix = "")
#names(test_wide)[names(test_wide) == "FibroType_1"] <- "FibroType_1 / tCAF"
#names(test_wide)[names(test_wide) == "FibroType_2"] <- "FibroType_2 / vCAF"
test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

#y <- DGEList(t(both[,-c("patient_id","group_id")]))
y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "FibroTypes")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(FibroTypes,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  scale_fill_jco()+
  labs(x="Fibroblast Type", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)

# reference = Metastasis
##ggsave(plot=p, file=file.path(plot_folder, paste("Differential_Abundance_Analysis_Fibro_n_over_",i,".pdf")))
 # }
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save out in individual pdfs for each variable
 pdf(file=file.path(plot_folder, paste0("DA_CAF_n_over_",i,"_NOTsplit.pdf")), width=6, height=4)
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=FibroTypes))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()
```

#clean
#Differential abundance analysis loop   
```{r  Differential Abundance Analysis Types over Metastasis clean, fig.width=6, fig.height=4, warning=F, message=F,echo=F, out.width="50%"}
#Patient Number must be numeric
library(tidyr)
#groupId must be factor

colData(fibro.sce_pat)<-as.data.frame(colData(fibro.sce_pat)) %>% 
  group_by(Patient_ID) %>% mutate(NR=cur_group_id()) %>% DataFrame()
dat <-as_tibble(colData(fibro.sce_pat))
#if necessary: change group_id labels

dat <-dat[dat$DX.name=="Adenocarcinoma" | dat$DX.name=="Squamous cell carcinoma",]


subtype <-c("Gender","Relapse","Chemo","Dist.Met","LN.Met","Relapse")

#define the naming subtype aka Celltype

j <-"cell_type"

plot_list <- list()
for (i in subtype) {
  for(k in unique(dat$DX.name)){    #uncomment this if you want to split your loop e.g. by tumour type
    dat.l <-subset(dat, DX.name==k) #uncomment this if you want to split your loop e.g. by tumour type

#dat.l <-dat
#k="both tumour types" # comment this if you want to split by e.g. tumour type
dat.l$group_id <-as.factor(dat.l[[i]])
dat.l<-dat.l %>% drop_na(paste(i))

test <- dat.l %>% select(c("NR",j,"group_id"))

test_wide <- pivot_wider(test,id_cols=c("NR","group_id"),names_from = "cell_type", values_from ="cell_type", values_fn = list(cell_type=length),names_prefix = "")

test_wide
test_wide[is.na(test_wide)] <- 0

design <- createDesignMatrix(
  test_wide[,c("NR","group_id")], cols_design = c( "NR","group_id")
)

contrast <- createContrast(c(rep(0, ncol(design)-1),1))
data.frame(parameters = colnames(design), contrast)

test_wide_norm <- test_wide %>% select(-c("NR","group_id"))
#Normalize
norm_factors <- calcNormFactors(t(test_wide_norm), method = "TMM")
y <- DGEList(t(test_wide_norm), norm.factors = norm_factors)

y <- estimateDisp(y,design)

fit <- glmFit(y, design)
lrt <- glmLRT(fit, contrast = contrast)
top <- edgeR::topTags(lrt, n = Inf, adjust.method = "BH", 
        sort.by = "none")
t.op <-as.data.frame(top)
t.op <- tibble::rownames_to_column(t.op, "FibroTypes")

plot_list[[k]] <-
ggplot(t.op, aes(reorder(FibroTypes,logFC), logFC)) +
  geom_col(aes(fill=PValue<0.05)) +
  coord_flip() +
  scale_fill_tableau()+
  labs(x="Celltype", y="logFC",
       title=paste("Phenotypes over",i,k))+
  theme_bw()+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        axis.text.y = element_text(size=10))
#plot(p)


  } #uncomment this if you want to split by e.g. tumour type
  gridExtra::grid.arrange(grobs = plot_list)
  
    #save individual pdf plots for each variable
  pdf(file=file.path(plot_folder, paste0("NEW_DA_Celltype_n_over_",i,"_in_",k,".pdf")))
  gridExtra::grid.arrange(grobs = plot_list)
  dev.off()
}

t.op %>% ggplot(aes(x=logCPM, y=logFC, color=FibroTypes))+geom_point()+scale_color_tableau()
t.op %>% ggplot(aes(x=logCPM, y=logFC, color=PValue<0.05))+geom_point()+scale_color_tableau()
```

#############################################################################################################################################
#only mCAF and SMA high CAF


## Patients are ordered by hierarchical clustering (euclidian, wards.D2)
```{r  Fibro subtype proportions ordered by hierarchical clustering only mCAF SMA, message=FALSE, warning=FALSE, echo=FALSE}
tdat <-as.data.frame(table( fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$Patient_ID,
                            fibro.sce_pat[, fibro.sce_pat$Patient_ID!="Control"&
                                           fibro.sce_pat$DX.name=="Adenocarcinoma"|
                                           fibro.sce_pat$DX.name=="Squamous cell carcinoma"]$cell_type))

colnames(tdat)<-c("Patient_ID","Phenotype","n")

tdat <-tdat[tdat$Phenotype=="mCAF"|tdat$Phenotype=="SMA_CAF"|tdat$Phenotype=="iCAF",]
tdat <-tdat[tdat$Phenotype=="mCAF"|tdat$Phenotype=="SMA_CAF",]

tdat <-tdat %>%
    dplyr::group_by(Patient_ID) %>%
    dplyr::mutate(freq = n / sum(n))
tdat[is.na(tdat)] <- 0
tdat$Phenotype <-droplevels(tdat$Phenotype)
tdat$Patient_ID <-droplevels(tdat$Patient_ID)

tdat_wide <- pivot_wider(tdat,id_cols=c("Patient_ID"),names_from = "Phenotype", values_from ="freq",names_prefix = "")

tdat_m <-as.matrix(tdat_wide)
rownames(tdat_m)<-tdat_wide$Patient_ID

hc <- hclust(dist(tdat_m[,-1], method="euclidian"),"ward.D2")
tdat_wide$Patient_ID <- factor(tdat_wide$Patient_ID, levels = hc$labels[hc$order])
tdat$Patient_ID <- factor(tdat$Patient_ID, levels = hc$labels[hc$order])

tdat_wide

fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "wss", k.max=15)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "gap_stat", k.max=15)
fviz_nbclust(tdat_wide[,-1], FUN = hcut, method = "silhouette", k.max=15)

```

Patient based metaclusters split by metacluster
```{r  Barplot Fibro subtype proportions only mCAF SMA, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
#Barplot proportions ordered by
p <-ggplot(tdat,aes(x=freq, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 10")
#plot(p)
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_Tcell-subtype_over_FILTEREDpatients_ordered-hc.pdf")), width=6, height=6)

#dendrogram coloured by metacluster
ggdend <-hc%>% as.dendrogram() %>% dendextend::set("branches_k_color", k =2) %>%  as.ggdend()
p1 <-ggplot(ggdend, labels = F)+scale_x_continuous(expand = c(0, 0))+
  theme_void()+
  coord_flip()+
  scale_y_reverse()

#n
p2<-ggplot(tdat,aes(x=n, y=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 10")+theme(
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())
plt <-p1+
  p+theme(legend.position = "none", axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.y=element_blank())+
  p2

plot(plt)
##ggsave(plot=plt, file=file.path(plot_folder, paste("Barplot_n_hc_cell_type_proportions.pdf")), width=6, height=6)
```

```{r  merge hc metacluster into t_dat Fibro subtype proportions only mCAF SMA, message=FALSE, warning=FALSE, echo=FALSE, fig.width=12, fig.height=6}
clinical.data = clinical.data[!duplicated(clinical.data$Patient_ID),]

#cut dendrogram, add metacluster info to tdat
ct <-as.data.frame(cutree(hc, k= 2))

colnames(ct)<-"metacluster"
ct$metacluster <-as.factor(ct$metacluster)
ct$Patient_ID <- rownames(ct)

tdat_wide_ct <-left_join(tdat_wide, ct, by="Patient_ID")
tdat_wide_ct <- left_join(tdat_wide_ct, clinical.data, by="Patient_ID")
table(tdat_wide_ct$metacluster)

#split barlot by metacluster
tdat_ct <-merge(tdat, ct, by="Patient_ID")

p <-ggplot(tdat_ct,aes(y=freq,x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 10")+
    theme(legend.position="bottom")+
  facet_grid(~ metacluster, scales = "free", space = "free")
##ggsave(plot=p, file=file.path(plot_folder, paste("Barplot_split_metacluster_tcell-subtype_proportions.pdf")))
plot(p)

#ordered by prop
p <-ggplot(tdat_ct,aes(y=reorder(freq, desc()),x=Patient_ID, fill=Phenotype))+geom_bar(stat="identity")+scale_fill_tableau("Tableau 10")+
    theme(legend.position="bottom")+
  facet_grid(~ metacluster, scales = "free", space = "free")
plot(p)
```
```{r  heatmap metacluster cell subtype expression proportions}
tdat_ct
tdat_ct_w <-tdat_ct %>% pivot_wider(id_cols = "metacluster",names_from = "Phenotype", values_from = "freq",values_fn = mean)
tdat_ct_w_m <- as.matrix(tdat_ct_w[,-1])
rownames(tdat_ct_w_m) <-tdat_ct_w$metacluster

#pheatmap(scale(t(tdat_ct_w_m)))
library(pheatmap)
pheatmap(t(tdat_ct_w_m))
```

## **Survival analysis** - Fibro subtype
Fibro categories (CD4 and CD8) are grouped into "high" and "low" using the proportion's median as a cut-off.    
- high > median  
- low < median  
Patients who received neoadjuvant treatment are excluded from survival analysis.  
```{r  survival data Fibro subtype proportions high-low only mCAF SMA, message=FALSE, warning=FALSE, echo=FALSE}
neoadj_pat <- clinical.data %>% filter(NeoAdj == "NeoAdjuvantTherapy") %>% select(Patient_ID) 
surv_dat <-as.data.table(tdat_wide_ct)
surv_dat<- surv_dat[is.na(surv_dat$OS) !=T,]

# Censoring for OS (1 = event (death due to disease), 0 = censored)
surv_dat[,censoringOS := 0]
surv_dat[Ev.O == 1,censoringOS := 1]

# Censoring for disease free survival (1 = event (recurrence), 0 = censored)
surv_dat[ ,censoringDFS := 0]
surv_dat[ OS > DFS, censoringDFS := 1]
surv_dat$censoringDFS <-as.numeric(as.character(surv_dat$censoringDFS))

surv_dat <-surv_dat[surv_dat$DX.name=="Adenocarcinoma"|surv_dat$DX.name=="Squamous cell carcinoma",]
surv_dat <-surv_dat[!surv_dat$Patient_ID%in% neoadj_pat,]

#high low by median
surv_dat$mCAF_G <- ifelse(surv_dat$mCAF >summary(surv_dat$mCAF)[3],"mCAF high","mCAF low")
surv_dat$SMA_CAF_G <- ifelse(surv_dat$SMA_CAF >summary(surv_dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
#surv_dat$iCAF_G <- ifelse(surv_dat$iCAF >summary(surv_dat$iCAF)[3],"iCAF high","iCAF low")

caf_strat <-surv_dat %>% select(contains(c("Patient_ID","_G")))
#write.csv(caf_strat, file=file.path(wd,"patient_strat","CAF_strat_hi_low_proportion.csv"))

surv <-c("SMA_CAF_G","mCAF_G","metacluster")
#surv <-"metacluster"
```


#CoxPH for Fibro subtype proportions corrected for Stage, Grade and M
```{r  Coxph Fibro subtype proportions only mCAF SMA, echo=F, message=FALSE, warning=FALSE}
surv_dat
surv_dat<-surv_dat[!surv_dat$OS == 0, ]
time <- surv_dat$OS
status <- surv_dat$censoringOS
surv_dat$metacluster <-as.factor(surv_dat$metacluster)
surv_dat$Grade <-as.numeric(surv_dat$Grade)
rownames(surv_dat) <- surv_dat$Patient_ID
res.cox <- coxph(Surv(time, status) ~ metacluster, data = surv_dat)
res.cox


#res.cox <- coxph(Surv(time, status) ~   iCAF+mCAF+SMA_CAF+ Stage+Grade+M.new, data =  surv_dat)
res.cox <- coxph(Surv(time, status) ~   mCAF+SMA_CAF+ Stage+Grade+M.new, data =  surv_dat)

#res.cox <- coxph(Surv(time, status) ~ `CD4+`+tpCAF+iCAF+mCAF+dCAF+vCAF+`SMA+ CAF`+`IDO+ CAF`+`dividing tpCAF`+`hypoxic CAF`+Grade, data =  surv_dat)
summary(res.cox)


td_res = tidy(res.cox, exponentiate = TRUE)
td_res = td_res %>% arrange(estimate) %>% mutate(term = factor(term,levels = term))
td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.high = estimate + std.error)

td_res<-td_res %>%
  rowwise() %>%
  dplyr::mutate(conf.low = estimate - std.error)
td_res<-td_res[!td_res$std.error == 0, ]
td_res <-td_res[td_res$term !="Grade"&
                  td_res$term !="Stage"&
                  td_res$term !="M.new",]

p <-ggplot(td_res, aes(x = term, y = estimate,color =p.value < 0.05)) +
geom_point(size = 4) +
geom_errorbar(aes(ymax = conf.high, ymin = conf.low))+
scale_colour_viridis_d("p value < 0.05")+
coord_flip()+
#xlim(0,2)+
geom_hline(yintercept = 1,color = 'black')+
theme_bw()+
scale_colour_tableau()
#
plot(p)
```

## Not split by tumour type (AC and SQC together)
```{r  survival Fibro subtype proportions not split high low only mCAF SMA, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#not split by Tumour Type (AC/SQC)
for (i in surv){
  #for (k in unique(surv_dat$DX.name)){
    #dat <-surv_dat[surv_dat$DX.name==k,]
  dat <-surv_dat
  k="AC & SCC together"
 
#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
#   symbols = c("****", "***", "**", "*", "+", "."),
  #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
      
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  facet_wrap(~strata)+theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit

p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,5000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
```

## Split by tumour type (AC and SQC individually)
```{r  survival Fibro subtype proportions split high low only mCAF SMA, message=FALSE, warning=FALSE, echo=FALSE,out.width="50%", fig.height=4, fig.width=6}
#OS survival


#split by Tumour Type (AC/SQC)
for (i in surv){
  for (k in unique(surv_dat$DX.name)){
    dat <-surv_dat[surv_dat$DX.name==k,]
    dat$mCAF_G <- ifelse(dat$mCAF >summary(dat$mCAF)[3],"mCAF high","mCAF low")
dat$SMA_CAF_G <- ifelse(dat$SMA_CAF >summary(dat$SMA_CAF)[3],"SMA_CAF high","SMA_CAF low")
    #dat$iCAF_G <- ifelse(dat$iCAF >summary(dat$iCAF)[3],"iCAF high","iCAF low")

#caf_strat <-dat %>% select(contains(c("Patient_ID","_G")))
##write.csv(caf_strat, file=file.path(wd,"patient_strat",paste0("CAF_strat_hi_low_proportion_",k,".csv")))

#OS
pw<-pairwise_survdiff(Surv(OS, censoringOS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
   #abbr.colnames = FALSE, na = " "))

km_trt_fit <- survfit(Surv(OS, censoringOS) ~ dat[[i]], data=dat)      
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = F,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("OS over",i,"per",k))
 # facet_grid(.~surv_dat[[i]])
print(p)
#print(p)
p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#km_trt_fit
#print(p)

#disease free survival
pw<-pairwise_survdiff(Surv(DFS, censoringDFS) ~ metacluster,data = surv_dat)
#print(pw)
#print(symnum(pw$p.value, cutpoints = c(0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1),
 #  symbols = c("****", "***", "**", "*", "+", "."),
 #  abbr.colnames = FALSE, na = " "))
km_trt_fit <- survfit(Surv(DFS, censoringDFS) ~ dat[[i]], data=dat)   
km_trt_fit
p <-ggsurvplot(km_trt_fit,
               data=dat,
               conf.int = T,
               pval = T,
               #conf.int.style = "step",
               surv.median.line = "hv",
               xlim=c(0,2000))+ # Specify median survival,
               #legend.title = paste(i),
               #legend.labs=c("Grade 1","Grade 2","Grade 3"),
               #legend.labs=c(paste(i,sort(unique(surv_dat[[i]][!is.na(surv_dat[[i]])])))))+
  labs(title=paste("DFS over",i,"per",k))#+
 # facet_grid(.~surv_dat[[i]])
print(p)

p <-p$plot+
  theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #facet_wrap(~strata)+
  theme(axis.text.x = element_text(angle=45, hjust=1), axis.ticks.x = element_blank())
#print(p)
#km_trt_fit
  }
}
```

